<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0e1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>QQQ Pro Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='64' height='64'%3e%3crect width='64' height='64' rx='12' fill='%23111'/%3e%3cpath d='M12 44L24 32L36 40L52 24' stroke='%2300d4ff' stroke-width='4' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3e%3ccircle cx='52' cy='24' r='4' fill='%2300d4ff'/%3e%3c/svg%3e" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='180' height='180'%3e%3crect width='64' height='64' rx='12' fill='%23111'/%3e%3cpath d='M12 44L24 32L36 40L52 24' stroke='%2300d4ff' stroke-width='4' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3e%3ccircle cx='52' cy='24' r='4' fill='%2300d4ff'/%3e%3c/svg%3e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0e1a;
            --bg-card: rgba(15, 20, 40, 0.6);
            --border-card: rgba(255, 255, 255, 0.08);
            --border-glow: rgba(0, 212, 255, 0.3);
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.25);
            --green: #00e68a;
            --red: #ff4d6a;
            --yellow: #ffb740;
            --orange: #ff8c42;
            --text-primary: #f0f2f5;
            --text-secondary: rgba(255, 255, 255, 0.55);
            --text-muted: rgba(255, 255, 255, 0.35);
            --radius: 16px;
            --radius-sm: 10px;
            --blur: 20px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            transition: background 2s ease;
        }

        /* ====== Dynamic mood backgrounds (5 moods) ====== */
        /* ::before = color layer,  ::after = pattern/illustration layer */
        body::before, body::after {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            transition: opacity 2s ease, background 2s ease;
        }
        body::after { z-index: 0; opacity: 0.35; }

        /* ===== 1. EUPHORIA - strong bull (vivid green aurora + rising arrows) ===== */
        body.mood-euphoria { background: linear-gradient(160deg, #021a0a 0%, #0a1e1a 40%, #041510 100%); }
        body.mood-euphoria::before {
            background:
                radial-gradient(ellipse 90% 70% at 20% 30%, rgba(0, 230, 130, 0.5) 0%, transparent 55%),
                radial-gradient(ellipse 70% 60% at 75% 65%, rgba(0, 200, 200, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse 40% 35% at 50% 80%, rgba(0, 255, 180, 0.2) 0%, transparent 45%);
            animation: euphoriaDrift 8s ease-in-out infinite alternate;
        }
        body.mood-euphoria::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cpath d='M60 90 L60 30 M60 30 L45 50 M60 30 L75 50' stroke='%2300e68a' stroke-width='2.5' fill='none' opacity='0.25' stroke-linecap='round'/%3E%3Ccircle cx='60' cy='25' r='3' fill='%2300e68a' opacity='0.2'/%3E%3C/svg%3E");
            background-size: 120px 120px;
            animation: patternRise 15s linear infinite;
        }
        @keyframes euphoriaDrift {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-15px) scale(1.03); }
        }
        @keyframes patternRise {
            0% { background-position: 0 0; }
            100% { background-position: 60px -120px; }
        }

        /* ===== 2. CALM - stable (deep blue + gentle wave pattern) ===== */
        body.mood-calm { background: linear-gradient(160deg, #050a18 0%, #0a0e1a 40%, #06091a 100%); }
        body.mood-calm::before {
            background:
                radial-gradient(ellipse 85% 65% at 15% 25%, rgba(0, 80, 180, 0.4) 0%, transparent 55%),
                radial-gradient(ellipse 65% 55% at 80% 70%, rgba(40, 0, 120, 0.35) 0%, transparent 50%),
                radial-gradient(ellipse 45% 40% at 55% 45%, rgba(0, 140, 200, 0.15) 0%, transparent 45%);
            animation: calmBreath 10s ease-in-out infinite alternate;
        }
        body.mood-calm::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='100' viewBox='0 0 200 100'%3E%3Cpath d='M0 50 Q25 30 50 50 T100 50 T150 50 T200 50' stroke='%230088cc' stroke-width='1.5' fill='none' opacity='0.15'/%3E%3Cpath d='M0 65 Q25 45 50 65 T100 65 T150 65 T200 65' stroke='%234466aa' stroke-width='1' fill='none' opacity='0.1'/%3E%3C/svg%3E");
            background-size: 200px 100px;
            animation: waveScroll 20s linear infinite;
        }
        @keyframes calmBreath {
            0% { opacity: 0.9; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.02); }
        }
        @keyframes waveScroll {
            0% { background-position: 0 0; }
            100% { background-position: 200px 0; }
        }

        /* ===== 3. CAUTIOUS - elevated volatility (purple/violet + zigzag) ===== */
        body.mood-cautious { background: linear-gradient(160deg, #0e0520 0%, #120a22 40%, #0a0418 100%); }
        body.mood-cautious::before {
            background:
                radial-gradient(ellipse 85% 65% at 15% 30%, rgba(80, 40, 180, 0.5) 0%, transparent 55%),
                radial-gradient(ellipse 65% 55% at 80% 65%, rgba(120, 0, 180, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse 50% 40% at 50% 50%, rgba(160, 80, 240, 0.2) 0%, transparent 45%);
            animation: cautiousShift 6s ease-in-out infinite alternate;
        }
        body.mood-cautious::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath d='M10 70 L30 30 L50 60 L70 20 L90 55' stroke='%239955ff' stroke-width='2' fill='none' opacity='0.2' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='70' cy='20' r='2.5' fill='%239955ff' opacity='0.15'/%3E%3C/svg%3E");
            background-size: 100px 100px;
            animation: patternJitter 12s linear infinite;
        }
        @keyframes cautiousShift {
            0% { transform: translateX(0); }
            100% { transform: translateX(8px); }
        }
        @keyframes patternJitter {
            0% { background-position: 0 0; }
            50% { background-position: 15px -10px; }
            100% { background-position: 0 0; }
        }

        /* ===== 4. FEAR - high volatility (orange/amber + lightning bolts) ===== */
        body.mood-fear { background: linear-gradient(160deg, #1a0e00 0%, #1a1005 40%, #180a00 100%); }
        body.mood-fear::before {
            background:
                radial-gradient(ellipse 85% 65% at 20% 25%, rgba(200, 120, 0, 0.55) 0%, transparent 55%),
                radial-gradient(ellipse 65% 55% at 75% 70%, rgba(180, 60, 0, 0.45) 0%, transparent 50%),
                radial-gradient(ellipse 50% 40% at 50% 50%, rgba(255, 160, 0, 0.2) 0%, transparent 45%);
            animation: fearFlicker 4s ease-in-out infinite alternate;
        }
        body.mood-fear::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='120' viewBox='0 0 80 120'%3E%3Cpath d='M45 10 L30 55 L45 50 L32 100' stroke='%23ffaa00' stroke-width='2.5' fill='none' opacity='0.2' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M55 25 L48 52 L55 49 L50 75' stroke='%23ff8800' stroke-width='1.5' fill='none' opacity='0.12' stroke-linecap='round'/%3E%3C/svg%3E");
            background-size: 80px 120px;
            animation: fearBolts 5s ease-in-out infinite;
        }
        @keyframes fearFlicker {
            0% { opacity: 0.85; }
            30% { opacity: 1; }
            60% { opacity: 0.75; }
            100% { opacity: 0.95; }
        }
        @keyframes fearBolts {
            0%, 100% { opacity: 0.35; }
            15% { opacity: 0.6; }
            20% { opacity: 0.2; }
            50% { opacity: 0.4; }
            70% { opacity: 0.55; }
            75% { opacity: 0.15; }
        }

        /* ===== 5. PANIC - crash (deep red + cracking/shatter + pulse) ===== */
        body.mood-panic { background: linear-gradient(160deg, #1a0005 0%, #200008 40%, #180005 100%); }
        body.mood-panic::before {
            background:
                radial-gradient(ellipse 90% 70% at 15% 25%, rgba(200, 0, 40, 0.6) 0%, transparent 55%),
                radial-gradient(ellipse 70% 60% at 80% 70%, rgba(150, 0, 0, 0.5) 0%, transparent 50%),
                radial-gradient(ellipse 50% 40% at 50% 50%, rgba(255, 30, 80, 0.25) 0%, transparent 45%);
            animation: panicPulse 2.5s ease-in-out infinite;
        }
        body.mood-panic::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'%3E%3Cpath d='M75 15 L65 75 L45 70 L75 135 L85 75 L105 80 Z' stroke='%23ff1a40' stroke-width='1.5' fill='none' opacity='0.15'/%3E%3Cpath d='M30 50 L55 55 M95 45 L120 40' stroke='%23ff0033' stroke-width='1' opacity='0.12' stroke-linecap='round'/%3E%3Cpath d='M20 100 L50 90 M100 95 L130 105' stroke='%23cc0022' stroke-width='1' opacity='0.1' stroke-linecap='round'/%3E%3Ccircle cx='75' cy='75' r='35' stroke='%23ff1a40' stroke-width='0.8' fill='none' opacity='0.08'/%3E%3Ccircle cx='75' cy='75' r='55' stroke='%23ff0033' stroke-width='0.5' fill='none' opacity='0.05'/%3E%3C/svg%3E");
            background-size: 150px 150px;
            animation: panicShatter 1.5s ease-in-out infinite;
        }
        @keyframes panicPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        @keyframes panicShatter {
            0%, 100% { opacity: 0.35; transform: scale(1); }
            25% { opacity: 0.55; transform: scale(1.01); }
            50% { opacity: 0.25; transform: scale(0.99); }
            75% { opacity: 0.5; transform: scale(1.005); }
        }

        /* Mood indicator label */
        .mood-label {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .mood-label-euphoria { background: rgba(0,230,138,0.25); color: #00ff99; border: 1px solid rgba(0,230,138,0.3); }
        .mood-label-calm { background: rgba(0,120,255,0.2); color: #66bbff; border: 1px solid rgba(0,120,255,0.25); }
        .mood-label-cautious { background: rgba(160,80,255,0.25); color: #cc88ff; border: 1px solid rgba(160,80,255,0.3); }
        .mood-label-fear { background: rgba(255,160,0,0.25); color: #ffbb33; border: 1px solid rgba(255,160,0,0.3); }
        .mood-label-panic { background: rgba(255,30,60,0.3); color: #ff4466; border: 1px solid rgba(255,30,60,0.35); animation: panicLabelPulse 1.5s ease-in-out infinite; }
        @keyframes panicLabelPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* ====== Skeleton loading ====== */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 6px;
        }
        .skeleton-text { height: 20px; width: 80px; display: inline-block; vertical-align: middle; }
        .skeleton-lg { height: 48px; width: 160px; display: inline-block; vertical-align: middle; }

        /* ====== Toast notifications ====== */
        .toast-container {
            position: fixed; top: 80px; right: 20px; z-index: 2000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            pointer-events: auto; padding: 14px 20px; border-radius: var(--radius-sm);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--border-card); font-size: 14px; font-weight: 500;
            display: flex; align-items: center; gap: 10px;
            min-width: 300px; max-width: 420px;
            transform: translateX(120%); opacity: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast-error { background: rgba(255, 77, 106, 0.15); border-color: rgba(255, 77, 106, 0.3); color: var(--red); }
        .toast-warning { background: rgba(255, 183, 64, 0.15); border-color: rgba(255, 183, 64, 0.3); color: var(--yellow); }
        .toast-success { background: rgba(0, 230, 138, 0.15); border-color: rgba(0, 230, 138, 0.3); color: var(--green); }
        .toast-info { background: rgba(0, 212, 255, 0.15); border-color: rgba(0, 212, 255, 0.3); color: var(--accent); }

        /* Demo banner */
        .demo-banner {
            display: none; background: linear-gradient(90deg, rgba(255,183,64,0.12), rgba(255,140,66,0.12));
            border-bottom: 1px solid rgba(255,183,64,0.2); padding: 8px 20px;
            text-align: center; font-size: 13px; font-weight: 500; color: var(--yellow);
            position: relative; z-index: 10;
        }
        .demo-banner.show { display: block; }

        /* ====== Header ====== */
        .header {
            background: rgba(10, 14, 26, 0.85);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            padding: 14px 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-card); position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .header h1 {
            font-size: 18px; font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #6366f1);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .last-updated { font-size: 12px; color: var(--text-muted); font-weight: 400; }

        .header-right { display: flex; align-items: center; gap: 10px; }
        .settings-btn {
            background: rgba(255,255,255,0.06); border: 1px solid var(--border-card);
            color: var(--text-secondary); padding: 8px 16px; border-radius: 24px;
            font-size: 13px; font-family: inherit; cursor: pointer; transition: all 0.3s;
        }
        .settings-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--border-glow); color: var(--accent); }

        /* ====== Main content ====== */
        .main-content { position: relative; z-index: 1; padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* Market status */
        .market-status {
            text-align: center; padding: 10px 16px; background: var(--bg-card);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--border-card); border-radius: var(--radius-sm);
            margin-bottom: 20px; font-size: 13px; color: var(--text-secondary);
        }
        .market-open { color: var(--green) !important; }
        .market-closed { color: var(--red) !important; }

        /* Glass card */
        .glass-card {
            background: var(--bg-card); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--border-card); border-radius: var(--radius);
            padding: 24px; margin-bottom: 20px; transition: border-color 0.3s, box-shadow 0.3s;
        }
        .glass-card:hover { border-color: rgba(255,255,255,0.12); }

        /* ====== Signal Scoreboard ====== */
        .scoreboard {
            display: flex; align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 16px;
        }
        .score-ring-wrap { display: flex; align-items: center; gap: 16px; }
        .score-ring {
            position: relative; width: 80px; height: 80px;
        }
        .score-ring svg { transform: rotate(-90deg); }
        .score-ring-bg { fill: none; stroke: rgba(255,255,255,0.06); stroke-width: 6; }
        .score-ring-fill { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease, stroke 0.5s; }
        .score-number {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            font-size: 22px; font-weight: 800;
        }
        .score-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .score-desc { font-size: 15px; font-weight: 600; margin-top: 2px; }

        .signal-pills { display: flex; flex-wrap: wrap; gap: 8px; }
        .signal-pill {
            font-size: 12px; font-weight: 600; padding: 5px 12px;
            border-radius: 14px; border: 1px solid; white-space: nowrap;
        }
        .signal-on { background: rgba(0,230,138,0.12); border-color: rgba(0,230,138,0.3); color: var(--green); }
        .signal-off { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.06); color: var(--text-muted); }

        /* ====== Price section ====== */
        .price-main { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        .current-price { font-size: 48px; font-weight: 800; letter-spacing: -1px; color: var(--text-primary); line-height: 1; }
        .price-change { text-align: right; }
        .change-amount { font-size: 22px; font-weight: 600; margin-bottom: 4px; }
        .change-percent { font-size: 16px; font-weight: 500; }
        .positive { color: var(--green); }
        .negative { color: var(--red); }

        .price-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .detail-item {
            background: rgba(255,255,255,0.03); padding: 12px 14px;
            border-radius: var(--radius-sm); border: 1px solid rgba(255,255,255,0.05);
        }
        .detail-label {
            font-size: 11px; color: var(--text-muted); margin-bottom: 4px;
            text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;
        }
        .detail-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }

        .section-title {
            font-size: 15px; font-weight: 600; margin-bottom: 16px;
            color: var(--text-secondary); display: flex; align-items: center; gap: 8px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* ====== Indicators ====== */
        .indicator-grid { display: grid; gap: 12px; }
        .indicator-item {
            background: rgba(255,255,255,0.03); padding: 14px 16px; border-radius: var(--radius-sm);
            border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between;
            align-items: center; position: relative; overflow: hidden;
        }
        .indicator-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
        .ma-200::before { background: linear-gradient(180deg, var(--yellow), var(--orange)); }
        .ma-dev::before { background: linear-gradient(180deg, #a78bfa, #6366f1); }
        .level-12::before { background: linear-gradient(180deg, var(--orange), var(--red)); }
        .level-18::before { background: linear-gradient(180deg, var(--red), #cc0033); }
        .week-open::before { background: linear-gradient(180deg, var(--accent), #6366f1); }
        .rule-5::before { background: linear-gradient(180deg, #6366f1, #a855f7); }

        .indicator-label { font-size: 13px; color: var(--text-secondary); }
        .indicator-value { font-size: 18px; font-weight: 600; }

        /* ====== VIX / Futures / USD-JPY ====== */
        .vix-container, .futures-container, .fx-container {
            background: rgba(255,255,255,0.03); padding: 16px; border-radius: var(--radius-sm);
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 12px;
        }
        .vix-container:last-child, .futures-container:last-child, .fx-container:last-child { margin-bottom: 0; }

        .vix-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .vix-value-num { font-size: 32px; font-weight: 700; line-height: 1; }
        .vix-change { font-size: 14px; font-weight: 500; }

        .vix-gauge { height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; margin: 12px 0 8px; }
        .vix-gauge-fill { height: 100%; border-radius: 3px; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1), background 0.5s; }
        .vix-gauge-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); }

        .vix-status { font-size: 12px; padding: 4px 12px; border-radius: 16px; font-weight: 600; display: inline-block; }
        .vix-low { background: rgba(0,230,138,0.15); color: var(--green); }
        .vix-medium { background: rgba(255,183,64,0.15); color: var(--yellow); }
        .vix-high { background: rgba(255,77,106,0.15); color: var(--red); }

        .futures-row, .fx-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .futures-price, .fx-price { font-size: 24px; font-weight: 600; }
        .futures-change, .fx-change { font-size: 16px; font-weight: 500; }

        /* ====== Chart ====== */
        .chart-container { height: 300px; }
        .time-selector { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .time-btn {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-secondary); padding: 7px 14px; border-radius: 20px;
            font-size: 13px; font-family: inherit; cursor: pointer; transition: all 0.25s;
        }
        .time-btn:hover { background: rgba(255,255,255,0.08); border-color: var(--border-glow); }
        .time-btn.active {
            background: var(--accent); color: #000; border-color: var(--accent);
            font-weight: 600; box-shadow: 0 0 16px var(--accent-glow);
        }

        /* ====== Settings modal ====== */
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: rgba(15, 20, 40, 0.95); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--border-card); border-radius: var(--radius);
            padding: 28px; max-width: 440px; width: 90%; max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { font-size: 20px; font-weight: 700; color: var(--text-primary); }
        .close-btn {
            background: rgba(255,255,255,0.06); border: none; color: var(--text-secondary);
            width: 32px; height: 32px; border-radius: 50%; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .close-btn:hover { background: rgba(255,255,255,0.12); color: var(--text-primary); }

        .setting-group-title {
            font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 1px; margin: 20px 0 12px; padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .setting-group-title:first-of-type { margin-top: 0; }

        .setting-item { margin-bottom: 20px; }
        .setting-label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px; font-weight: 500; }
        .setting-control { display: flex; align-items: center; gap: 14px; }
        .setting-value { font-size: 15px; font-weight: 600; color: var(--accent); min-width: 50px; }

        input[type="range"] {
            flex: 1; -webkit-appearance: none; height: 4px;
            background: rgba(255,255,255,0.1); border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px;
            background: var(--accent); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        input[type="number"] {
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary); padding: 6px 10px; border-radius: 8px;
            font-family: inherit; font-size: 14px; font-weight: 600; width: 64px;
            text-align: center; outline: none;
        }
        input[type="number"]:focus { border-color: var(--accent); }
        input[type="number"]::-webkit-inner-spin-button { opacity: 1; }

        .toggle { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; inset: 0; background: rgba(255,255,255,0.1);
            border-radius: 12px; cursor: pointer; transition: background 0.3s;
        }
        .toggle-slider::before {
            content: ''; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px;
            background: #fff; border-radius: 50%; transition: transform 0.3s;
        }
        .toggle input:checked + .toggle-slider { background: var(--accent); }
        .toggle input:checked + .toggle-slider::before { transform: translateX(20px); }

        /* Debug panel */
        .debug-panel {
            display: none; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-card); border-radius: var(--radius-sm);
            padding: 14px; margin: 0 20px 20px; font-family: 'SF Mono', Menlo, monospace;
            font-size: 11px; color: var(--green); max-height: 250px; overflow-y: auto;
            position: relative; z-index: 1;
        }

        /* ====== Responsive ====== */
        @media (min-width: 768px) {
            .price-details { grid-template-columns: repeat(4, 1fr); }
            .main-content { padding: 24px 32px; }
            .market-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (min-width: 1024px) {
            .main-content { padding: 28px 40px; }
            .indicator-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .current-price { font-size: 38px; }
            .change-amount { font-size: 18px; }
            .change-percent { font-size: 14px; }
            .glass-card { padding: 18px; }
            .main-content { padding: 14px; }
            .toast { min-width: 260px; max-width: calc(100vw - 40px); }
            .score-ring { width: 64px; height: 64px; }
            .score-number { font-size: 18px; }
            .scoreboard { gap: 12px; }
        }
    </style>
</head>
<body class="mood-calm">
    <div class="toast-container" id="toastContainer"></div>
    <div class="demo-banner" id="demoBanner">Demo Mode - displaying sample data</div>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>QQQ Pro Tracker</h1>
            <span class="last-updated" id="lastUpdated"></span>
            <span class="mood-label mood-label-calm" id="moodLabel">CALM</span>
        </div>
        <div class="header-right">
            <button class="settings-btn" onclick="app.openSettings()">Settings</button>
        </div>
    </div>

    <div class="main-content">
        <div class="market-status" id="marketStatus">Checking market status...</div>

        <!-- ====== Signal Scoreboard ====== -->
        <div class="glass-card">
            <h2 class="section-title">Buy Signal Scoreboard</h2>
            <div class="scoreboard">
                <div class="score-ring-wrap">
                    <div class="score-ring">
                        <svg viewBox="0 0 80 80" width="80" height="80">
                            <circle class="score-ring-bg" cx="40" cy="40" r="34"/>
                            <circle class="score-ring-fill" id="scoreRing" cx="40" cy="40" r="34"
                                stroke-dasharray="213.6" stroke-dashoffset="213.6"/>
                        </svg>
                        <div class="score-number" id="scoreNumber">0/6</div>
                    </div>
                    <div>
                        <div class="score-label">Signal Strength</div>
                        <div class="score-desc" id="scoreDesc">Waiting...</div>
                    </div>
                </div>
                <div class="signal-pills" id="signalPills"></div>
            </div>
        </div>

        <!-- Price section -->
        <div class="glass-card">
            <div class="price-main">
                <div class="current-price" id="currentPrice"><span class="skeleton skeleton-lg"></span></div>
                <div class="price-change">
                    <div class="change-amount" id="changeAmount"><span class="skeleton skeleton-text"></span></div>
                    <div class="change-percent" id="changePercent"><span class="skeleton skeleton-text" style="width:60px"></span></div>
                </div>
            </div>
            <div class="price-details">
                <div class="detail-item"><div class="detail-label">Prev Close</div><div class="detail-value" id="prevClose"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">Volume</div><div class="detail-value" id="volume"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">Day High</div><div class="detail-value" id="dayHigh"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">Day Low</div><div class="detail-value" id="dayLow"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">52W High</div><div class="detail-value" id="week52High"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">52W Low</div><div class="detail-value" id="week52Low"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">5Y High</div><div class="detail-value" id="year5High"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">5Y Diff</div><div class="detail-value" id="year5Diff"><span class="skeleton skeleton-text"></span></div></div>
            </div>
        </div>

        <!-- Indicators -->
        <div class="glass-card">
            <h2 class="section-title">Investment Indicators</h2>
            <div class="indicator-grid">
                <div class="indicator-item ma-200"><span class="indicator-label">200-Day MA</span><span class="indicator-value" id="ma200"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item ma-dev"><span class="indicator-label">200MA Deviation</span><span class="indicator-value" id="maDev"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item level-12"><span class="indicator-label" id="level12Label">-12% Level</span><span class="indicator-value" id="level12"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item level-18"><span class="indicator-label" id="level18Label">-18% Level</span><span class="indicator-value" id="level18"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item week-open"><span class="indicator-label">Week Open</span><span class="indicator-value" id="weekOpen"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item rule-5"><span class="indicator-label" id="rule5Label">-5% Rule</span><span class="indicator-value" id="rule5"><span class="skeleton skeleton-text"></span></span></div>
            </div>
        </div>

        <!-- Market indicators -->
        <div class="glass-card">
            <h2 class="section-title">Market Indicators</h2>
            <div class="vix-container">
                <div class="detail-label">VIX (Fear Index)</div>
                <div class="vix-header">
                    <div>
                        <div class="vix-value-num" id="vixValue"><span class="skeleton skeleton-text" style="width:60px;height:32px"></span></div>
                        <div class="vix-change" id="vixChange"></div>
                    </div>
                    <span class="vix-status" id="vixStatus"></span>
                </div>
                <div class="vix-gauge"><div class="vix-gauge-fill" id="vixGauge" style="width:0%"></div></div>
                <div class="vix-gauge-labels"><span>0</span><span>20</span><span>30</span><span>40+</span></div>
            </div>
            <div class="futures-container">
                <div class="detail-label">NQ Futures</div>
                <div class="futures-row">
                    <span class="futures-price" id="futuresPrice"><span class="skeleton skeleton-text" style="width:100px;height:24px"></span></span>
                    <span class="futures-change" id="futuresChange"></span>
                </div>
            </div>
            <div class="fx-container">
                <div class="detail-label">USD/JPY</div>
                <div class="fx-row">
                    <span class="fx-price" id="fxPrice"><span class="skeleton skeleton-text" style="width:80px;height:24px"></span></span>
                    <span class="fx-change" id="fxChange"></span>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="glass-card">
            <h2 class="section-title">Price Chart</h2>
            <div class="time-selector" id="timeSelector">
                <button class="time-btn active" data-period="1d">1D</button>
                <button class="time-btn" data-period="5d">5D</button>
                <button class="time-btn" data-period="1mo">1M</button>
                <button class="time-btn" data-period="3mo">3M</button>
                <button class="time-btn" data-period="6mo">6M</button>
                <button class="time-btn" data-period="1y">1Y</button>
            </div>
            <div class="chart-container" id="chartContainer"><canvas id="priceChart"></canvas></div>
        </div>
    </div>

    <div class="debug-panel" id="debugPanel"></div>

    <!-- Settings modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="app.closeSettings()">&times;</button>
            </div>

            <div class="setting-group-title">General</div>
            <div class="setting-item">
                <label class="setting-label">Refresh Interval</label>
                <div class="setting-control">
                    <input type="range" id="refreshInterval" min="5" max="60" value="15" step="5">
                    <span class="setting-value" id="refreshValue">15s</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Sound Alerts</label>
                <div class="setting-control">
                    <label class="toggle"><input type="checkbox" id="soundEnabled" checked><span class="toggle-slider"></span></label>
                    <span style="color:var(--text-secondary);font-size:13px" id="soundLabel">Enabled</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Browser Notifications</label>
                <div class="setting-control">
                    <label class="toggle"><input type="checkbox" id="notificationEnabled"><span class="toggle-slider"></span></label>
                    <span style="color:var(--text-secondary);font-size:13px" id="notifLabel">Disabled</span>
                </div>
            </div>

            <div class="setting-group-title">Alert Thresholds</div>
            <div class="setting-item">
                <label class="setting-label">Drop Level 1 (%)</label>
                <div class="setting-control">
                    <input type="number" id="thresholdLevel1" value="12" min="1" max="50" step="1">
                    <span style="color:var(--text-muted);font-size:13px">Default: 12%</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Drop Level 2 (%)</label>
                <div class="setting-control">
                    <input type="number" id="thresholdLevel2" value="18" min="1" max="50" step="1">
                    <span style="color:var(--text-muted);font-size:13px">Default: 18%</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Weekly Drop Rule (%)</label>
                <div class="setting-control">
                    <input type="number" id="thresholdWeekly" value="5" min="1" max="30" step="0.5">
                    <span style="color:var(--text-muted);font-size:13px">Default: 5%</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">VIX High Threshold</label>
                <div class="setting-control">
                    <input type="number" id="thresholdVixHigh" value="30" min="15" max="80" step="1">
                    <span style="color:var(--text-muted);font-size:13px">Default: 30</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">VIX Extreme Threshold</label>
                <div class="setting-control">
                    <input type="number" id="thresholdVixExtreme" value="35" min="20" max="90" step="1">
                    <span style="color:var(--text-muted);font-size:13px">Default: 35</span>
                </div>
            </div>

            <div class="setting-group-title">Advanced</div>
            <div class="setting-item">
                <label class="setting-label">Debug Mode</label>
                <div class="setting-control">
                    <label class="toggle"><input type="checkbox" id="debugMode"><span class="toggle-slider"></span></label>
                    <span style="color:var(--text-secondary);font-size:13px" id="debugLabel">Off</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Demo Mode</label>
                <div class="setting-control">
                    <label class="toggle"><input type="checkbox" id="demoMode"><span class="toggle-slider"></span></label>
                    <span style="color:var(--text-secondary);font-size:13px" id="demoLabel">Auto-fallback on API error</span>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ======== CacheManager ========
    const CacheManager = {
        get(key) {
            try {
                const raw = localStorage.getItem(`qqq_${key}`);
                if (!raw) return null;
                const { data, expiry } = JSON.parse(raw);
                if (Date.now() > expiry) { localStorage.removeItem(`qqq_${key}`); return null; }
                return data;
            } catch { return null; }
        },
        set(key, data, ttlMs) {
            try { localStorage.setItem(`qqq_${key}`, JSON.stringify({ data, expiry: Date.now() + ttlMs })); } catch {}
        }
    };

    // ======== ToastManager ========
    const ToastManager = {
        container: null,
        init() { this.container = document.getElementById('toastContainer'); },
        show(msg, type = 'info', dur = 5000) {
            const t = document.createElement('div');
            t.className = `toast toast-${type}`;
            t.textContent = msg;
            this.container.appendChild(t);
            requestAnimationFrame(() => requestAnimationFrame(() => t.classList.add('show')));
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, dur);
        }
    };

    // ======== NumberAnimator ========
    const NumberAnimator = {
        animate(el, target, prefix = '$', dec = 2, dur = 600) {
            const cur = parseFloat(el.textContent.replace(/[^0-9.-]/g, '')) || 0;
            if (Math.abs(cur - target) < 0.001) { el.textContent = prefix + target.toFixed(dec); return; }
            const t0 = performance.now();
            const step = (now) => {
                const p = Math.min((now - t0) / dur, 1);
                const e = 1 - Math.pow(1 - p, 3);
                el.textContent = prefix + (cur + (target - cur) * e).toFixed(dec);
                if (p < 1) requestAnimationFrame(step);
            };
            requestAnimationFrame(step);
        }
    };

    // ======== DOMCache ========
    const DOMCache = {};
    function $(id) { if (!DOMCache[id]) DOMCache[id] = document.getElementById(id); return DOMCache[id]; }

    // ======== Main App ========
    const app = {
        settings: {
            refreshInterval: 15, soundEnabled: true, notificationEnabled: false,
            debugMode: false, demoMode: false,
            thresholdLevel1: 12, thresholdLevel2: 18, thresholdWeekly: 5,
            thresholdVixHigh: 30, thresholdVixExtreme: 35
        },

        data: {
            currentPrice: null, previousClose: null,
            dayHigh: null, dayLow: null,
            week52High: null, week52Low: null,
            volume: null, ma200: null, weekOpen: null,
            vix: null, nqFutures: null, year5High: null,
            usdjpy: null
        },

        alertsTriggered: { level12: false, level18: false, ma200: false, rule5: false, vix30: false, vix35: false },
        currentMood: 'calm',
        chart: null, chartPeriod: '1d', refreshTimer: null,

        // Detect if running on Vercel (or any http server) vs local file
        isHosted: location.protocol === 'https:' || (location.protocol === 'http:' && location.hostname !== ''),
        corsProxies: [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://thingproxy.freeboard.io/fetch/'
        ],
        currentProxyIndex: 0,

        init() {
            this.log('QQQ Pro Tracker initializing');
            this.loadSettings();
            ToastManager.init();
            this.setupEventListeners();
            if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
            this.fetchData();
            this.startAutoRefresh();
            this.initChart();
            this.fetchChartData();
            this.updateMarketStatus();
            // PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            }
            this.log('Initialization complete');
        },

        // ---- Settings persistence ----
        loadSettings() {
            try {
                const saved = localStorage.getItem('qqq_settings');
                if (saved) Object.assign(this.settings, JSON.parse(saved));
            } catch {}
            // Apply to DOM
            $('refreshInterval').value = this.settings.refreshInterval;
            $('refreshValue').textContent = `${this.settings.refreshInterval}s`;
            $('soundEnabled').checked = this.settings.soundEnabled;
            $('notificationEnabled').checked = this.settings.notificationEnabled;
            $('debugMode').checked = this.settings.debugMode;
            $('demoMode').checked = this.settings.demoMode;
            $('thresholdLevel1').value = this.settings.thresholdLevel1;
            $('thresholdLevel2').value = this.settings.thresholdLevel2;
            $('thresholdWeekly').value = this.settings.thresholdWeekly;
            $('thresholdVixHigh').value = this.settings.thresholdVixHigh;
            $('thresholdVixExtreme').value = this.settings.thresholdVixExtreme;
            if (this.settings.debugMode) $('debugPanel').style.display = 'block';
            if (this.settings.demoMode) $('demoBanner').classList.add('show');
            this.updateThresholdLabels();
        },

        saveSettings() {
            try { localStorage.setItem('qqq_settings', JSON.stringify(this.settings)); } catch {}
        },

        updateThresholdLabels() {
            $('level12Label').textContent = `-${this.settings.thresholdLevel1}% Level`;
            $('level18Label').textContent = `-${this.settings.thresholdLevel2}% Level`;
            $('rule5Label').textContent = `-${this.settings.thresholdWeekly}% Rule`;
        },

        // ---- Events ----
        setupEventListeners() {
            $('refreshInterval').addEventListener('input', (e) => {
                this.settings.refreshInterval = parseInt(e.target.value);
                $('refreshValue').textContent = `${e.target.value}s`;
                this.startAutoRefresh(); this.saveSettings();
            });

            const toggleHandler = (id, key, labelId) => {
                $(id).addEventListener('change', (e) => {
                    this.settings[key] = e.target.checked;
                    if (labelId) $(labelId).textContent = e.target.checked ? 'Enabled' : 'Disabled';
                    this.saveSettings();
                });
            };
            toggleHandler('soundEnabled', 'soundEnabled', 'soundLabel');
            toggleHandler('notificationEnabled', 'notificationEnabled', 'notifLabel');

            $('notificationEnabled').addEventListener('change', (e) => {
                if (e.target.checked && Notification.permission === 'default') Notification.requestPermission();
            });

            $('debugMode').addEventListener('change', (e) => {
                this.settings.debugMode = e.target.checked;
                $('debugPanel').style.display = e.target.checked ? 'block' : 'none';
                $('debugLabel').textContent = e.target.checked ? 'On' : 'Off';
                this.saveSettings();
            });

            $('demoMode').addEventListener('change', (e) => {
                this.settings.demoMode = e.target.checked;
                $('demoBanner').classList.toggle('show', e.target.checked);
                $('demoLabel').textContent = e.target.checked ? 'Active' : 'Auto-fallback on API error';
                if (e.target.checked) this.useDemoData(); else this.fetchData();
                this.saveSettings();
            });

            // Threshold inputs
            ['thresholdLevel1','thresholdLevel2','thresholdWeekly','thresholdVixHigh','thresholdVixExtreme'].forEach(id => {
                $(id).addEventListener('change', (e) => {
                    this.settings[id] = parseFloat(e.target.value);
                    this.updateThresholdLabels();
                    this.saveSettings();
                    if (this.data.currentPrice) { this.updateUI(); this.checkAlerts(); this.updateScoreboard(); }
                });
            });

            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.chartPeriod = e.target.dataset.period;
                    this.fetchChartData();
                });
            });
        },

        // ---- Parallel data fetch ----
        async fetchData() {
            this.log('Fetching data (parallel)');
            try {
                const [qqqData, vixData, nqData, fxData] = await Promise.all([
                    this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/QQQ'),
                    this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/^VIX'),
                    this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/NQ=F'),
                    this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/JPY=X')
                ]);

                if (qqqData?.chart?.result?.[0]) {
                    const r = qqqData.chart.result[0], q = r.indicators.quote[0], m = r.meta;
                    this.data.currentPrice = m.regularMarketPrice;
                    this.data.previousClose = m.previousClose;
                    this.data.dayHigh = m.regularMarketDayHigh;
                    this.data.dayLow = m.regularMarketDayLow;
                    this.data.volume = q.volume?.[q.volume.length - 1];
                    this.data.week52High = m.fiftyTwoWeekHigh;
                    this.data.week52Low = m.fiftyTwoWeekLow;
                    this.updateUI();
                }

                if (vixData?.chart?.result?.[0]) {
                    const m = vixData.chart.result[0].meta;
                    this.data.vix = {
                        value: m.regularMarketPrice,
                        change: m.regularMarketPrice - m.previousClose,
                        changePercent: ((m.regularMarketPrice - m.previousClose) / m.previousClose) * 100
                    };
                    this.updateVIX();
                }

                if (nqData?.chart?.result?.[0]) {
                    const m = nqData.chart.result[0].meta;
                    this.data.nqFutures = {
                        price: m.regularMarketPrice,
                        change: m.regularMarketPrice - m.previousClose,
                        changePercent: ((m.regularMarketPrice - m.previousClose) / m.previousClose) * 100
                    };
                    this.updateNQFutures();
                }

                if (fxData?.chart?.result?.[0]) {
                    const m = fxData.chart.result[0].meta;
                    this.data.usdjpy = {
                        rate: m.regularMarketPrice,
                        change: m.regularMarketPrice - m.previousClose,
                        changePercent: ((m.regularMarketPrice - m.previousClose) / m.previousClose) * 100
                    };
                    this.updateUSDJPY();
                }

                await Promise.all([this.calculate200MA(), this.fetchWeekOpen(), this.fetch5YearHigh()]);

                this.checkAlerts();
                this.updateMarketStatus();
                this.updateLastUpdated();
                this.updateScoreboard();
                this.updateMood();

            } catch (error) {
                this.log(`Error: ${error.message}`, 'error');
                ToastManager.show(`Data fetch failed: ${error.message}`, 'error');
                if (!this.settings.demoMode) {
                    this.settings.demoMode = true;
                    $('demoMode').checked = true;
                    $('demoBanner').classList.add('show');
                    this.useDemoData();
                    this.saveSettings();
                }
            }
        },

        updateLastUpdated() {
            $('lastUpdated').textContent = `Updated ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;
        },

        async fetchWithProxy(url) {
            // 1) Try Vercel self-hosted proxy first (when deployed)
            if (this.isHosted) {
                try {
                    const proxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
                    this.log('Using Vercel proxy');
                    const res = await fetch(proxyUrl);
                    if (res.ok) {
                        const data = await res.json();
                        if (data?.chart) return data;
                    }
                } catch (e) {
                    this.log(`Vercel proxy failed: ${e.message}`, 'warn');
                }
            }

            // 2) Try direct fetch (works in some environments / extensions)
            try {
                this.log('Trying direct fetch');
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (res.ok) return await res.json();
            } catch {}

            // 3) Fallback to public CORS proxies
            let retries = 0;
            while (retries < this.corsProxies.length) {
                const proxy = this.corsProxies[this.currentProxyIndex];
                try {
                    this.log(`Proxy: ${proxy}`);
                    const res = await fetch(proxy + encodeURIComponent(url));
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    if (data?.chart || data?.meta) return data;
                    throw new Error('Invalid response');
                } catch (e) {
                    this.log(`Proxy failed: ${e.message}`, 'error');
                    this.currentProxyIndex = (this.currentProxyIndex + 1) % this.corsProxies.length;
                    retries++;
                }
            }
            throw new Error('All fetch methods failed');
        },

        // ---- 200MA (cached 24h) ----
        async calculate200MA() {
            const cached = CacheManager.get('ma200');
            if (cached) { this.data.ma200 = cached; NumberAnimator.animate($('ma200'), cached); this.updateMADev(); return; }
            try {
                this.log('Calculating 200MA');
                const end = Math.floor(Date.now() / 1000), start = end - 300 * 86400;
                const data = await this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/QQQ?period1=${start}&period2=${end}&interval=1d`);
                if (data?.chart?.result?.[0]) {
                    const closes = data.chart.result[0].indicators.quote[0].close.filter(c => c !== null);
                    const last200 = closes.slice(-200);
                    if (last200.length >= 200) {
                        this.data.ma200 = last200.reduce((a, b) => a + b, 0) / 200;
                        CacheManager.set('ma200', this.data.ma200, 86400000);
                        NumberAnimator.animate($('ma200'), this.data.ma200);
                        this.updateMADev();
                    }
                }
            } catch (e) { this.log(`200MA error: ${e.message}`, 'error'); }
        },

        updateMADev() {
            if (this.data.currentPrice && this.data.ma200) {
                const dev = ((this.data.currentPrice - this.data.ma200) / this.data.ma200) * 100;
                const el = $('maDev');
                el.textContent = `${dev >= 0 ? '+' : ''}${dev.toFixed(2)}%`;
                el.className = dev < 0 ? 'indicator-value negative' : 'indicator-value positive';
            }
        },

        // ---- Week open (cached to Sunday) ----
        async fetchWeekOpen() {
            const cached = CacheManager.get('weekOpen');
            if (cached) { this.data.weekOpen = cached; NumberAnimator.animate($('weekOpen'), cached); this.updateRule5(); return; }
            try {
                this.log('Fetching week open');
                const now = new Date(), dow = now.getDay(), diff = dow === 0 ? -6 : 1 - dow;
                const mon = new Date(now); mon.setDate(mon.getDate() + diff); mon.setHours(0,0,0,0);
                const s = Math.floor(mon.getTime() / 1000);
                const data = await this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/QQQ?period1=${s}&period2=${s + 432000}&interval=1d`);
                if (data?.chart?.result?.[0]) {
                    for (const v of data.chart.result[0].indicators.quote[0].open) {
                        if (v !== null) {
                            this.data.weekOpen = v;
                            const sun = new Date(mon); sun.setDate(sun.getDate() + 6); sun.setHours(23,59,59,999);
                            CacheManager.set('weekOpen', v, sun.getTime() - Date.now());
                            NumberAnimator.animate($('weekOpen'), v);
                            this.updateRule5();
                            break;
                        }
                    }
                }
            } catch (e) { this.log(`Week open error: ${e.message}`, 'error'); }
        },

        updateRule5() {
            if (this.data.currentPrice && this.data.weekOpen) {
                const ch = ((this.data.currentPrice - this.data.weekOpen) / this.data.weekOpen) * 100;
                const el = $('rule5');
                el.textContent = `${ch >= 0 ? '+' : ''}${ch.toFixed(2)}%`;
                el.className = ch < 0 ? 'indicator-value negative' : 'indicator-value positive';
            }
        },

        // ---- 5Y high (cached 24h) ----
        async fetch5YearHigh() {
            const cached = CacheManager.get('year5High');
            if (cached) { this.data.year5High = cached; NumberAnimator.animate($('year5High'), cached); this.update5YDiff(); return; }
            try {
                this.log('Fetching 5Y high');
                const end = Math.floor(Date.now() / 1000), start = end - 5 * 365 * 86400;
                const data = await this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/QQQ?period1=${start}&period2=${end}&interval=1wk`);
                if (data?.chart?.result?.[0]) {
                    const highs = data.chart.result[0].indicators.quote[0].high.filter(h => h !== null);
                    this.data.year5High = Math.max(...highs);
                    CacheManager.set('year5High', this.data.year5High, 86400000);
                    NumberAnimator.animate($('year5High'), this.data.year5High);
                    this.update5YDiff();
                }
            } catch (e) { this.log(`5Y high error: ${e.message}`, 'error'); }
        },

        update5YDiff() {
            if (this.data.currentPrice && this.data.year5High) {
                const d = ((this.data.currentPrice - this.data.year5High) / this.data.year5High) * 100;
                const el = $('year5Diff');
                el.textContent = `${d >= 0 ? '+' : ''}${d.toFixed(2)}%`;
                el.className = d < 0 ? 'detail-value negative' : 'detail-value positive';
            }
        },

        // ---- Chart ----
        async fetchChartData() {
            try {
                const periods = { '1d':{interval:'5m',range:'1d'}, '5d':{interval:'30m',range:'5d'}, '1mo':{interval:'1h',range:'1mo'}, '3mo':{interval:'1d',range:'3mo'}, '6mo':{interval:'1d',range:'6mo'}, '1y':{interval:'1wk',range:'1y'} };
                const c = periods[this.chartPeriod];
                const data = await this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/QQQ?range=${c.range}&interval=${c.interval}`);
                if (data?.chart?.result?.[0]) {
                    const r = data.chart.result[0];
                    this.chartData = { labels: r.timestamp.map(t => this.fmtTs(t * 1000, this.chartPeriod)), prices: r.indicators.quote[0].close };
                    this.updateChart();
                }
            } catch (e) { this.log(`Chart error: ${e.message}`, 'error'); }
        },

        fmtTs(ts, p) {
            const d = new Date(ts);
            if (p === '1d') return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            if (p === '5d') return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        },

        // ---- UI Updates ----
        updateUI() {
            if (!this.data.currentPrice) return;
            NumberAnimator.animate($('currentPrice'), this.data.currentPrice, '$');

            const ch = this.data.currentPrice - this.data.previousClose;
            const pct = (ch / this.data.previousClose) * 100;
            $('changeAmount').textContent = `${ch >= 0 ? '+' : ''}${ch.toFixed(2)}`;
            $('changePercent').textContent = `(${ch >= 0 ? '+' : ''}${pct.toFixed(2)}%)`;
            $('changeAmount').className = ch >= 0 ? 'change-amount positive' : 'change-amount negative';
            $('changePercent').className = ch >= 0 ? 'change-percent positive' : 'change-percent negative';

            NumberAnimator.animate($('prevClose'), this.data.previousClose);
            NumberAnimator.animate($('dayHigh'), this.data.dayHigh);
            NumberAnimator.animate($('dayLow'), this.data.dayLow);
            NumberAnimator.animate($('week52High'), this.data.week52High);
            NumberAnimator.animate($('week52Low'), this.data.week52Low);
            $('volume').textContent = this.fmtVol(this.data.volume);

            const l1 = this.data.previousClose * (1 - this.settings.thresholdLevel1 / 100);
            const l2 = this.data.previousClose * (1 - this.settings.thresholdLevel2 / 100);
            NumberAnimator.animate($('level12'), l1);
            NumberAnimator.animate($('level18'), l2);

            $('level18').style.color = this.data.currentPrice <= l2 ? 'var(--red)' : '';
            $('level12').style.color = this.data.currentPrice <= l1 ? 'var(--orange)' : '';

            this.updateMADev();
        },

        updateVIX() {
            if (!this.data.vix) return;
            NumberAnimator.animate($('vixValue'), this.data.vix.value, '', 2);
            const ce = $('vixChange');
            ce.textContent = `${this.data.vix.change >= 0 ? '+' : ''}${this.data.vix.change.toFixed(2)} (${this.data.vix.changePercent >= 0 ? '+' : ''}${this.data.vix.changePercent.toFixed(1)}%)`;
            ce.className = this.data.vix.change >= 0 ? 'vix-change negative' : 'vix-change positive';

            const pct = Math.min((this.data.vix.value / 40) * 100, 100);
            const g = $('vixGauge');
            g.style.width = `${pct}%`;
            g.style.background = this.data.vix.value < 20 ? 'var(--green)' : this.data.vix.value < 30 ? 'var(--yellow)' : 'var(--red)';

            const s = $('vixStatus');
            if (this.data.vix.value < 20) { s.textContent = 'Low Vol'; s.className = 'vix-status vix-low'; }
            else if (this.data.vix.value < 30) { s.textContent = 'Mid Vol'; s.className = 'vix-status vix-medium'; }
            else { s.textContent = 'High Vol'; s.className = 'vix-status vix-high'; }
        },

        updateNQFutures() {
            if (!this.data.nqFutures) return;
            $('futuresPrice').textContent = `$${this.data.nqFutures.price.toFixed(2)}`;
            const ce = $('futuresChange');
            ce.textContent = `${this.data.nqFutures.change >= 0 ? '+' : ''}${this.data.nqFutures.change.toFixed(2)} (${this.data.nqFutures.changePercent >= 0 ? '+' : ''}${this.data.nqFutures.changePercent.toFixed(2)}%)`;
            ce.className = this.data.nqFutures.change >= 0 ? 'futures-change positive' : 'futures-change negative';
        },

        updateUSDJPY() {
            if (!this.data.usdjpy) return;
            $('fxPrice').textContent = `${this.data.usdjpy.rate.toFixed(2)}`;
            const ce = $('fxChange');
            ce.textContent = `${this.data.usdjpy.change >= 0 ? '+' : ''}${this.data.usdjpy.change.toFixed(2)} (${this.data.usdjpy.changePercent >= 0 ? '+' : ''}${this.data.usdjpy.changePercent.toFixed(2)}%)`;
            ce.className = this.data.usdjpy.change >= 0 ? 'fx-change positive' : 'fx-change negative';
        },

        updateMarketStatus() {
            const now = new Date();
            const ny = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const d = ny.getDay(), h = ny.getHours(), m = ny.getMinutes();
            let st, cl;
            if (d === 0 || d === 6) { st = 'Weekend - Closed'; cl = 'market-closed'; }
            else if (h < 9 || h >= 16 || (h === 9 && m < 30)) { st = 'After Hours'; cl = 'market-closed'; }
            else { st = 'Market Open'; cl = 'market-open'; }
            const el = $('marketStatus');
            el.textContent = `${st} (NY ${ny.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })})`;
            el.className = `market-status ${cl}`;
        },

        // ---- Signal Scoreboard ----
        updateScoreboard() {
            const d = this.data, s = this.settings;
            if (!d.currentPrice) return;

            const signals = [
                { name: 'Below 200MA', on: d.ma200 && d.currentPrice <= d.ma200 },
                { name: `-${s.thresholdLevel1}%`, on: d.previousClose && d.currentPrice <= d.previousClose * (1 - s.thresholdLevel1 / 100) },
                { name: `-${s.thresholdLevel2}%`, on: d.previousClose && d.currentPrice <= d.previousClose * (1 - s.thresholdLevel2 / 100) },
                { name: `-${s.thresholdWeekly}% Week`, on: d.weekOpen && ((d.currentPrice - d.weekOpen) / d.weekOpen * 100) <= -s.thresholdWeekly },
                { name: `VIX>${s.thresholdVixHigh}`, on: d.vix && d.vix.value >= s.thresholdVixHigh },
                { name: `VIX>${s.thresholdVixExtreme}`, on: d.vix && d.vix.value >= s.thresholdVixExtreme }
            ];

            const count = signals.filter(s => s.on).length;
            const total = signals.length;
            const pct = count / total;

            // Ring
            const circ = 2 * Math.PI * 34; // ~213.6
            $('scoreRing').style.strokeDashoffset = circ * (1 - pct);
            $('scoreRing').style.stroke = pct === 0 ? 'var(--text-muted)' : pct < 0.4 ? 'var(--yellow)' : pct < 0.7 ? 'var(--orange)' : 'var(--red)';
            $('scoreNumber').textContent = `${count}/${total}`;

            const descs = ['No signals', 'Monitoring', 'Elevated', 'Alert', 'Strong buy zone', 'Max opportunity'];
            $('scoreDesc').textContent = descs[count] || descs[0];
            $('scoreDesc').style.color = pct >= 0.7 ? 'var(--red)' : pct >= 0.4 ? 'var(--orange)' : pct > 0 ? 'var(--yellow)' : 'var(--text-secondary)';

            // Pills
            $('signalPills').innerHTML = signals.map(s =>
                `<span class="signal-pill ${s.on ? 'signal-on' : 'signal-off'}">${s.on ? '' : ''} ${s.name}</span>`
            ).join('');
        },

        // ---- Dynamic mood background ----
        updateMood() {
            const d = this.data;
            let mood = 'calm';

            if (d.vix) {
                const v = d.vix.value;
                if (v >= 35) mood = 'panic';
                else if (v >= 25) mood = 'fear';
                else if (v >= 20) mood = 'cautious';
                else if (v < 15) mood = 'euphoria';
            }

            // Override with price signals
            if (d.currentPrice && d.previousClose) {
                const dayChange = ((d.currentPrice - d.previousClose) / d.previousClose) * 100;
                if (dayChange <= -5) mood = 'panic';
                else if (dayChange <= -3 && mood !== 'panic') mood = 'fear';
                else if (dayChange >= 3 && mood === 'calm') mood = 'euphoria';
            }

            if (mood !== this.currentMood) {
                document.body.className = `mood-${mood}`;
                const ml = $('moodLabel');
                const labels = { euphoria: 'EUPHORIA', calm: 'CALM', cautious: 'CAUTIOUS', fear: 'FEAR', panic: 'PANIC' };
                ml.textContent = labels[mood];
                ml.className = `mood-label mood-label-${mood}`;
                this.currentMood = mood;
                this.log(`Mood changed: ${mood}`);
            }
        },

        // ---- Alerts ----
        checkAlerts() {
            if (!this.data.currentPrice || !this.data.previousClose) return;
            const s = this.settings, d = this.data;
            const l1 = d.previousClose * (1 - s.thresholdLevel1 / 100);
            const l2 = d.previousClose * (1 - s.thresholdLevel2 / 100);

            if (d.currentPrice <= l2 && !this.alertsTriggered.level18) { ToastManager.show(`Below -${s.thresholdLevel2}% level!`, 'error', 10000); this.alertsTriggered.level18 = true; }
            else if (d.currentPrice > l2) this.alertsTriggered.level18 = false;

            if (d.currentPrice <= l1 && !this.alertsTriggered.level12) { ToastManager.show(`Below -${s.thresholdLevel1}% level!`, 'warning', 10000); this.alertsTriggered.level12 = true; }
            else if (d.currentPrice > l1) this.alertsTriggered.level12 = false;

            if (d.ma200 && d.currentPrice <= d.ma200 && !this.alertsTriggered.ma200) { ToastManager.show('Below 200-day MA!', 'warning', 10000); this.alertsTriggered.ma200 = true; }
            else if (d.ma200 && d.currentPrice > d.ma200) this.alertsTriggered.ma200 = false;

            if (d.weekOpen) {
                const wc = ((d.currentPrice - d.weekOpen) / d.weekOpen) * 100;
                if (wc <= -s.thresholdWeekly && !this.alertsTriggered.rule5) { ToastManager.show(`-${s.thresholdWeekly}% Rule triggered!`, 'error', 10000); this.alertsTriggered.rule5 = true; }
                else if (wc > -s.thresholdWeekly) this.alertsTriggered.rule5 = false;
            }

            if (d.vix) {
                if (d.vix.value >= s.thresholdVixExtreme && !this.alertsTriggered.vix35) { ToastManager.show(`VIX above ${s.thresholdVixExtreme} - Extreme fear!`, 'error', 10000); this.alertsTriggered.vix35 = true; }
                else if (d.vix.value < s.thresholdVixExtreme) this.alertsTriggered.vix35 = false;

                if (d.vix.value >= s.thresholdVixHigh && d.vix.value < s.thresholdVixExtreme && !this.alertsTriggered.vix30) { ToastManager.show(`VIX above ${s.thresholdVixHigh} - High volatility`, 'warning', 10000); this.alertsTriggered.vix30 = true; }
                else if (d.vix.value < s.thresholdVixHigh) this.alertsTriggered.vix30 = false;
            }

            if (Object.values(this.alertsTriggered).some(v => v)) {
                if (s.soundEnabled) this.playAlertSound();
                if (s.notificationEnabled && Notification.permission === 'granted') {
                    new Notification('QQQ Pro Tracker Alert', { body: 'Investment threshold alert triggered' });
                }
            }
        },

        playAlertSound() {
            try {
                const c = new (window.AudioContext || window.webkitAudioContext)();
                const o = c.createOscillator(), g = c.createGain();
                o.connect(g); g.connect(c.destination);
                o.frequency.value = 800; g.gain.value = 0.3;
                o.start(); o.stop(c.currentTime + 0.2);
            } catch {}
        },

        // ---- Chart ----
        initChart() {
            this.chart = new Chart($('priceChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'QQQ', data: [], borderColor: '#00d4ff',
                        backgroundColor: (ctx) => {
                            const { ctx: c, chartArea } = ctx.chart;
                            if (!chartArea) return 'rgba(0,212,255,0.05)';
                            const gr = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            gr.addColorStop(0, 'rgba(0,212,255,0.15)'); gr.addColorStop(1, 'rgba(0,212,255,0)');
                            return gr;
                        },
                        fill: true, borderWidth: 2, tension: 0.3, pointRadius: 0,
                        pointHoverRadius: 5, pointHoverBackgroundColor: '#00d4ff',
                        pointHoverBorderColor: '#fff', pointHoverBorderWidth: 2
                    }, {
                        label: '200MA', data: [], borderColor: 'rgba(255,183,64,0.6)',
                        borderWidth: 1.5, borderDash: [6, 4], tension: 0, pointRadius: 0, pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, labels: { color: 'rgba(255,255,255,0.5)', usePointStyle: true, padding: 20, font: { family: 'Inter', size: 12 } } },
                        tooltip: {
                            backgroundColor: 'rgba(10,14,26,0.95)', titleColor: 'rgba(255,255,255,0.7)', bodyColor: '#fff',
                            borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, padding: 12, cornerRadius: 8,
                            titleFont: { family: 'Inter' }, bodyFont: { family: 'Inter', weight: '600' },
                            callbacks: { label: (c) => `${c.dataset.label}: $${c.parsed.y?.toFixed(2) || '---'}` }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: 'rgba(255,255,255,0.3)', font: { family: 'Inter', size: 11 }, maxRotation: 45, minRotation: 45 } },
                        y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: 'rgba(255,255,255,0.3)', font: { family: 'Inter', size: 11 }, callback: v => '$' + v.toFixed(0) } }
                    }
                }
            });
        },

        updateChart() {
            if (!this.chart || !this.chartData) return;
            this.chart.data.labels = this.chartData.labels;
            this.chart.data.datasets[0].data = this.chartData.prices;
            if (this.data.ma200) this.chart.data.datasets[1].data = new Array(this.chartData.prices.length).fill(this.data.ma200);
            this.chart.update('none');
        },

        fmtVol(v) {
            if (!v) return '---';
            if (v >= 1e9) return (v / 1e9).toFixed(2) + 'B';
            if (v >= 1e6) return (v / 1e6).toFixed(2) + 'M';
            if (v >= 1e3) return (v / 1e3).toFixed(1) + 'K';
            return v.toString();
        },

        // ---- Demo data ----
        useDemoData() {
            this.log('Using demo data');
            this.data = {
                currentPrice: 432.58, previousClose: 435.20,
                dayHigh: 437.85, dayLow: 430.12,
                week52High: 508.59, week52Low: 362.45,
                volume: 45832100, ma200: 445.32, weekOpen: 440.25,
                vix: { value: 18.45, change: 1.23, changePercent: 7.14 },
                nqFutures: { price: 18652.25, change: -125.50, changePercent: -0.67 },
                year5High: 508.59,
                usdjpy: { rate: 149.52, change: -0.38, changePercent: -0.25 }
            };

            this.updateUI(); this.updateVIX(); this.updateNQFutures(); this.updateUSDJPY();
            this.updateMarketStatus(); this.updateLastUpdated();
            NumberAnimator.animate($('ma200'), this.data.ma200);
            NumberAnimator.animate($('weekOpen'), this.data.weekOpen);
            NumberAnimator.animate($('year5High'), this.data.year5High);
            this.updateRule5(); this.update5YDiff(); this.updateScoreboard(); this.updateMood();

            const labels = [], prices = [];
            let p = 430;
            for (let i = 0; i < 50; i++) {
                labels.push(`${9 + Math.floor(i * 7 / 50)}:${String((i * 7) % 60).padStart(2, '0')}`);
                p += (Math.random() - 0.48) * 2; prices.push(p);
            }
            this.chartData = { labels, prices }; this.updateChart();
            ToastManager.show('Demo mode active', 'info');
        },

        startAutoRefresh() {
            if (this.refreshTimer) clearInterval(this.refreshTimer);
            this.refreshTimer = setInterval(() => { if (!this.settings.demoMode) this.fetchData(); }, this.settings.refreshInterval * 1000);
        },

        openSettings() { $('settingsModal').classList.add('open'); },
        closeSettings() { $('settingsModal').classList.remove('open'); },

        log(msg, type = 'info') {
            const m = `[${new Date().toLocaleTimeString('en-US')}] ${msg}`;
            console.log(m);
            if (this.settings.debugMode) {
                const e = document.createElement('div');
                e.style.color = type === 'error' ? 'var(--red)' : type === 'warn' ? 'var(--yellow)' : 'var(--green)';
                e.textContent = m; $('debugPanel').appendChild(e); $('debugPanel').scrollTop = 1e6;
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
    window.addEventListener('click', (e) => { if (e.target === $('settingsModal')) app.closeSettings(); });
    </script>
</body>
</html>
