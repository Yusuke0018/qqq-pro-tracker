<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0e1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>QQQ Pro Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='64' height='64'%3e%3crect width='64' height='64' rx='12' fill='%23111'/%3e%3cpath d='M12 44L24 32L36 40L52 24' stroke='%2300d4ff' stroke-width='4' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3e%3ccircle cx='52' cy='24' r='4' fill='%2300d4ff'/%3e%3c/svg%3e" type="image/svg+xml">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='180' height='180'%3e%3crect width='64' height='64' rx='12' fill='%23111'/%3e%3cpath d='M12 44L24 32L36 40L52 24' stroke='%2300d4ff' stroke-width='4' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3e%3ccircle cx='52' cy='24' r='4' fill='%2300d4ff'/%3e%3c/svg%3e">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0e1a;
            --bg-card: rgba(15, 20, 40, 0.6);
            --border-card: rgba(255, 255, 255, 0.08);
            --border-glow: rgba(0, 212, 255, 0.3);
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.25);
            --green: #00e68a;
            --red: #ff4d6a;
            --yellow: #ffb740;
            --orange: #ff8c42;
            --text-primary: #f0f2f5;
            --text-secondary: rgba(255, 255, 255, 0.55);
            --text-muted: rgba(255, 255, 255, 0.35);
            --radius: 16px;
            --radius-sm: 10px;
            --blur: 20px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            transition: background 2s ease;
        }

        /* ====== Dynamic mood backgrounds (5 moods) ====== */
        /* ::before = color layer,  ::after = pattern/illustration layer */
        body::before, body::after {
            content: '';
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            transition: opacity 2s ease, background 2s ease;
        }

        /* ===== 1. EUPHORIA - strong bull (vivid green aurora + rising arrows) ===== */
        body.mood-euphoria { background: linear-gradient(160deg, #021a0a 0%, #0a1e1a 40%, #041510 100%); }
        body.mood-euphoria::before {
            background:
                radial-gradient(ellipse 90% 70% at 20% 30%, rgba(0, 230, 130, 0.5) 0%, transparent 55%),
                radial-gradient(ellipse 70% 60% at 75% 65%, rgba(0, 200, 200, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse 40% 35% at 50% 80%, rgba(0, 255, 180, 0.2) 0%, transparent 45%);
            animation: euphoriaDrift 8s ease-in-out infinite alternate;
        }
        body.mood-euphoria::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cdefs%3E%3ClinearGradient id='ag' x1='0' y1='1' x2='0' y2='0'%3E%3Cstop offset='0' stop-color='%2300e68a' stop-opacity='0'/%3E%3Cstop offset='1' stop-color='%2300e68a' stop-opacity='0.6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M70 115 L70 35' stroke='url(%23ag)' stroke-width='4' fill='none' stroke-linecap='round'/%3E%3Cpath d='M70 35 L52 58' stroke='%2300e68a' stroke-width='4' fill='none' opacity='0.7' stroke-linecap='round'/%3E%3Cpath d='M70 35 L88 58' stroke='%2300e68a' stroke-width='4' fill='none' opacity='0.7' stroke-linecap='round'/%3E%3Ccircle cx='70' cy='28' r='5' fill='%2300e68a' opacity='0.5'/%3E%3Ccircle cx='30' cy='90' r='2' fill='%2300ffaa' opacity='0.3'/%3E%3Ccircle cx='110' cy='70' r='2' fill='%2300ffaa' opacity='0.3'/%3E%3Ccircle cx='20' cy='40' r='1.5' fill='%2300ffaa' opacity='0.2'/%3E%3Ccircle cx='120' cy='110' r='1.5' fill='%2300ffaa' opacity='0.2'/%3E%3C/svg%3E");
            background-size: 140px 140px;
            opacity: 1;
            animation: patternRise 12s linear infinite;
        }
        @keyframes euphoriaDrift {
            0% { transform: translateY(0) scale(1); }
            100% { transform: translateY(-15px) scale(1.03); }
        }
        @keyframes patternRise {
            0% { background-position: 0 0; }
            100% { background-position: 70px -140px; }
        }

        /* ===== 2. CALM - stable (deep blue + gentle wave + dots) ===== */
        body.mood-calm { background: linear-gradient(160deg, #050a18 0%, #0a0e1a 40%, #06091a 100%); }
        body.mood-calm::before {
            background:
                radial-gradient(ellipse 85% 65% at 15% 25%, rgba(0, 80, 180, 0.4) 0%, transparent 55%),
                radial-gradient(ellipse 65% 55% at 80% 70%, rgba(40, 0, 120, 0.35) 0%, transparent 50%),
                radial-gradient(ellipse 45% 40% at 55% 45%, rgba(0, 140, 200, 0.15) 0%, transparent 45%);
            animation: calmBreath 10s ease-in-out infinite alternate;
        }
        body.mood-calm::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='120' viewBox='0 0 240 120'%3E%3Cpath d='M0 60 Q30 30 60 60 T120 60 T180 60 T240 60' stroke='%230099dd' stroke-width='2.5' fill='none' opacity='0.5'/%3E%3Cpath d='M0 80 Q30 55 60 80 T120 80 T180 80 T240 80' stroke='%235588bb' stroke-width='2' fill='none' opacity='0.35'/%3E%3Cpath d='M0 40 Q30 20 60 40 T120 40 T180 40 T240 40' stroke='%23336699' stroke-width='1.5' fill='none' opacity='0.25'/%3E%3Ccircle cx='60' cy='60' r='2' fill='%2300aaff' opacity='0.3'/%3E%3Ccircle cx='180' cy='60' r='2' fill='%2300aaff' opacity='0.3'/%3E%3Ccircle cx='120' cy='40' r='1.5' fill='%2300aaff' opacity='0.2'/%3E%3C/svg%3E");
            background-size: 240px 120px;
            opacity: 1;
            animation: waveScroll 16s linear infinite;
        }
        @keyframes calmBreath {
            0% { opacity: 0.9; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.02); }
        }
        @keyframes waveScroll {
            0% { background-position: 0 0; }
            100% { background-position: 240px 0; }
        }

        /* ===== 3. CAUTIOUS - elevated volatility (purple/violet + zigzag chart) ===== */
        body.mood-cautious { background: linear-gradient(160deg, #0e0520 0%, #120a22 40%, #0a0418 100%); }
        body.mood-cautious::before {
            background:
                radial-gradient(ellipse 85% 65% at 15% 30%, rgba(80, 40, 180, 0.5) 0%, transparent 55%),
                radial-gradient(ellipse 65% 55% at 80% 65%, rgba(120, 0, 180, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse 50% 40% at 50% 50%, rgba(160, 80, 240, 0.2) 0%, transparent 45%);
            animation: cautiousShift 6s ease-in-out infinite alternate;
        }
        body.mood-cautious::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='120' viewBox='0 0 160 120'%3E%3Cdefs%3E%3ClinearGradient id='zg' x1='0' y1='0' x2='1' y2='0'%3E%3Cstop offset='0' stop-color='%239955ff' stop-opacity='0.2'/%3E%3Cstop offset='0.5' stop-color='%23bb77ff' stop-opacity='0.6'/%3E%3Cstop offset='1' stop-color='%239955ff' stop-opacity='0.2'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M5 85 L30 35 L55 70 L80 20 L105 55 L130 25 L155 60' stroke='url(%23zg)' stroke-width='3' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='80' cy='20' r='4' fill='%23bb77ff' opacity='0.4'/%3E%3Ccircle cx='130' cy='25' r='3' fill='%23aa66ff' opacity='0.3'/%3E%3Cline x1='80' y1='20' x2='80' y2='120' stroke='%239955ff' stroke-width='1' opacity='0.15' stroke-dasharray='4 4'/%3E%3Cpath d='M5 100 L155 100' stroke='%239955ff' stroke-width='1' opacity='0.2'/%3E%3C/svg%3E");
            background-size: 160px 120px;
            opacity: 1;
            animation: patternJitter 10s ease-in-out infinite;
        }
        @keyframes cautiousShift {
            0% { transform: translateX(0); }
            100% { transform: translateX(8px); }
        }
        @keyframes patternJitter {
            0% { background-position: 0 0; }
            50% { background-position: 20px -15px; }
            100% { background-position: 0 0; }
        }

        /* ===== 4. FEAR - high volatility (orange/amber + lightning bolts) ===== */
        body.mood-fear { background: linear-gradient(160deg, #1a0e00 0%, #1a1005 40%, #180a00 100%); }
        body.mood-fear::before {
            background:
                radial-gradient(ellipse 85% 65% at 20% 25%, rgba(200, 120, 0, 0.55) 0%, transparent 55%),
                radial-gradient(ellipse 65% 55% at 75% 70%, rgba(180, 60, 0, 0.45) 0%, transparent 50%),
                radial-gradient(ellipse 50% 40% at 50% 50%, rgba(255, 160, 0, 0.2) 0%, transparent 45%);
            animation: fearFlicker 4s ease-in-out infinite alternate;
        }
        body.mood-fear::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='160' viewBox='0 0 120 160'%3E%3Cpath d='M65 10 L42 72 L62 66 L40 140' stroke='%23ffbb33' stroke-width='4' fill='none' stroke-linecap='round' stroke-linejoin='round' opacity='0.6'/%3E%3Cpath d='M85 30 L72 75 L84 70 L75 110' stroke='%23ff9900' stroke-width='3' fill='none' stroke-linecap='round' opacity='0.35'/%3E%3Ccircle cx='40' cy='140' r='4' fill='%23ffaa00' opacity='0.35'/%3E%3Ccircle cx='65' cy='10' r='3' fill='%23ffcc44' opacity='0.3'/%3E%3Cline x1='15' y1='50' x2='35' y2='55' stroke='%23ffaa00' stroke-width='1.5' opacity='0.25' stroke-linecap='round'/%3E%3Cline x1='90' y1='120' x2='110' y2='115' stroke='%23ffaa00' stroke-width='1.5' opacity='0.25' stroke-linecap='round'/%3E%3C/svg%3E");
            background-size: 120px 160px;
            opacity: 1;
            animation: fearBolts 3s ease-in-out infinite;
        }
        @keyframes fearFlicker {
            0% { opacity: 0.85; }
            30% { opacity: 1; }
            60% { opacity: 0.75; }
            100% { opacity: 0.95; }
        }
        @keyframes fearBolts {
            0%, 100% { opacity: 0.8; }
            15% { opacity: 1; }
            20% { opacity: 0.4; }
            50% { opacity: 0.9; }
            70% { opacity: 1; }
            75% { opacity: 0.3; }
        }

        /* ===== 5. PANIC - crash (deep red + cracking/shatter + pulse) ===== */
        body.mood-panic { background: linear-gradient(160deg, #1a0005 0%, #200008 40%, #180005 100%); }
        body.mood-panic::before {
            background:
                radial-gradient(ellipse 90% 70% at 15% 25%, rgba(200, 0, 40, 0.6) 0%, transparent 55%),
                radial-gradient(ellipse 70% 60% at 80% 70%, rgba(150, 0, 0, 0.5) 0%, transparent 50%),
                radial-gradient(ellipse 50% 40% at 50% 50%, rgba(255, 30, 80, 0.25) 0%, transparent 45%);
            animation: panicPulse 2.5s ease-in-out infinite;
        }
        body.mood-panic::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Cpath d='M90 15 L78 85 L55 78 L90 165 L102 85 L125 92 Z' stroke='%23ff2244' stroke-width='3' fill='%23ff1133' fill-opacity='0.08' opacity='0.5'/%3E%3Cpath d='M30 60 L65 68' stroke='%23ff0033' stroke-width='2.5' opacity='0.4' stroke-linecap='round'/%3E%3Cpath d='M115 55 L150 48' stroke='%23ff0033' stroke-width='2.5' opacity='0.4' stroke-linecap='round'/%3E%3Cpath d='M25 120 L60 110' stroke='%23cc0022' stroke-width='2' opacity='0.3' stroke-linecap='round'/%3E%3Cpath d='M120 115 L155 125' stroke='%23cc0022' stroke-width='2' opacity='0.3' stroke-linecap='round'/%3E%3Ccircle cx='90' cy='90' r='40' stroke='%23ff2244' stroke-width='1.5' fill='none' opacity='0.2'/%3E%3Ccircle cx='90' cy='90' r='65' stroke='%23ff0033' stroke-width='1' fill='none' opacity='0.12'/%3E%3Ccircle cx='90' cy='90' r='85' stroke='%23cc0022' stroke-width='0.8' fill='none' opacity='0.08'/%3E%3C/svg%3E");
            background-size: 180px 180px;
            opacity: 1;
            animation: panicShatter 1.5s ease-in-out infinite;
        }
        @keyframes panicPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        @keyframes panicShatter {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            25% { opacity: 1; transform: scale(1.02); }
            50% { opacity: 0.5; transform: scale(0.98); }
            75% { opacity: 0.9; transform: scale(1.01); }
        }

        /* Mood indicator label */
        .mood-label {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .mood-label-euphoria { background: rgba(0,230,138,0.25); color: #00ff99; border: 1px solid rgba(0,230,138,0.3); }
        .mood-label-calm { background: rgba(0,120,255,0.2); color: #66bbff; border: 1px solid rgba(0,120,255,0.25); }
        .mood-label-cautious { background: rgba(160,80,255,0.25); color: #cc88ff; border: 1px solid rgba(160,80,255,0.3); }
        .mood-label-fear { background: rgba(255,160,0,0.25); color: #ffbb33; border: 1px solid rgba(255,160,0,0.3); }
        .mood-label-panic { background: rgba(255,30,60,0.3); color: #ff4466; border: 1px solid rgba(255,30,60,0.35); animation: panicLabelPulse 1.5s ease-in-out infinite; }
        @keyframes panicLabelPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* ====== Skeleton loading ====== */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 6px;
        }
        .skeleton-text { height: 20px; width: 80px; display: inline-block; vertical-align: middle; }
        .skeleton-lg { height: 48px; width: 160px; display: inline-block; vertical-align: middle; }

        /* ====== Toast notifications ====== */
        .toast-container {
            position: fixed; top: 80px; right: 20px; z-index: 2000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            pointer-events: auto; padding: 14px 20px; border-radius: var(--radius-sm);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--border-card); font-size: 14px; font-weight: 500;
            display: flex; align-items: center; gap: 10px;
            min-width: 300px; max-width: 420px;
            transform: translateX(120%); opacity: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast-error { background: rgba(255, 77, 106, 0.15); border-color: rgba(255, 77, 106, 0.3); color: var(--red); }
        .toast-warning { background: rgba(255, 183, 64, 0.15); border-color: rgba(255, 183, 64, 0.3); color: var(--yellow); }
        .toast-success { background: rgba(0, 230, 138, 0.15); border-color: rgba(0, 230, 138, 0.3); color: var(--green); }
        .toast-info { background: rgba(0, 212, 255, 0.15); border-color: rgba(0, 212, 255, 0.3); color: var(--accent); }

        /* Demo banner */
        .demo-banner {
            display: none; background: linear-gradient(90deg, rgba(255,183,64,0.12), rgba(255,140,66,0.12));
            border-bottom: 1px solid rgba(255,183,64,0.2); padding: 8px 20px;
            text-align: center; font-size: 13px; font-weight: 500; color: var(--yellow);
            position: relative; z-index: 10;
        }
        .demo-banner.show { display: block; }

        /* ====== Header ====== */
        .header {
            background: rgba(10, 14, 26, 0.85);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            padding: 14px 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-card); position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .header h1 {
            font-size: 18px; font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #6366f1);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .last-updated { font-size: 12px; color: var(--text-muted); font-weight: 400; }

        .header-right { display: flex; align-items: center; gap: 10px; }
        .settings-btn {
            background: rgba(255,255,255,0.06); border: 1px solid var(--border-card);
            color: var(--text-secondary); padding: 8px 16px; border-radius: 24px;
            font-size: 13px; font-family: inherit; cursor: pointer; transition: all 0.3s;
        }
        .settings-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--border-glow); color: var(--accent); }

        /* ====== Main content ====== */
        .main-content { position: relative; z-index: 1; padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* Market status */
        .market-status {
            text-align: center; padding: 10px 16px; background: var(--bg-card);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--border-card); border-radius: var(--radius-sm);
            margin-bottom: 20px; font-size: 13px; color: var(--text-secondary);
        }
        .market-open { color: var(--green) !important; }
        .market-closed { color: var(--red) !important; }

        /* Glass card */
        .glass-card {
            background: var(--bg-card); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--border-card); border-radius: var(--radius);
            padding: 24px; margin-bottom: 20px; transition: border-color 0.3s, box-shadow 0.3s;
        }
        .glass-card:hover { border-color: rgba(255,255,255,0.12); }

        /* ====== Signal Scoreboard ====== */
        .scoreboard {
            display: flex; align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 16px;
        }
        .score-ring-wrap { display: flex; align-items: center; gap: 16px; }
        .score-ring {
            position: relative; width: 80px; height: 80px;
        }
        .score-ring svg { transform: rotate(-90deg); }
        .score-ring-bg { fill: none; stroke: rgba(255,255,255,0.06); stroke-width: 6; }
        .score-ring-fill { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease, stroke 0.5s; }
        .score-number {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            font-size: 22px; font-weight: 800;
        }
        .score-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .score-desc { font-size: 15px; font-weight: 600; margin-top: 2px; }

        .signal-pills { display: flex; flex-wrap: wrap; gap: 8px; }
        .signal-pill {
            font-size: 12px; font-weight: 600; padding: 5px 12px;
            border-radius: 14px; border: 1px solid; white-space: nowrap;
        }
        .signal-on { background: rgba(0,230,138,0.12); border-color: rgba(0,230,138,0.3); color: var(--green); }
        .signal-off { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.06); color: var(--text-muted); }

        /* ====== Price section ====== */
        .price-main { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        .current-price { font-size: 48px; font-weight: 800; letter-spacing: -1px; color: var(--text-primary); line-height: 1; }
        .price-change { text-align: right; }
        .change-amount { font-size: 22px; font-weight: 600; margin-bottom: 4px; }
        .change-percent { font-size: 16px; font-weight: 500; }
        .positive { color: var(--green); }
        .negative { color: var(--red); }

        .price-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .detail-item {
            background: rgba(255,255,255,0.03); padding: 12px 14px;
            border-radius: var(--radius-sm); border: 1px solid rgba(255,255,255,0.05);
        }
        .detail-label {
            font-size: 11px; color: var(--text-muted); margin-bottom: 4px;
            text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;
        }
        .detail-value { font-size: 16px; font-weight: 600; color: var(--text-primary); }

        .section-title {
            font-size: 15px; font-weight: 600; margin-bottom: 16px;
            color: var(--text-secondary); display: flex; align-items: center; gap: 8px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* ====== Indicators ====== */
        .indicator-grid { display: grid; gap: 12px; }
        .indicator-item {
            background: rgba(255,255,255,0.03); padding: 14px 16px; border-radius: var(--radius-sm);
            border: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between;
            align-items: center; position: relative; overflow: hidden;
        }
        .indicator-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
        .ma-200::before { background: linear-gradient(180deg, var(--yellow), var(--orange)); }
        .ma-dev::before { background: linear-gradient(180deg, #a78bfa, #6366f1); }
        .level-12::before { background: linear-gradient(180deg, var(--orange), var(--red)); }
        .level-18::before { background: linear-gradient(180deg, var(--red), #cc0033); }
        .week-open::before { background: linear-gradient(180deg, var(--accent), #6366f1); }
        .rule-5::before { background: linear-gradient(180deg, #6366f1, #a855f7); }

        .indicator-label { font-size: 13px; color: var(--text-secondary); }
        .indicator-value { font-size: 18px; font-weight: 600; }

        /* ====== VIX / Futures / USD-JPY ====== */
        .vix-container, .futures-container, .fx-container {
            background: rgba(255,255,255,0.03); padding: 16px; border-radius: var(--radius-sm);
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 12px;
        }
        .vix-container:last-child, .futures-container:last-child, .fx-container:last-child { margin-bottom: 0; }

        .vix-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .vix-value-num { font-size: 32px; font-weight: 700; line-height: 1; }
        .vix-change { font-size: 14px; font-weight: 500; }

        .vix-gauge { height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; margin: 12px 0 8px; }
        .vix-gauge-fill { height: 100%; border-radius: 3px; transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1), background 0.5s; }
        .vix-gauge-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); }

        .vix-status { font-size: 12px; padding: 4px 12px; border-radius: 16px; font-weight: 600; display: inline-block; }
        .vix-low { background: rgba(0,230,138,0.15); color: var(--green); }
        .vix-medium { background: rgba(255,183,64,0.15); color: var(--yellow); }
        .vix-high { background: rgba(255,77,106,0.15); color: var(--red); }

        .futures-row, .fx-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .futures-price, .fx-price { font-size: 24px; font-weight: 600; }
        .futures-change, .fx-change { font-size: 16px; font-weight: 500; }

        /* ====== Chart ====== */
        .chart-container { height: 300px; }
        .time-selector { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .time-btn {
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-secondary); padding: 7px 14px; border-radius: 20px;
            font-size: 13px; font-family: inherit; cursor: pointer; transition: all 0.25s;
        }
        .time-btn:hover { background: rgba(255,255,255,0.08); border-color: var(--border-glow); }
        .time-btn.active {
            background: var(--accent); color: #000; border-color: var(--accent);
            font-weight: 600; box-shadow: 0 0 16px var(--accent-glow);
        }

        /* ====== Watchlist / Heatmap ====== */
        .watchlist-header-right { display: flex; gap: 8px; align-items: center; }
        .view-toggle {
            display: flex; background: rgba(255,255,255,0.04); border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08);
        }
        .view-toggle-btn {
            background: none; border: none; color: var(--text-muted); padding: 5px 12px;
            font-size: 12px; font-family: inherit; cursor: pointer; transition: all 0.25s;
        }
        .view-toggle-btn.active { background: var(--accent); color: #000; font-weight: 600; }
        .watchlist-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
        .watchlist-grid.heatmap-view { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 5px; }
        .watchlist-item {
            background: rgba(255,255,255,0.04); border: 1px solid var(--border-card); border-radius: 12px;
            padding: 14px; position: relative; transition: all 0.25s;
        }
        .watchlist-item:hover { border-color: var(--border-glow); filter: brightness(1.15); }
        .wl-ticker { font-size: 15px; font-weight: 700; color: var(--text-primary); letter-spacing: 0.5px; }
        .wl-name { font-size: 11px; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .wl-price { font-size: 18px; font-weight: 700; color: var(--text-primary); margin-top: 6px; }
        .wl-change { font-size: 13px; font-weight: 600; margin-top: 2px; }
        .wl-change.positive { color: var(--green); }
        .wl-change.negative { color: var(--red); }
        .wl-remove {
            position: absolute; top: 8px; right: 8px; background: none; border: none;
            color: rgba(255,255,255,0.5); cursor: pointer; font-size: 16px; line-height: 1; padding: 4px;
            opacity: 0; transition: opacity 0.2s;
        }
        .watchlist-item:hover .wl-remove, .heatmap-cell:hover .wl-remove { opacity: 1; }
        .wl-remove:hover { color: var(--red); }
        .wl-lock {
            position: absolute; top: 6px; right: 6px; font-size: 10px;
            opacity: 0; transition: opacity 0.2s; cursor: default; z-index: 2;
        }
        .watchlist-item:hover .wl-lock, .heatmap-cell:hover .wl-lock { opacity: 0.5; }
        .heatmap-cell.dragging, .watchlist-item.dragging { opacity: 0.4; transform: scale(0.95); }
        .heatmap-cell.drag-over, .watchlist-item.drag-over { outline: 2px solid var(--accent); outline-offset: -2px; }
        .heatmap-cell[draggable="false"], .watchlist-item[draggable="false"] { cursor: default; }
        .wl-loading { color: var(--text-muted); font-size: 12px; margin-top: 8px; }
        .add-ticker-btn {
            background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.2); color: var(--accent);
            padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
            cursor: pointer; font-family: inherit; transition: all 0.25s;
        }
        .add-ticker-btn:hover { background: rgba(0,212,255,0.2); border-color: var(--accent); }
        /* Heatmap cells */
        .heatmap-cell {
            border-radius: 10px; padding: 12px 8px; text-align: center; position: relative;
            border: none; transition: all 0.25s; min-height: 85px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .heatmap-cell:hover { filter: brightness(1.25); transform: scale(1.04); z-index: 2; }
        .hm-ticker { font-size: 13px; font-weight: 800; color: #fff; text-shadow: 0 1px 4px rgba(0,0,0,0.6); }
        .hm-pct { font-size: 20px; font-weight: 800; color: #fff; text-shadow: 0 1px 5px rgba(0,0,0,0.6); margin-top: 4px; line-height: 1; }
        .hm-price { font-size: 11px; color: rgba(255,255,255,0.75); margin-top: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        @media (max-width: 480px) {
            .watchlist-grid { grid-template-columns: repeat(2, 1fr); }
            .watchlist-grid.heatmap-view { grid-template-columns: repeat(3, 1fr); gap: 3px; }
            .heatmap-cell { min-height: 65px; padding: 8px 4px; }
            .hm-ticker { font-size: 11px; } .hm-pct { font-size: 16px; }
        }

        /* ====== Top Bar (QQQ / USD/JPY / NQ / VIX) ====== */
        .top-bar-card { padding: 16px 20px; }
        .top-bar {
            display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap;
        }
        .top-bar-item { text-align: center; flex: 1; min-width: 70px; }
        .top-bar-label { font-size: 11px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 4px; }
        .top-bar-price { font-size: 22px; font-weight: 800; color: var(--text-primary); line-height: 1.2; }
        .top-bar-change-row { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 3px; font-size: 13px; }
        .top-bar-divider { width: 1px; height: 50px; background: var(--border-card); flex-shrink: 0; }
        .price-details.collapsed { display: none; }
        @media (max-width: 480px) {
            .top-bar { gap: 4px; }
            .top-bar-price { font-size: 17px; }
            .top-bar-change-row { font-size: 11px; }
            .top-bar-divider { height: 40px; }
        }

        /* ====== Ticker Detail Panel ====== */
        .ticker-detail {
            margin-top: 16px; padding: 16px; border-top: 1px solid var(--border-card);
            animation: slideDown 0.25s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        .ticker-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .td-ticker { font-size: 20px; font-weight: 800; color: var(--text-primary); margin-right: 8px; }
        .td-name { font-size: 13px; color: var(--text-muted); }
        .td-price-row { display: flex; align-items: baseline; gap: 12px; margin-bottom: 14px; }
        .td-price { font-size: 24px; font-weight: 700; color: var(--text-primary); }
        .td-change { font-size: 15px; font-weight: 600; }
        .td-change.positive { color: var(--green); }
        .td-change.negative { color: var(--red); }
        .td-perf-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .td-perf-item {
            background: rgba(255,255,255,0.04); border-radius: 10px; padding: 12px 10px; text-align: center;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .td-perf-label { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; font-weight: 500; }
        .td-perf-value { font-size: 17px; font-weight: 700; }
        .td-perf-value.positive { color: var(--green); }
        .td-perf-value.negative { color: var(--red); }
        .td-perf-value.neutral { color: var(--text-muted); }
        @media (max-width: 480px) {
            .td-perf-grid { grid-template-columns: repeat(2, 1fr); }
            .td-price { font-size: 20px; }
        }

        /* ====== Settings modal ====== */
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: rgba(15, 20, 40, 0.95); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid var(--border-card); border-radius: var(--radius);
            padding: 28px; max-width: 440px; width: 90%; max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { font-size: 20px; font-weight: 700; color: var(--text-primary); }
        .close-btn {
            background: rgba(255,255,255,0.06); border: none; color: var(--text-secondary);
            width: 32px; height: 32px; border-radius: 50%; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .close-btn:hover { background: rgba(255,255,255,0.12); color: var(--text-primary); }

        .setting-group-title {
            font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 1px; margin: 20px 0 12px; padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .setting-group-title:first-of-type { margin-top: 0; }

        .setting-item { margin-bottom: 20px; }
        .setting-label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px; font-weight: 500; }
        .setting-control { display: flex; align-items: center; gap: 14px; }
        .setting-value { font-size: 15px; font-weight: 600; color: var(--accent); min-width: 50px; }

        input[type="range"] {
            flex: 1; -webkit-appearance: none; height: 4px;
            background: rgba(255,255,255,0.1); border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px;
            background: var(--accent); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        input[type="number"] {
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-primary); padding: 6px 10px; border-radius: 8px;
            font-family: inherit; font-size: 14px; font-weight: 600; width: 64px;
            text-align: center; outline: none;
        }
        input[type="number"]:focus { border-color: var(--accent); }
        input[type="number"]::-webkit-inner-spin-button { opacity: 1; }

        .toggle { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; inset: 0; background: rgba(255,255,255,0.1);
            border-radius: 12px; cursor: pointer; transition: background 0.3s;
        }
        .toggle-slider::before {
            content: ''; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px;
            background: #fff; border-radius: 50%; transition: transform 0.3s;
        }
        .toggle input:checked + .toggle-slider { background: var(--accent); }
        .toggle input:checked + .toggle-slider::before { transform: translateX(20px); }

        /* Debug panel */
        .debug-panel {
            display: none; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-card); border-radius: var(--radius-sm);
            padding: 14px; margin: 0 20px 20px; font-family: 'SF Mono', Menlo, monospace;
            font-size: 11px; color: var(--green); max-height: 250px; overflow-y: auto;
            position: relative; z-index: 1;
        }

        /* ====== Market Alert Banner ====== */
        .market-alert-banner {
            margin: 0 0 16px; padding: 12px 16px;
            border-radius: var(--radius-sm);
            backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
            border: 1px solid rgba(255, 77, 106, 0.3);
            background: rgba(255, 77, 106, 0.08);
            position: relative; z-index: 1;
            animation: alertPulse 3s ease-in-out infinite;
        }
        .market-alert-banner.alert-mixed {
            border-color: rgba(255, 183, 64, 0.3);
            background: rgba(255, 183, 64, 0.08);
        }
        .alert-header {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--red);
        }
        .market-alert-banner.alert-mixed .alert-header { color: var(--yellow); }
        .alert-items { display: flex; flex-wrap: wrap; gap: 6px; }
        .alert-chip {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 5px 10px; border-radius: 6px;
            font-size: 12px; font-weight: 600; white-space: nowrap;
        }
        .alert-chip.bearish { background: rgba(255, 77, 106, 0.15); color: var(--red); }
        .alert-chip.bullish { background: rgba(0, 230, 138, 0.15); color: var(--green); }
        .alert-chip.warning { background: rgba(255, 183, 64, 0.15); color: var(--yellow); }
        @keyframes alertPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        /* ====== News Section ====== */
        .news-section { display: flex; flex-direction: column; gap: 2px; }
        .news-item {
            display: flex; gap: 12px; padding: 12px; border-radius: 8px;
            transition: background 0.2s; cursor: pointer;
            text-decoration: none; color: inherit;
        }
        .news-item:hover { background: rgba(255, 255, 255, 0.05); }
        .news-icon {
            flex-shrink: 0; width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; background: rgba(255, 255, 255, 0.06);
        }
        .news-content { flex: 1; min-width: 0; }
        .news-title {
            font-size: 13px; font-weight: 500; line-height: 1.4;
            color: var(--text-primary);
            display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden;
        }
        .news-meta {
            display: flex; align-items: center; gap: 8px;
            margin-top: 4px; font-size: 11px; color: var(--text-muted);
        }
        .news-ticker-badge {
            display: inline-block; padding: 1px 6px; border-radius: 4px;
            background: rgba(0, 212, 255, 0.15); color: var(--accent);
            font-size: 10px; font-weight: 600;
        }
        .news-empty {
            text-align: center; padding: 24px;
            color: var(--text-muted); font-size: 13px;
        }
        .news-tabs { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; }
        .news-tab {
            padding: 5px 12px; border-radius: 6px;
            border: 1px solid var(--border-card); background: transparent;
            color: var(--text-secondary); font-size: 12px; font-weight: 500;
            cursor: pointer; font-family: Inter, sans-serif; transition: all 0.2s;
        }
        .news-tab:hover { border-color: var(--accent); color: var(--text-primary); }
        .news-tab.active { background: rgba(0, 212, 255, 0.12); border-color: var(--accent); color: var(--accent); }

        /* ====== Fear & Greed ====== */
        .fg-container { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .fg-score { font-size: 40px; font-weight: 800; margin-top: -4px; }
        .fg-label { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .fg-details {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;
            width: 100%; margin-top: 14px;
        }
        .fg-detail {
            display: flex; flex-direction: column; gap: 4px;
            padding: 8px 10px; border-radius: 8px; background: rgba(255,255,255,0.04);
        }
        .fg-detail-top { display: flex; justify-content: space-between; font-size: 11px; }
        .fg-detail-name { color: var(--text-muted); }
        .fg-detail-val { font-weight: 600; }
        .fg-detail-bar { height: 3px; border-radius: 2px; background: rgba(255,255,255,0.1); overflow: hidden; }
        .fg-detail-fill { height: 100%; border-radius: 2px; transition: width 0.8s ease; }

        /* ====== Simulator ====== */
        .sim-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .sim-input-row { display: flex; align-items: center; gap: 6px; }
        .sim-input-row input[type="number"] {
            width: 110px; padding: 7px 10px; background: rgba(255,255,255,0.06);
            border: 1px solid var(--border-card); border-radius: 8px;
            color: #fff; font-size: 14px; font-family: Inter, sans-serif; text-align: right;
        }
        .sim-input-row span { color: var(--text-secondary); font-size: 12px; }
        .sim-period-tabs { display: flex; gap: 4px; }
        .sim-period-tab {
            padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border-card);
            background: transparent; color: var(--text-secondary); font-size: 12px;
            font-weight: 500; cursor: pointer; font-family: Inter, sans-serif; transition: all 0.2s;
        }
        .sim-period-tab.active { background: rgba(0,212,255,0.12); border-color: var(--accent); color: var(--accent); }
        .sim-table { width: 100%; border-collapse: collapse; }
        .sim-table th {
            text-align: left; padding: 6px 8px; font-size: 10px; color: var(--text-muted);
            font-weight: 500; border-bottom: 1px solid var(--border-card);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .sim-table th:not(:first-child) { text-align: right; }
        .sim-table td { padding: 8px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .sim-table td:not(:first-child) { text-align: right; font-variant-numeric: tabular-nums; }
        .sim-etf { font-weight: 700; }
        .sim-etf-sub { font-size: 10px; color: var(--text-muted); font-weight: 400; }
        .sim-note { font-size: 11px; color: var(--text-muted); margin-top: 10px; }

        /* ====== Earnings Calendar ====== */
        .earnings-list { display: flex; flex-direction: column; gap: 2px; }
        .earnings-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 12px; border-radius: 8px; transition: background 0.2s;
        }
        .earnings-item:hover { background: rgba(255,255,255,0.04); }
        .earnings-badge {
            flex-shrink: 0; width: 44px; height: 44px; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.06);
        }
        .earnings-badge-month { font-size: 9px; font-weight: 600; color: var(--accent); text-transform: uppercase; }
        .earnings-badge-day { font-size: 17px; font-weight: 800; line-height: 1.1; }
        .earnings-info { flex: 1; min-width: 0; }
        .earnings-ticker { font-size: 14px; font-weight: 700; }
        .earnings-name { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .earnings-est { font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
        .earnings-countdown { flex-shrink: 0; text-align: right; }
        .earnings-days { font-size: 15px; font-weight: 700; }
        .earnings-days-sub { font-size: 10px; color: var(--text-muted); }
        .earnings-today { color: var(--red); }
        .earnings-soon { color: var(--yellow); }

        /* ====== Collapsible sections ====== */
        .section-toggle { cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between; }
        .section-toggle .toggle-arrow { font-size: 12px; color: var(--text-muted); transition: transform 0.3s; }
        .section-toggle.collapsed .toggle-arrow { transform: rotate(-90deg); }
        .section-body { overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease; max-height: 2000px; opacity: 1; }
        .section-body.hidden { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; }

        /* ====== Responsive ====== */
        @media (min-width: 768px) {
            .price-details { grid-template-columns: repeat(4, 1fr); }
            .main-content { padding: 24px 32px; }
            .market-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (min-width: 1024px) {
            .main-content { padding: 28px 40px; }
            .indicator-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .current-price { font-size: 38px; }
            .change-amount { font-size: 18px; }
            .change-percent { font-size: 14px; }
            .glass-card { padding: 18px; }
            .main-content { padding: 14px; }
            .toast { min-width: 260px; max-width: calc(100vw - 40px); }
            .score-ring { width: 64px; height: 64px; }
            .score-number { font-size: 18px; }
            .scoreboard { gap: 12px; }
            .sim-table { font-size: 11px; }
            .sim-table th, .sim-table td { padding: 6px 4px; }
            .fg-details { grid-template-columns: 1fr 1fr; }
            .earnings-badge { width: 38px; height: 38px; }
            .earnings-badge-day { font-size: 14px; }
        }
    </style>
</head>
<body class="mood-calm">
    <div class="toast-container" id="toastContainer"></div>
    <div class="demo-banner" id="demoBanner">Demo Mode - displaying sample data</div>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>QQQ Pro Tracker</h1>
            <span class="last-updated" id="lastUpdated"></span>
            <span class="mood-label mood-label-calm" id="moodLabel">CALM</span>
        </div>
        <div class="header-right">
            <button class="settings-btn" onclick="app.openSettings()">Settings</button>
        </div>
    </div>

    <div class="main-content">
        <div class="market-status" id="marketStatus">Checking market status...</div>

        <!-- Market Alert Banner -->
        <div id="marketAlertBanner" class="market-alert-banner" style="display:none"></div>

        <!-- Watchlist / Heatmap (TOP) -->
        <div class="glass-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
                <h2 class="section-title" style="margin:0">Watchlist</h2>
                <div class="watchlist-header-right">
                    <div class="view-toggle">
                        <button class="view-toggle-btn" data-view="list" onclick="app.setWatchlistView('list')">List</button>
                        <button class="view-toggle-btn active" data-view="heatmap" onclick="app.setWatchlistView('heatmap')">Heatmap</button>
                    </div>
                    <button class="add-ticker-btn" onclick="app.openAddTicker()">+ Add</button>
                </div>
            </div>
            <div id="watchlistGrid" class="watchlist-grid heatmap-view">
                <div class="skeleton" style="height:85px;border-radius:10px"></div>
                <div class="skeleton" style="height:85px;border-radius:10px"></div>
                <div class="skeleton" style="height:85px;border-radius:10px"></div>
                <div class="skeleton" style="height:85px;border-radius:10px"></div>
            </div>
            <!-- Crypto Heatmap (separate section) -->
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border-card)">
                <h2 class="section-title" style="margin:0 0 12px 0">
                    <span style="font-size:16px">â‚¿</span> Crypto
                </h2>
                <div id="cryptoGrid" class="watchlist-grid heatmap-view" style="grid-template-columns:repeat(3,1fr)">
                    <div class="skeleton" style="height:85px;border-radius:10px"></div>
                    <div class="skeleton" style="height:85px;border-radius:10px"></div>
                    <div class="skeleton" style="height:85px;border-radius:10px"></div>
                </div>
            </div>

            <!-- Ticker detail panel (shown on click) -->
            <div class="ticker-detail" id="tickerDetail" style="display:none">
                <div class="ticker-detail-header">
                    <div>
                        <span class="td-ticker" id="tdTicker"></span>
                        <span class="td-name" id="tdName"></span>
                    </div>
                    <button class="close-btn" onclick="app.closeTickerDetail()" style="font-size:20px">&times;</button>
                </div>
                <div class="td-price-row">
                    <span class="td-price" id="tdPrice"></span>
                    <span class="td-change" id="tdChange"></span>
                </div>
                <div class="td-perf-grid" id="tdPerfGrid">
                    <div class="td-perf-item"><div class="td-perf-label">1 Week</div><div class="td-perf-value" id="tdPerf1w"><span class="skeleton skeleton-text" style="width:60px"></span></div></div>
                    <div class="td-perf-item"><div class="td-perf-label">1 Month</div><div class="td-perf-value" id="tdPerf1m"><span class="skeleton skeleton-text" style="width:60px"></span></div></div>
                    <div class="td-perf-item"><div class="td-perf-label">YTD</div><div class="td-perf-value" id="tdPerfYtd"><span class="skeleton skeleton-text" style="width:60px"></span></div></div>
                    <div class="td-perf-item"><div class="td-perf-label">1 Year</div><div class="td-perf-value" id="tdPerf1y"><span class="skeleton skeleton-text" style="width:60px"></span></div></div>
                </div>
            </div>
        </div>

        <!-- QQQ + USD/JPY quick bar -->
        <div class="glass-card top-bar-card">
            <div class="top-bar">
                <div class="top-bar-item">
                    <div class="top-bar-label">QQQ</div>
                    <div class="top-bar-price" id="currentPrice"><span class="skeleton skeleton-text" style="width:80px"></span></div>
                    <div class="top-bar-change-row">
                        <span class="change-amount" id="changeAmount"><span class="skeleton skeleton-text" style="width:50px"></span></span>
                        <span class="change-percent" id="changePercent"><span class="skeleton skeleton-text" style="width:50px"></span></span>
                    </div>
                </div>
                <div class="top-bar-divider"></div>
                <div class="top-bar-item">
                    <div class="top-bar-label">USD/JPY</div>
                    <div class="top-bar-price" id="fxPrice"><span class="skeleton skeleton-text" style="width:70px"></span></div>
                    <div class="top-bar-change-row">
                        <span class="fx-change" id="fxChange"></span>
                    </div>
                </div>
                <div class="top-bar-divider"></div>
                <div class="top-bar-item">
                    <div class="top-bar-label">NQ Futures</div>
                    <div class="top-bar-price" id="futuresPrice"><span class="skeleton skeleton-text" style="width:80px"></span></div>
                    <div class="top-bar-change-row">
                        <span class="futures-change" id="futuresChange"></span>
                    </div>
                </div>
                <div class="top-bar-divider"></div>
                <div class="top-bar-item">
                    <div class="top-bar-label">VIX</div>
                    <div class="top-bar-price" id="vixValue"><span class="skeleton skeleton-text" style="width:50px"></span></div>
                    <div class="top-bar-change-row">
                        <span class="vix-change" id="vixChange"></span>
                        <span class="vix-status" id="vixStatus" style="font-size:11px"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Price details (collapsible) -->
        <div class="glass-card">
            <h2 class="section-title" style="cursor:pointer" onclick="this.parentElement.querySelector('.price-details').classList.toggle('collapsed')">QQQ Details <span style="font-size:12px;color:var(--text-muted)">&#9660;</span></h2>
            <div class="price-details">
                <div class="detail-item"><div class="detail-label">Prev Close</div><div class="detail-value" id="prevClose"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">Volume</div><div class="detail-value" id="volume"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">Day High</div><div class="detail-value" id="dayHigh"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">Day Low</div><div class="detail-value" id="dayLow"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">52W High</div><div class="detail-value" id="week52High"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">52W Low</div><div class="detail-value" id="week52Low"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">5Y High</div><div class="detail-value" id="year5High"><span class="skeleton skeleton-text"></span></div></div>
                <div class="detail-item"><div class="detail-label">5Y Diff</div><div class="detail-value" id="year5Diff"><span class="skeleton skeleton-text"></span></div></div>
            </div>
        </div>

        <!-- Indicators -->
        <div class="glass-card">
            <h2 class="section-title">Investment Indicators</h2>
            <div class="indicator-grid">
                <div class="indicator-item ma-200"><span class="indicator-label">200-Day MA</span><span class="indicator-value" id="ma200"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item ma-dev"><span class="indicator-label">200MA Deviation</span><span class="indicator-value" id="maDev"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item level-12"><span class="indicator-label" id="level12Label">-12% Level</span><span class="indicator-value" id="level12"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item level-18"><span class="indicator-label" id="level18Label">-18% Level</span><span class="indicator-value" id="level18"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item week-open"><span class="indicator-label">Week Open</span><span class="indicator-value" id="weekOpen"><span class="skeleton skeleton-text"></span></span></div>
                <div class="indicator-item rule-5"><span class="indicator-label" id="rule5Label">-5% Rule</span><span class="indicator-value" id="rule5"><span class="skeleton skeleton-text"></span></span></div>
            </div>
        </div>

        <!-- VIX gauge -->
        <div class="glass-card">
            <h2 class="section-title">VIX Gauge</h2>
            <div class="vix-gauge"><div class="vix-gauge-fill" id="vixGauge" style="width:0%"></div></div>
            <div class="vix-gauge-labels"><span>0</span><span>20</span><span>30</span><span>40+</span></div>
        </div>

        <!-- Fear & Greed Index -->
        <div class="glass-card">
            <h2 class="section-title">Fear & Greed Index</h2>
            <div class="fg-container">
                <svg viewBox="0 0 200 115" width="200" height="115">
                    <defs>
                        <linearGradient id="fgGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#ff4d6a"/><stop offset="25%" stop-color="#ff8c42"/>
                            <stop offset="50%" stop-color="#ffb740"/><stop offset="75%" stop-color="#88cc44"/>
                            <stop offset="100%" stop-color="#00e68a"/>
                        </linearGradient>
                    </defs>
                    <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="14" stroke-linecap="round"/>
                    <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="url(#fgGrad)" stroke-width="14" stroke-linecap="round"/>
                    <line id="fgNeedle" x1="100" y1="100" x2="100" y2="28" stroke="white" stroke-width="2.5" stroke-linecap="round" transform="rotate(-90,100,100)"/>
                    <circle cx="100" cy="100" r="4" fill="white"/>
                </svg>
                <div class="fg-score" id="fgScore">--</div>
                <div class="fg-label" id="fgLabel">Calculating...</div>
                <div class="fg-details" id="fgDetails"></div>
            </div>
        </div>

        <!-- ====== Signal Scoreboard ====== -->
        <div class="glass-card">
            <h2 class="section-title">Buy Signal Scoreboard</h2>
            <div class="scoreboard">
                <div class="score-ring-wrap">
                    <div class="score-ring">
                        <svg viewBox="0 0 80 80" width="80" height="80">
                            <circle class="score-ring-bg" cx="40" cy="40" r="34"/>
                            <circle class="score-ring-fill" id="scoreRing" cx="40" cy="40" r="34"
                                stroke-dasharray="213.6" stroke-dashoffset="213.6"/>
                        </svg>
                        <div class="score-number" id="scoreNumber">0/6</div>
                    </div>
                    <div>
                        <div class="score-label">Signal Strength</div>
                        <div class="score-desc" id="scoreDesc">Waiting...</div>
                    </div>
                </div>
                <div class="signal-pills" id="signalPills"></div>
            </div>
        </div>

        <!-- Chart -->
        <div class="glass-card">
            <h2 class="section-title">Price Chart</h2>
            <div class="time-selector" id="timeSelector">
                <button class="time-btn active" data-period="1d">1D</button>
                <button class="time-btn" data-period="5d">5D</button>
                <button class="time-btn" data-period="1mo">1M</button>
                <button class="time-btn" data-period="3mo">3M</button>
                <button class="time-btn" data-period="6mo">6M</button>
                <button class="time-btn" data-period="1y">1Y</button>
            </div>
            <div class="chart-container" id="chartContainer"><canvas id="priceChart"></canvas></div>
        </div>

        <!-- DCA Simulator -->
        <div class="glass-card">
            <h2 class="section-toggle" onclick="app.toggleSection('simBody')">
                ç©ç«‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ <span class="toggle-arrow">â–¼</span>
            </h2>
            <div class="section-body" id="simBody">
                <div class="sim-controls">
                    <div class="sim-input-row">
                        <span>æœˆé¡</span>
                        <input type="number" id="simAmount" value="100000" min="1000" step="10000">
                        <span>å††</span>
                    </div>
                    <div class="sim-period-tabs">
                        <button class="sim-period-tab active" data-period="1" onclick="app.setSimPeriod(1)">1Y</button>
                        <button class="sim-period-tab" data-period="3" onclick="app.setSimPeriod(3)">3Y</button>
                        <button class="sim-period-tab" data-period="5" onclick="app.setSimPeriod(5)">5Y</button>
                    </div>
                </div>
                <div id="simResults"><div class="news-empty">Loading historical data...</div></div>
                <div class="sim-note">â€» éŽåŽ»å®Ÿç¸¾ã«åŸºã¥ãè©¦ç®—ã§ã™ã€‚å°†æ¥ã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
            </div>
        </div>

        <!-- Earnings Calendar -->
        <div class="glass-card">
            <h2 class="section-toggle" onclick="app.toggleSection('earningsBody')">
                æ±ºç®—ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ <span class="toggle-arrow">â–¼</span>
            </h2>
            <div class="section-body" id="earningsBody">
                <div id="earningsCalendar" class="earnings-list">
                    <div class="news-empty">Loading earnings dates...</div>
                </div>
            </div>
        </div>

        <!-- Market News -->
        <div class="glass-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <h2 class="section-title" style="margin:0">Market News</h2>
            </div>
            <div class="news-tabs" id="newsTabs">
                <button class="news-tab active" data-ticker="all" onclick="app.filterNews('all')">All</button>
                <button class="news-tab" data-ticker="QQQ" onclick="app.filterNews('QQQ')">QQQ</button>
            </div>
            <div id="newsContainer" class="news-section">
                <div class="news-empty">Loading news...</div>
            </div>
        </div>

        <!-- Add ticker modal -->
        <div class="modal" id="addTickerModal">
            <div class="modal-content" style="max-width:380px">
                <div class="modal-header">
                    <h2>Add Ticker</h2>
                    <button class="close-btn" onclick="app.closeAddTicker()">&times;</button>
                </div>
                <div style="padding:0 0 8px">
                    <input type="text" id="tickerInput" placeholder="e.g. AAPL, 7203.T, TSLA" style="width:100%;padding:12px 14px;background:rgba(255,255,255,0.06);border:1px solid var(--border-card);border-radius:8px;color:#fff;font-size:15px;font-family:Inter,sans-serif;outline:none" autocomplete="off" spellcheck="false">
                    <div id="tickerError" style="color:var(--red);font-size:12px;margin-top:6px;display:none"></div>
                    <button id="addTickerConfirm" onclick="app.addTicker()" style="width:100%;margin-top:12px;padding:12px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;font-family:Inter,sans-serif">Add to Watchlist</button>
                </div>
            </div>
        </div>
    </div>

    <div class="debug-panel" id="debugPanel"></div>

    <!-- Settings modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="app.closeSettings()">&times;</button>
            </div>

            <div class="setting-group-title">General</div>
            <div class="setting-item">
                <label class="setting-label">Refresh Interval</label>
                <div class="setting-control">
                    <input type="range" id="refreshInterval" min="5" max="60" value="15" step="5">
                    <span class="setting-value" id="refreshValue">15s</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Sound Alerts</label>
                <div class="setting-control">
                    <label class="toggle"><input type="checkbox" id="soundEnabled" checked><span class="toggle-slider"></span></label>
                    <span style="color:var(--text-secondary);font-size:13px" id="soundLabel">Enabled</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Browser Notifications</label>
                <div class="setting-control">
                    <label class="toggle"><input type="checkbox" id="notificationEnabled"><span class="toggle-slider"></span></label>
                    <span style="color:var(--text-secondary);font-size:13px" id="notifLabel">Disabled</span>
                </div>
            </div>

            <div class="setting-group-title">Alert Thresholds</div>
            <div class="setting-item">
                <label class="setting-label">Drop Level 1 (%)</label>
                <div class="setting-control">
                    <input type="number" id="thresholdLevel1" value="12" min="1" max="50" step="1">
                    <span style="color:var(--text-muted);font-size:13px">Default: 12%</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Drop Level 2 (%)</label>
                <div class="setting-control">
                    <input type="number" id="thresholdLevel2" value="18" min="1" max="50" step="1">
                    <span style="color:var(--text-muted);font-size:13px">Default: 18%</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Weekly Drop Rule (%)</label>
                <div class="setting-control">
                    <input type="number" id="thresholdWeekly" value="5" min="1" max="30" step="0.5">
                    <span style="color:var(--text-muted);font-size:13px">Default: 5%</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">VIX High Threshold</label>
                <div class="setting-control">
                    <input type="number" id="thresholdVixHigh" value="30" min="15" max="80" step="1">
                    <span style="color:var(--text-muted);font-size:13px">Default: 30</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">VIX Extreme Threshold</label>
                <div class="setting-control">
                    <input type="number" id="thresholdVixExtreme" value="35" min="20" max="90" step="1">
                    <span style="color:var(--text-muted);font-size:13px">Default: 35</span>
                </div>
            </div>

            <div class="setting-group-title">Advanced</div>
            <div class="setting-item">
                <label class="setting-label">Debug Mode</label>
                <div class="setting-control">
                    <label class="toggle"><input type="checkbox" id="debugMode"><span class="toggle-slider"></span></label>
                    <span style="color:var(--text-secondary);font-size:13px" id="debugLabel">Off</span>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">Demo Mode</label>
                <div class="setting-control">
                    <label class="toggle"><input type="checkbox" id="demoMode"><span class="toggle-slider"></span></label>
                    <span style="color:var(--text-secondary);font-size:13px" id="demoLabel">Auto-fallback on API error</span>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ======== CacheManager ========
    const CacheManager = {
        get(key) {
            try {
                const raw = localStorage.getItem(`qqq_${key}`);
                if (!raw) return null;
                const { data, expiry } = JSON.parse(raw);
                if (Date.now() > expiry) { localStorage.removeItem(`qqq_${key}`); return null; }
                return data;
            } catch { return null; }
        },
        set(key, data, ttlMs) {
            try { localStorage.setItem(`qqq_${key}`, JSON.stringify({ data, expiry: Date.now() + ttlMs })); } catch {}
        }
    };

    // ======== ToastManager ========
    const ToastManager = {
        container: null,
        init() { this.container = document.getElementById('toastContainer'); },
        show(msg, type = 'info', dur = 5000) {
            const t = document.createElement('div');
            t.className = `toast toast-${type}`;
            t.textContent = msg;
            this.container.appendChild(t);
            requestAnimationFrame(() => requestAnimationFrame(() => t.classList.add('show')));
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, dur);
        }
    };

    // ======== NumberAnimator ========
    const NumberAnimator = {
        animate(el, target, prefix = '$', dec = 2, dur = 600) {
            const cur = parseFloat(el.textContent.replace(/[^0-9.-]/g, '')) || 0;
            if (Math.abs(cur - target) < 0.001) { el.textContent = prefix + target.toFixed(dec); return; }
            const t0 = performance.now();
            const step = (now) => {
                const p = Math.min((now - t0) / dur, 1);
                const e = 1 - Math.pow(1 - p, 3);
                el.textContent = prefix + (cur + (target - cur) * e).toFixed(dec);
                if (p < 1) requestAnimationFrame(step);
            };
            requestAnimationFrame(step);
        }
    };

    // ======== DOMCache ========
    const DOMCache = {};
    function $(id) { if (!DOMCache[id]) DOMCache[id] = document.getElementById(id); return DOMCache[id]; }

    // ======== Main App ========
    const app = {
        settings: {
            refreshInterval: 15, soundEnabled: true, notificationEnabled: false,
            debugMode: false, demoMode: false,
            thresholdLevel1: 12, thresholdLevel2: 18, thresholdWeekly: 5,
            thresholdVixHigh: 30, thresholdVixExtreme: 35
        },

        data: {
            currentPrice: null, previousClose: null,
            dayHigh: null, dayLow: null,
            week52High: null, week52Low: null,
            volume: null, ma200: null, weekOpen: null,
            vix: null, nqFutures: null, year5High: null,
            usdjpy: null
        },

        alertsTriggered: { level12: false, level18: false, ma200: false, rule5: false, vix30: false, vix35: false },
        newsData: [],
        newsFilter: 'all',
        spikeAlerts: [],
        fearGreedScore: null,
        simData: {}, simPeriod: 1,
        earningsData: [],
        currentMood: 'calm',
        chart: null, chartPeriod: '1d', refreshTimer: null,

        // Watchlist
        mag7: ['AAPL', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'META', 'TSLA'],
        defaultTickers: ['AAPL', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'META', 'TSLA', 'AVGO'],
        watchlist: [],
        watchlistData: {},
        watchlistView: 'heatmap', // 'list' or 'heatmap'

        // Crypto
        cryptoTickers: [
            { symbol: 'BTC-USD', label: 'BTC', name: 'Bitcoin' },
            { symbol: 'ETH-USD', label: 'ETH', name: 'Ethereum' },
            { symbol: 'XRP-USD', label: 'XRP', name: 'XRP' }
        ],
        cryptoData: {},

        // Detect if running on Vercel (or any http server) vs local file
        isHosted: location.protocol === 'https:' || (location.protocol === 'http:' && location.hostname !== ''),
        corsProxies: [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://thingproxy.freeboard.io/fetch/'
        ],
        currentProxyIndex: 0,

        init() {
            this.log('QQQ Pro Tracker initializing');
            this.loadSettings();
            ToastManager.init();
            this.setupEventListeners();
            if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
            this.loadWatchlist();
            this.fetchData();
            this.startAutoRefresh();
            this.initChart();
            this.fetchChartData();
            this.fetchWatchlistData();
            this.fetchCryptoData();
            this.fetchNews();
            this.fetchSimulatorData();
            this.fetchEarningsCalendar();
            this.updateMarketStatus();
            // PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            }
            this.log('Initialization complete');
        },

        // ---- Settings persistence ----
        loadSettings() {
            try {
                const saved = localStorage.getItem('qqq_settings');
                if (saved) Object.assign(this.settings, JSON.parse(saved));
            } catch {}
            // Apply to DOM
            $('refreshInterval').value = this.settings.refreshInterval;
            $('refreshValue').textContent = `${this.settings.refreshInterval}s`;
            $('soundEnabled').checked = this.settings.soundEnabled;
            $('notificationEnabled').checked = this.settings.notificationEnabled;
            $('debugMode').checked = this.settings.debugMode;
            $('demoMode').checked = this.settings.demoMode;
            $('thresholdLevel1').value = this.settings.thresholdLevel1;
            $('thresholdLevel2').value = this.settings.thresholdLevel2;
            $('thresholdWeekly').value = this.settings.thresholdWeekly;
            $('thresholdVixHigh').value = this.settings.thresholdVixHigh;
            $('thresholdVixExtreme').value = this.settings.thresholdVixExtreme;
            if (this.settings.debugMode) $('debugPanel').style.display = 'block';
            if (this.settings.demoMode) $('demoBanner').classList.add('show');
            this.updateThresholdLabels();
        },

        saveSettings() {
            try { localStorage.setItem('qqq_settings', JSON.stringify(this.settings)); } catch {}
        },

        updateThresholdLabels() {
            $('level12Label').textContent = `-${this.settings.thresholdLevel1}% Level`;
            $('level18Label').textContent = `-${this.settings.thresholdLevel2}% Level`;
            $('rule5Label').textContent = `-${this.settings.thresholdWeekly}% Rule`;
        },

        // ---- Events ----
        setupEventListeners() {
            $('refreshInterval').addEventListener('input', (e) => {
                this.settings.refreshInterval = parseInt(e.target.value);
                $('refreshValue').textContent = `${e.target.value}s`;
                this.startAutoRefresh(); this.saveSettings();
            });

            const toggleHandler = (id, key, labelId) => {
                $(id).addEventListener('change', (e) => {
                    this.settings[key] = e.target.checked;
                    if (labelId) $(labelId).textContent = e.target.checked ? 'Enabled' : 'Disabled';
                    this.saveSettings();
                });
            };
            toggleHandler('soundEnabled', 'soundEnabled', 'soundLabel');
            toggleHandler('notificationEnabled', 'notificationEnabled', 'notifLabel');

            $('notificationEnabled').addEventListener('change', (e) => {
                if (e.target.checked && Notification.permission === 'default') Notification.requestPermission();
            });

            $('debugMode').addEventListener('change', (e) => {
                this.settings.debugMode = e.target.checked;
                $('debugPanel').style.display = e.target.checked ? 'block' : 'none';
                $('debugLabel').textContent = e.target.checked ? 'On' : 'Off';
                this.saveSettings();
            });

            $('demoMode').addEventListener('change', (e) => {
                this.settings.demoMode = e.target.checked;
                $('demoBanner').classList.toggle('show', e.target.checked);
                $('demoLabel').textContent = e.target.checked ? 'Active' : 'Auto-fallback on API error';
                if (e.target.checked) this.useDemoData(); else this.fetchData();
                this.saveSettings();
            });

            // Threshold inputs
            ['thresholdLevel1','thresholdLevel2','thresholdWeekly','thresholdVixHigh','thresholdVixExtreme'].forEach(id => {
                $(id).addEventListener('change', (e) => {
                    this.settings[id] = parseFloat(e.target.value);
                    this.updateThresholdLabels();
                    this.saveSettings();
                    if (this.data.currentPrice) { this.updateUI(); this.checkAlerts(); this.updateScoreboard(); }
                });
            });

            $('tickerInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') app.addTicker(); });
            $('simAmount').addEventListener('change', () => app.renderSimulator());

            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    this.chartPeriod = e.target.dataset.period;
                    this.fetchChartData();
                });
            });
        },

        // ---- Parallel data fetch ----
        async fetchData() {
            this.log('Fetching data (parallel)');
            try {
                const [qqqData, vixData, nqData, fxData] = await Promise.all([
                    this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/QQQ'),
                    this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/^VIX'),
                    this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/NQ=F'),
                    this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/JPY=X')
                ]);

                if (qqqData?.chart?.result?.[0]) {
                    const r = qqqData.chart.result[0], q = r.indicators.quote[0], m = r.meta;
                    this.data.currentPrice = m.regularMarketPrice;
                    this.data.previousClose = m.previousClose;
                    this.data.dayHigh = m.regularMarketDayHigh;
                    this.data.dayLow = m.regularMarketDayLow;
                    this.data.volume = q.volume?.[q.volume.length - 1];
                    this.data.week52High = m.fiftyTwoWeekHigh;
                    this.data.week52Low = m.fiftyTwoWeekLow;
                    this.updateUI();
                }

                if (vixData?.chart?.result?.[0]) {
                    const m = vixData.chart.result[0].meta;
                    this.data.vix = {
                        value: m.regularMarketPrice,
                        change: m.regularMarketPrice - m.previousClose,
                        changePercent: ((m.regularMarketPrice - m.previousClose) / m.previousClose) * 100
                    };
                    this.updateVIX();
                }

                if (nqData?.chart?.result?.[0]) {
                    const m = nqData.chart.result[0].meta;
                    this.data.nqFutures = {
                        price: m.regularMarketPrice,
                        change: m.regularMarketPrice - m.previousClose,
                        changePercent: ((m.regularMarketPrice - m.previousClose) / m.previousClose) * 100
                    };
                    this.updateNQFutures();
                }

                if (fxData?.chart?.result?.[0]) {
                    const m = fxData.chart.result[0].meta;
                    this.data.usdjpy = {
                        rate: m.regularMarketPrice,
                        change: m.regularMarketPrice - m.previousClose,
                        changePercent: ((m.regularMarketPrice - m.previousClose) / m.previousClose) * 100
                    };
                    this.updateUSDJPY();
                }

                await Promise.all([this.calculate200MA(), this.fetchWeekOpen(), this.fetch5YearHigh()]);

                this.checkAlerts();
                this.updateMarketStatus();
                this.updateLastUpdated();
                this.updateScoreboard();
                this.updateMood();
                this.detectMarketAlerts();
                this.updateFearGreed();

            } catch (error) {
                this.log(`Error: ${error.message}`, 'error');
                ToastManager.show(`Data fetch failed: ${error.message}`, 'error');
                if (!this.settings.demoMode) {
                    this.settings.demoMode = true;
                    $('demoMode').checked = true;
                    $('demoBanner').classList.add('show');
                    this.useDemoData();
                    this.saveSettings();
                }
            }
        },

        updateLastUpdated() {
            $('lastUpdated').textContent = `Updated ${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;
        },

        async fetchWithProxy(url) {
            // 1) Try Vercel self-hosted proxy first (when deployed)
            if (this.isHosted) {
                try {
                    const proxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
                    this.log('Using Vercel proxy');
                    const res = await fetch(proxyUrl);
                    if (res.ok) {
                        const data = await res.json();
                        if (data?.chart) return data;
                    }
                } catch (e) {
                    this.log(`Vercel proxy failed: ${e.message}`, 'warn');
                }
            }

            // 2) Try direct fetch (works in some environments / extensions)
            try {
                this.log('Trying direct fetch');
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (res.ok) return await res.json();
            } catch {}

            // 3) Fallback to public CORS proxies
            let retries = 0;
            while (retries < this.corsProxies.length) {
                const proxy = this.corsProxies[this.currentProxyIndex];
                try {
                    this.log(`Proxy: ${proxy}`);
                    const res = await fetch(proxy + encodeURIComponent(url));
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    if (data?.chart || data?.meta) return data;
                    throw new Error('Invalid response');
                } catch (e) {
                    this.log(`Proxy failed: ${e.message}`, 'error');
                    this.currentProxyIndex = (this.currentProxyIndex + 1) % this.corsProxies.length;
                    retries++;
                }
            }
            throw new Error('All fetch methods failed');
        },

        // ---- 200MA (cached 24h) ----
        async calculate200MA() {
            const cached = CacheManager.get('ma200');
            if (cached) { this.data.ma200 = cached; NumberAnimator.animate($('ma200'), cached); this.updateMADev(); return; }
            try {
                this.log('Calculating 200MA');
                const end = Math.floor(Date.now() / 1000), start = end - 300 * 86400;
                const data = await this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/QQQ?period1=${start}&period2=${end}&interval=1d`);
                if (data?.chart?.result?.[0]) {
                    const closes = data.chart.result[0].indicators.quote[0].close.filter(c => c !== null);
                    const last200 = closes.slice(-200);
                    if (last200.length >= 200) {
                        this.data.ma200 = last200.reduce((a, b) => a + b, 0) / 200;
                        CacheManager.set('ma200', this.data.ma200, 86400000);
                        NumberAnimator.animate($('ma200'), this.data.ma200);
                        this.updateMADev();
                    }
                }
            } catch (e) { this.log(`200MA error: ${e.message}`, 'error'); }
        },

        updateMADev() {
            if (this.data.currentPrice && this.data.ma200) {
                const dev = ((this.data.currentPrice - this.data.ma200) / this.data.ma200) * 100;
                const el = $('maDev');
                el.textContent = `${dev >= 0 ? '+' : ''}${dev.toFixed(2)}%`;
                el.className = dev < 0 ? 'indicator-value negative' : 'indicator-value positive';
            }
        },

        // ---- Week open (cached to Sunday) ----
        async fetchWeekOpen() {
            const cached = CacheManager.get('weekOpen');
            if (cached) { this.data.weekOpen = cached; NumberAnimator.animate($('weekOpen'), cached); this.updateRule5(); return; }
            try {
                this.log('Fetching week open');
                const now = new Date(), dow = now.getDay(), diff = dow === 0 ? -6 : 1 - dow;
                const mon = new Date(now); mon.setDate(mon.getDate() + diff); mon.setHours(0,0,0,0);
                const s = Math.floor(mon.getTime() / 1000);
                const data = await this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/QQQ?period1=${s}&period2=${s + 432000}&interval=1d`);
                if (data?.chart?.result?.[0]) {
                    for (const v of data.chart.result[0].indicators.quote[0].open) {
                        if (v !== null) {
                            this.data.weekOpen = v;
                            const sun = new Date(mon); sun.setDate(sun.getDate() + 6); sun.setHours(23,59,59,999);
                            CacheManager.set('weekOpen', v, sun.getTime() - Date.now());
                            NumberAnimator.animate($('weekOpen'), v);
                            this.updateRule5();
                            break;
                        }
                    }
                }
            } catch (e) { this.log(`Week open error: ${e.message}`, 'error'); }
        },

        updateRule5() {
            if (this.data.currentPrice && this.data.weekOpen) {
                const ch = ((this.data.currentPrice - this.data.weekOpen) / this.data.weekOpen) * 100;
                const el = $('rule5');
                el.textContent = `${ch >= 0 ? '+' : ''}${ch.toFixed(2)}%`;
                el.className = ch < 0 ? 'indicator-value negative' : 'indicator-value positive';
            }
        },

        // ---- 5Y high (cached 24h) ----
        async fetch5YearHigh() {
            const cached = CacheManager.get('year5High');
            if (cached) { this.data.year5High = cached; NumberAnimator.animate($('year5High'), cached); this.update5YDiff(); return; }
            try {
                this.log('Fetching 5Y high');
                const end = Math.floor(Date.now() / 1000), start = end - 5 * 365 * 86400;
                const data = await this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/QQQ?period1=${start}&period2=${end}&interval=1wk`);
                if (data?.chart?.result?.[0]) {
                    const highs = data.chart.result[0].indicators.quote[0].high.filter(h => h !== null);
                    this.data.year5High = Math.max(...highs);
                    CacheManager.set('year5High', this.data.year5High, 86400000);
                    NumberAnimator.animate($('year5High'), this.data.year5High);
                    this.update5YDiff();
                }
            } catch (e) { this.log(`5Y high error: ${e.message}`, 'error'); }
        },

        update5YDiff() {
            if (this.data.currentPrice && this.data.year5High) {
                const d = ((this.data.currentPrice - this.data.year5High) / this.data.year5High) * 100;
                const el = $('year5Diff');
                el.textContent = `${d >= 0 ? '+' : ''}${d.toFixed(2)}%`;
                el.className = d < 0 ? 'detail-value negative' : 'detail-value positive';
            }
        },

        // ---- Chart ----
        async fetchChartData() {
            try {
                const periods = { '1d':{interval:'5m',range:'1d'}, '5d':{interval:'30m',range:'5d'}, '1mo':{interval:'1h',range:'1mo'}, '3mo':{interval:'1d',range:'3mo'}, '6mo':{interval:'1d',range:'6mo'}, '1y':{interval:'1wk',range:'1y'} };
                const c = periods[this.chartPeriod];
                const data = await this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/QQQ?range=${c.range}&interval=${c.interval}`);
                if (data?.chart?.result?.[0]) {
                    const r = data.chart.result[0];
                    this.chartData = { labels: r.timestamp.map(t => this.fmtTs(t * 1000, this.chartPeriod)), prices: r.indicators.quote[0].close };
                    this.updateChart();
                }
            } catch (e) { this.log(`Chart error: ${e.message}`, 'error'); }
        },

        fmtTs(ts, p) {
            const d = new Date(ts);
            if (p === '1d') return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            if (p === '5d') return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        },

        // ---- UI Updates ----
        updateUI() {
            if (!this.data.currentPrice) return;
            NumberAnimator.animate($('currentPrice'), this.data.currentPrice, '$');

            const ch = this.data.currentPrice - this.data.previousClose;
            const pct = (ch / this.data.previousClose) * 100;
            $('changeAmount').textContent = `${ch >= 0 ? '+' : ''}${ch.toFixed(2)}`;
            $('changePercent').textContent = `(${ch >= 0 ? '+' : ''}${pct.toFixed(2)}%)`;
            $('changeAmount').className = ch >= 0 ? 'change-amount positive' : 'change-amount negative';
            $('changePercent').className = ch >= 0 ? 'change-percent positive' : 'change-percent negative';

            NumberAnimator.animate($('prevClose'), this.data.previousClose);
            NumberAnimator.animate($('dayHigh'), this.data.dayHigh);
            NumberAnimator.animate($('dayLow'), this.data.dayLow);
            NumberAnimator.animate($('week52High'), this.data.week52High);
            NumberAnimator.animate($('week52Low'), this.data.week52Low);
            $('volume').textContent = this.fmtVol(this.data.volume);

            const l1 = this.data.previousClose * (1 - this.settings.thresholdLevel1 / 100);
            const l2 = this.data.previousClose * (1 - this.settings.thresholdLevel2 / 100);
            NumberAnimator.animate($('level12'), l1);
            NumberAnimator.animate($('level18'), l2);

            $('level18').style.color = this.data.currentPrice <= l2 ? 'var(--red)' : '';
            $('level12').style.color = this.data.currentPrice <= l1 ? 'var(--orange)' : '';

            this.updateMADev();
        },

        updateVIX() {
            if (!this.data.vix) return;
            NumberAnimator.animate($('vixValue'), this.data.vix.value, '', 2);
            const ce = $('vixChange');
            ce.textContent = `${this.data.vix.change >= 0 ? '+' : ''}${this.data.vix.change.toFixed(2)} (${this.data.vix.changePercent >= 0 ? '+' : ''}${this.data.vix.changePercent.toFixed(1)}%)`;
            ce.className = this.data.vix.change >= 0 ? 'vix-change negative' : 'vix-change positive';

            const pct = Math.min((this.data.vix.value / 40) * 100, 100);
            const g = $('vixGauge');
            g.style.width = `${pct}%`;
            g.style.background = this.data.vix.value < 20 ? 'var(--green)' : this.data.vix.value < 30 ? 'var(--yellow)' : 'var(--red)';

            const s = $('vixStatus');
            if (this.data.vix.value < 20) { s.textContent = 'Low Vol'; s.className = 'vix-status vix-low'; }
            else if (this.data.vix.value < 30) { s.textContent = 'Mid Vol'; s.className = 'vix-status vix-medium'; }
            else { s.textContent = 'High Vol'; s.className = 'vix-status vix-high'; }
        },

        updateNQFutures() {
            if (!this.data.nqFutures) return;
            $('futuresPrice').textContent = `$${this.data.nqFutures.price.toFixed(2)}`;
            const ce = $('futuresChange');
            ce.textContent = `${this.data.nqFutures.change >= 0 ? '+' : ''}${this.data.nqFutures.change.toFixed(2)} (${this.data.nqFutures.changePercent >= 0 ? '+' : ''}${this.data.nqFutures.changePercent.toFixed(2)}%)`;
            ce.className = this.data.nqFutures.change >= 0 ? 'futures-change positive' : 'futures-change negative';
        },

        updateUSDJPY() {
            if (!this.data.usdjpy) return;
            $('fxPrice').textContent = `Â¥${this.data.usdjpy.rate.toFixed(2)}`;
            const ce = $('fxChange');
            ce.textContent = `${this.data.usdjpy.change >= 0 ? '+' : ''}${this.data.usdjpy.change.toFixed(2)} (${this.data.usdjpy.changePercent >= 0 ? '+' : ''}${this.data.usdjpy.changePercent.toFixed(2)}%)`;
            ce.className = this.data.usdjpy.change >= 0 ? 'fx-change positive' : 'fx-change negative';
        },

        updateMarketStatus() {
            const now = new Date();
            const ny = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const d = ny.getDay(), h = ny.getHours(), m = ny.getMinutes();
            let st, cl;
            if (d === 0 || d === 6) { st = 'Weekend - Closed'; cl = 'market-closed'; }
            else if (h < 9 || h >= 16 || (h === 9 && m < 30)) { st = 'After Hours'; cl = 'market-closed'; }
            else { st = 'Market Open'; cl = 'market-open'; }
            const el = $('marketStatus');
            el.textContent = `${st} (NY ${ny.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })})`;
            el.className = `market-status ${cl}`;
        },

        // ---- Signal Scoreboard ----
        updateScoreboard() {
            const d = this.data, s = this.settings;
            if (!d.currentPrice) return;

            const signals = [
                { name: 'Below 200MA', on: d.ma200 && d.currentPrice <= d.ma200 },
                { name: `-${s.thresholdLevel1}%`, on: d.previousClose && d.currentPrice <= d.previousClose * (1 - s.thresholdLevel1 / 100) },
                { name: `-${s.thresholdLevel2}%`, on: d.previousClose && d.currentPrice <= d.previousClose * (1 - s.thresholdLevel2 / 100) },
                { name: `-${s.thresholdWeekly}% Week`, on: d.weekOpen && ((d.currentPrice - d.weekOpen) / d.weekOpen * 100) <= -s.thresholdWeekly },
                { name: `VIX>${s.thresholdVixHigh}`, on: d.vix && d.vix.value >= s.thresholdVixHigh },
                { name: `VIX>${s.thresholdVixExtreme}`, on: d.vix && d.vix.value >= s.thresholdVixExtreme }
            ];

            const count = signals.filter(s => s.on).length;
            const total = signals.length;
            const pct = count / total;

            // Ring
            const circ = 2 * Math.PI * 34; // ~213.6
            $('scoreRing').style.strokeDashoffset = circ * (1 - pct);
            $('scoreRing').style.stroke = pct === 0 ? 'var(--text-muted)' : pct < 0.4 ? 'var(--yellow)' : pct < 0.7 ? 'var(--orange)' : 'var(--red)';
            $('scoreNumber').textContent = `${count}/${total}`;

            const descs = ['No signals', 'Monitoring', 'Elevated', 'Alert', 'Strong buy zone', 'Max opportunity'];
            $('scoreDesc').textContent = descs[count] || descs[0];
            $('scoreDesc').style.color = pct >= 0.7 ? 'var(--red)' : pct >= 0.4 ? 'var(--orange)' : pct > 0 ? 'var(--yellow)' : 'var(--text-secondary)';

            // Pills
            $('signalPills').innerHTML = signals.map(s =>
                `<span class="signal-pill ${s.on ? 'signal-on' : 'signal-off'}">${s.on ? 'â—' : 'â—‹'} ${s.name}</span>`
            ).join('');
        },

        // ---- Dynamic mood background ----
        updateMood() {
            const d = this.data;
            let mood = 'calm';

            if (d.vix) {
                const v = d.vix.value;
                if (v >= 35) mood = 'panic';
                else if (v >= 25) mood = 'fear';
                else if (v >= 20) mood = 'cautious';
                else if (v < 15) mood = 'euphoria';
            }

            // Override with price signals
            if (d.currentPrice && d.previousClose) {
                const dayChange = ((d.currentPrice - d.previousClose) / d.previousClose) * 100;
                if (dayChange <= -5) mood = 'panic';
                else if (dayChange <= -3 && mood !== 'panic') mood = 'fear';
                else if (dayChange >= 3 && mood === 'calm') mood = 'euphoria';
            }

            if (mood !== this.currentMood) {
                document.body.className = `mood-${mood}`;
                const ml = $('moodLabel');
                const labels = { euphoria: 'EUPHORIA', calm: 'CALM', cautious: 'CAUTIOUS', fear: 'FEAR', panic: 'PANIC' };
                ml.textContent = labels[mood];
                ml.className = `mood-label mood-label-${mood}`;
                this.currentMood = mood;
                this.log(`Mood changed: ${mood}`);
            }
        },

        // ---- Alerts ----
        checkAlerts() {
            if (!this.data.currentPrice || !this.data.previousClose) return;
            const s = this.settings, d = this.data;
            const l1 = d.previousClose * (1 - s.thresholdLevel1 / 100);
            const l2 = d.previousClose * (1 - s.thresholdLevel2 / 100);

            if (d.currentPrice <= l2 && !this.alertsTriggered.level18) { ToastManager.show(`Below -${s.thresholdLevel2}% level!`, 'error', 10000); this.alertsTriggered.level18 = true; }
            else if (d.currentPrice > l2) this.alertsTriggered.level18 = false;

            if (d.currentPrice <= l1 && !this.alertsTriggered.level12) { ToastManager.show(`Below -${s.thresholdLevel1}% level!`, 'warning', 10000); this.alertsTriggered.level12 = true; }
            else if (d.currentPrice > l1) this.alertsTriggered.level12 = false;

            if (d.ma200 && d.currentPrice <= d.ma200 && !this.alertsTriggered.ma200) { ToastManager.show('Below 200-day MA!', 'warning', 10000); this.alertsTriggered.ma200 = true; }
            else if (d.ma200 && d.currentPrice > d.ma200) this.alertsTriggered.ma200 = false;

            if (d.weekOpen) {
                const wc = ((d.currentPrice - d.weekOpen) / d.weekOpen) * 100;
                if (wc <= -s.thresholdWeekly && !this.alertsTriggered.rule5) { ToastManager.show(`-${s.thresholdWeekly}% Rule triggered!`, 'error', 10000); this.alertsTriggered.rule5 = true; }
                else if (wc > -s.thresholdWeekly) this.alertsTriggered.rule5 = false;
            }

            if (d.vix) {
                if (d.vix.value >= s.thresholdVixExtreme && !this.alertsTriggered.vix35) { ToastManager.show(`VIX above ${s.thresholdVixExtreme} - Extreme fear!`, 'error', 10000); this.alertsTriggered.vix35 = true; }
                else if (d.vix.value < s.thresholdVixExtreme) this.alertsTriggered.vix35 = false;

                if (d.vix.value >= s.thresholdVixHigh && d.vix.value < s.thresholdVixExtreme && !this.alertsTriggered.vix30) { ToastManager.show(`VIX above ${s.thresholdVixHigh} - High volatility`, 'warning', 10000); this.alertsTriggered.vix30 = true; }
                else if (d.vix.value < s.thresholdVixHigh) this.alertsTriggered.vix30 = false;
            }

            if (Object.values(this.alertsTriggered).some(v => v)) {
                if (s.soundEnabled) this.playAlertSound();
                if (s.notificationEnabled && Notification.permission === 'granted') {
                    new Notification('QQQ Pro Tracker Alert', { body: 'Investment threshold alert triggered' });
                }
            }
        },

        playAlertSound() {
            try {
                const c = new (window.AudioContext || window.webkitAudioContext)();
                const o = c.createOscillator(), g = c.createGain();
                o.connect(g); g.connect(c.destination);
                o.frequency.value = 800; g.gain.value = 0.3;
                o.start(); o.stop(c.currentTime + 0.2);
            } catch {}
        },

        // ---- Chart ----
        initChart() {
            this.chart = new Chart($('priceChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'QQQ', data: [], borderColor: '#00d4ff',
                        backgroundColor: (ctx) => {
                            const { ctx: c, chartArea } = ctx.chart;
                            if (!chartArea) return 'rgba(0,212,255,0.05)';
                            const gr = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            gr.addColorStop(0, 'rgba(0,212,255,0.15)'); gr.addColorStop(1, 'rgba(0,212,255,0)');
                            return gr;
                        },
                        fill: true, borderWidth: 2, tension: 0.3, pointRadius: 0,
                        pointHoverRadius: 5, pointHoverBackgroundColor: '#00d4ff',
                        pointHoverBorderColor: '#fff', pointHoverBorderWidth: 2
                    }, {
                        label: '200MA', data: [], borderColor: 'rgba(255,183,64,0.6)',
                        borderWidth: 1.5, borderDash: [6, 4], tension: 0, pointRadius: 0, pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, labels: { color: 'rgba(255,255,255,0.5)', usePointStyle: true, padding: 20, font: { family: 'Inter', size: 12 } } },
                        tooltip: {
                            backgroundColor: 'rgba(10,14,26,0.95)', titleColor: 'rgba(255,255,255,0.7)', bodyColor: '#fff',
                            borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1, padding: 12, cornerRadius: 8,
                            titleFont: { family: 'Inter' }, bodyFont: { family: 'Inter', weight: '600' },
                            callbacks: { label: (c) => `${c.dataset.label}: $${c.parsed.y?.toFixed(2) || '---'}` }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: 'rgba(255,255,255,0.3)', font: { family: 'Inter', size: 11 }, maxRotation: 45, minRotation: 45 } },
                        y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: 'rgba(255,255,255,0.3)', font: { family: 'Inter', size: 11 }, callback: v => '$' + v.toFixed(0) } }
                    }
                }
            });
        },

        updateChart() {
            if (!this.chart || !this.chartData) return;
            this.chart.data.labels = this.chartData.labels;
            this.chart.data.datasets[0].data = this.chartData.prices;
            if (this.data.ma200) this.chart.data.datasets[1].data = new Array(this.chartData.prices.length).fill(this.data.ma200);
            this.chart.update('none');
        },

        fmtVol(v) {
            if (!v) return '---';
            if (v >= 1e9) return (v / 1e9).toFixed(2) + 'B';
            if (v >= 1e6) return (v / 1e6).toFixed(2) + 'M';
            if (v >= 1e3) return (v / 1e3).toFixed(1) + 'K';
            return v.toString();
        },

        // ---- Demo data ----
        useDemoData() {
            this.log('Using demo data');
            this.data = {
                currentPrice: 432.58, previousClose: 435.20,
                dayHigh: 437.85, dayLow: 430.12,
                week52High: 508.59, week52Low: 362.45,
                volume: 45832100, ma200: 445.32, weekOpen: 440.25,
                vix: { value: 18.45, change: 1.23, changePercent: 7.14 },
                nqFutures: { price: 18652.25, change: -125.50, changePercent: -0.67 },
                year5High: 508.59,
                usdjpy: { rate: 149.52, change: -0.38, changePercent: -0.25 }
            };

            this.updateUI(); this.updateVIX(); this.updateNQFutures(); this.updateUSDJPY();
            this.updateMarketStatus(); this.updateLastUpdated();
            NumberAnimator.animate($('ma200'), this.data.ma200);
            NumberAnimator.animate($('weekOpen'), this.data.weekOpen);
            NumberAnimator.animate($('year5High'), this.data.year5High);
            this.updateRule5(); this.update5YDiff(); this.updateScoreboard(); this.updateMood();

            // Demo watchlist data
            const demoStocks = { AAPL:{price:189.45,prevClose:191.20,name:'Apple Inc.'},NVDA:{price:875.30,prevClose:862.10,name:'NVIDIA Corp'},MSFT:{price:415.60,prevClose:418.30,name:'Microsoft Corp'},GOOGL:{price:174.80,prevClose:172.50,name:'Alphabet Inc'},AMZN:{price:198.25,prevClose:195.80,name:'Amazon.com Inc'},META:{price:502.30,prevClose:498.60,name:'Meta Platforms'},TSLA:{price:245.70,prevClose:252.40,name:'Tesla Inc'},AVGO:{price:1685.20,prevClose:1672.50,name:'Broadcom Inc'} };
            this.watchlist.forEach(t => { const s = demoStocks[t]; if (s) { const ch = s.price - s.prevClose; this.watchlistData[t] = { price:s.price, prevClose:s.prevClose, change:ch, changePct:(ch/s.prevClose)*100, currency:'USD', name:s.name, exchange:'NMS' }; } });
            this.renderWatchlist();

            // Demo crypto data
            this.cryptoData = {
                'BTC-USD': { price: 97842.50, prevClose: 96500.00, change: 1342.50, changePct: 1.39, label: 'BTC', name: 'Bitcoin' },
                'ETH-USD': { price: 3285.40, prevClose: 3320.10, change: -34.70, changePct: -1.05, label: 'ETH', name: 'Ethereum' },
                'XRP-USD': { price: 2.48, prevClose: 2.42, change: 0.06, changePct: 2.48, label: 'XRP', name: 'XRP' }
            };
            this.renderCryptoHeatmap();

            // Demo news
            const now = Math.floor(Date.now() / 1000);
            this.newsData = [
                { uuid: '1', title: 'NVIDIA beats earnings expectations as AI demand remains strong', publisher: 'Reuters', providerPublishTime: now - 3600, link: '#', relatedTicker: 'NVDA' },
                { uuid: '2', title: 'QQQ drops as tech selloff intensifies amid rate concerns', publisher: 'Bloomberg', providerPublishTime: now - 7200, link: '#', relatedTicker: 'QQQ' },
                { uuid: '3', title: 'Tesla shares slide after missing quarterly delivery targets', publisher: 'CNBC', providerPublishTime: now - 14400, link: '#', relatedTicker: 'TSLA' },
                { uuid: '4', title: 'Apple announces new AI features for iPhone at developer conference', publisher: 'The Verge', providerPublishTime: now - 28800, link: '#', relatedTicker: 'AAPL' },
                { uuid: '5', title: 'Fed signals potential rate cut in September meeting minutes', publisher: 'WSJ', providerPublishTime: now - 43200, link: '#', relatedTicker: 'QQQ' },
                { uuid: '6', title: 'Microsoft Azure revenue surges 29% driven by AI workloads', publisher: 'CNBC', providerPublishTime: now - 57600, link: '#', relatedTicker: 'MSFT' },
                { uuid: '7', title: 'Broadcom chip demand soars on AI infrastructure buildout', publisher: 'Reuters', providerPublishTime: now - 72000, link: '#', relatedTicker: 'AVGO' }
            ];
            this.renderNews();
            this.buildNewsTabs();
            this.detectMarketAlerts();
            this.updateFearGreed();

            // Demo earnings
            const today = Date.now();
            this.earningsData = [
                { ticker: 'AAPL', name: 'Apple Inc.', date: today + 5 * 86400000, estimate: '2.35' },
                { ticker: 'MSFT', name: 'Microsoft Corp', date: today + 12 * 86400000, estimate: '3.10' },
                { ticker: 'NVDA', name: 'NVIDIA Corp', date: today + 20 * 86400000, estimate: '0.82' },
                { ticker: 'GOOGL', name: 'Alphabet Inc', date: today + 35 * 86400000, estimate: '1.92' },
                { ticker: 'META', name: 'Meta Platforms', date: today + 42 * 86400000, estimate: '5.25' },
                { ticker: 'AMZN', name: 'Amazon.com Inc', date: today + 55 * 86400000, estimate: '1.15' },
                { ticker: 'TSLA', name: 'Tesla Inc', date: today + 68 * 86400000, estimate: '0.73' }
            ];
            this.renderEarningsCalendar();

            // Demo simulator placeholder
            $('simResults').innerHTML = '<div class="news-empty">ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ã¯å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“</div>';

            const labels = [], prices = [];
            let p = 430;
            for (let i = 0; i < 50; i++) {
                labels.push(`${9 + Math.floor(i * 7 / 50)}:${String((i * 7) % 60).padStart(2, '0')}`);
                p += (Math.random() - 0.48) * 2; prices.push(p);
            }
            this.chartData = { labels, prices }; this.updateChart();
            ToastManager.show('Demo mode active', 'info');
        },

        startAutoRefresh() {
            if (this.refreshTimer) clearInterval(this.refreshTimer);
            this.refreshTimer = setInterval(() => { if (!this.settings.demoMode) { this.fetchData(); this.fetchWatchlistData(); this.fetchCryptoData(); this.fetchNews(); } }, this.settings.refreshInterval * 1000);
        },

        openSettings() { $('settingsModal').classList.add('open'); },
        closeSettings() { $('settingsModal').classList.remove('open'); },

        // ---- Watchlist ----
        loadWatchlist() {
            try {
                const saved = localStorage.getItem('qqq_watchlist');
                this.watchlist = saved ? JSON.parse(saved) : [...this.defaultTickers];
            } catch { this.watchlist = [...this.defaultTickers]; }
            // Mag7ã¯å¿…ãšå«ã‚ã‚‹
            this.mag7.forEach(t => { if (!this.watchlist.includes(t)) this.watchlist.unshift(t); });
        },

        saveWatchlist() {
            try { localStorage.setItem('qqq_watchlist', JSON.stringify(this.watchlist)); } catch {}
        },

        async fetchWatchlistData() {
            if (!this.watchlist.length) { this.renderWatchlist(); return; }
            this.log(`Fetching watchlist: ${this.watchlist.join(', ')}`);
            const results = await Promise.allSettled(
                this.watchlist.map(ticker => this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}`))
            );
            results.forEach((r, i) => {
                const ticker = this.watchlist[i];
                if (r.status === 'fulfilled' && r.value?.chart?.result?.[0]) {
                    const m = r.value.chart.result[0].meta;
                    const ch = m.regularMarketPrice - m.previousClose;
                    this.watchlistData[ticker] = {
                        price: m.regularMarketPrice,
                        prevClose: m.previousClose,
                        change: ch,
                        changePct: (ch / m.previousClose) * 100,
                        currency: m.currency || 'USD',
                        name: m.shortName || m.symbol || ticker,
                        exchange: m.exchangeName || ''
                    };
                }
            });
            this.renderWatchlist();
            this.detectMarketAlerts();
        },

        heatmapColor(pct) {
            // Maps change% to color: deep red (-5%+) â†’ red â†’ gray (0%) â†’ green â†’ deep green (+5%+)
            const clamped = Math.max(-5, Math.min(5, pct));
            const t = (clamped + 5) / 10; // 0 to 1
            let r, g, b;
            if (t < 0.5) {
                // Red to dark gray
                const s = t / 0.5;
                r = Math.round(180 + (40 - 180) * s);
                g = Math.round(30 + (40 - 30) * s);
                b = Math.round(30 + (45 - 30) * s);
            } else {
                // Dark gray to green
                const s = (t - 0.5) / 0.5;
                r = Math.round(40 + (15 - 40) * s);
                g = Math.round(40 + (160 - 40) * s);
                b = Math.round(45 + (60 - 45) * s);
            }
            return `rgb(${r},${g},${b})`;
        },

        setWatchlistView(view) {
            this.watchlistView = view;
            document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));
            const grid = $('watchlistGrid');
            grid.classList.toggle('heatmap-view', view === 'heatmap');
            this.renderWatchlist();
        },

        renderWatchlist() {
            const grid = $('watchlistGrid');
            if (!this.watchlist.length) {
                grid.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:16px;text-align:center">No tickers added. Click + Add to start.</div>';
                return;
            }

            // Mag7ã‚’å…ˆé ­å›ºå®šã€ãã‚Œä»¥å¤–ã‚’å¾Œã‚ã«
            const sorted = [...this.mag7.filter(t => this.watchlist.includes(t)), ...this.watchlist.filter(t => !this.mag7.includes(t))];

            const makeCell = (ticker, isHeatmap) => {
                const d = this.watchlistData[ticker];
                const isMag7 = this.mag7.includes(ticker);
                const draggable = !isMag7;
                const dragAttr = draggable ? `draggable="true"` : `draggable="false"`;
                const removeBtn = isMag7
                    ? `<span class="wl-lock" title="Magnificent 7 (å›ºå®š)">ðŸ”’</span>`
                    : `<button class="wl-remove" onclick="event.stopPropagation();app.removeTicker('${ticker}')">&times;</button>`;

                if (isHeatmap) {
                    if (!d) return `<div class="heatmap-cell" data-ticker="${ticker}" ${dragAttr} style="background:rgba(255,255,255,0.05)"><div class="hm-ticker">${ticker}</div><div class="hm-price" style="opacity:0.5">Loading...</div>${removeBtn}</div>`;
                    const sign = d.changePct >= 0 ? '+' : '';
                    const bg = this.heatmapColor(d.changePct);
                    const sym = d.currency === 'JPY' ? 'Â¥' : '$';
                    const dec = d.price > 1000 ? 0 : 2;
                    return `<div class="heatmap-cell" data-ticker="${ticker}" ${dragAttr} style="background:${bg};cursor:pointer" onclick="app.showTickerDetail('${ticker}')">
                        ${removeBtn}
                        <div class="hm-ticker">${ticker}</div>
                        <div class="hm-pct">${sign}${d.changePct.toFixed(2)}%</div>
                        <div class="hm-price">${sym}${d.price.toFixed(dec)}</div>
                    </div>`;
                } else {
                    if (!d) return `<div class="watchlist-item" data-ticker="${ticker}" ${dragAttr}><div class="wl-ticker">${ticker}</div><div class="wl-loading">Loading...</div>${removeBtn}</div>`;
                    const sign = d.change >= 0 ? '+' : '';
                    const cls = d.change >= 0 ? 'positive' : 'negative';
                    const sym = d.currency === 'JPY' ? 'Â¥' : '$';
                    const dec = d.price > 1000 ? 0 : 2;
                    return `<div class="watchlist-item" data-ticker="${ticker}" ${dragAttr} style="cursor:pointer" onclick="app.showTickerDetail('${ticker}')">
                        ${removeBtn}
                        <div class="wl-ticker">${ticker}</div>
                        <div class="wl-name">${d.name}</div>
                        <div class="wl-price">${sym}${d.price.toFixed(dec)}</div>
                        <div class="wl-change ${cls}">${sign}${d.change.toFixed(dec)} (${sign}${d.changePct.toFixed(2)}%)</div>
                    </div>`;
                }
            };

            const isHeatmap = this.watchlistView === 'heatmap';
            grid.innerHTML = sorted.map(t => makeCell(t, isHeatmap)).join('');
            this.setupDragAndDrop(grid);
        },

        async showTickerDetail(ticker) {
            const panel = $('tickerDetail');
            const d = this.watchlistData[ticker] || this.cryptoData[ticker];
            if (!d) return;

            const sym = (d.currency && d.currency === 'JPY') ? 'Â¥' : '$';
            const dec = d.price > 1000 ? 0 : d.price < 1 ? 4 : 2;
            const sign = d.change >= 0 ? '+' : '';
            const cls = d.change >= 0 ? 'positive' : 'negative';

            $('tdTicker').textContent = d.label || ticker;
            $('tdName').textContent = d.name;
            $('tdPrice').textContent = `${sym}${d.price.toFixed(dec)}`;
            const chEl = $('tdChange');
            chEl.textContent = `${sign}${d.change.toFixed(dec)} (${sign}${d.changePct.toFixed(2)}%)`;
            chEl.className = `td-change ${cls}`;

            // Reset perf values to loading
            ['tdPerf1w', 'tdPerf1m', 'tdPerfYtd', 'tdPerf1y'].forEach(id => {
                $(id).innerHTML = '<span class="skeleton skeleton-text" style="width:60px;display:inline-block"></span>';
                $(id).className = 'td-perf-value';
            });

            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // Fetch period data in parallel
            const now = Math.floor(Date.now() / 1000);
            const jan1 = Math.floor(new Date(new Date().getFullYear(), 0, 1).getTime() / 1000);
            const periods = [
                { id: 'tdPerf1w', start: now - 7 * 86400, label: '1w' },
                { id: 'tdPerf1m', start: now - 30 * 86400, label: '1m' },
                { id: 'tdPerfYtd', start: jan1, label: 'ytd' },
                { id: 'tdPerf1y', start: now - 365 * 86400, label: '1y' }
            ];

            const results = await Promise.allSettled(
                periods.map(p => this.fetchWithProxy(
                    `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?period1=${p.start}&period2=${now}&interval=1d`
                ))
            );

            results.forEach((r, i) => {
                const el = $(periods[i].id);
                if (r.status === 'fulfilled' && r.value?.chart?.result?.[0]) {
                    const opens = r.value.chart.result[0].indicators.quote[0].open;
                    const firstOpen = opens.find(v => v !== null);
                    if (firstOpen && d.price) {
                        const pct = ((d.price - firstOpen) / firstOpen) * 100;
                        const s = pct >= 0 ? '+' : '';
                        el.textContent = `${s}${pct.toFixed(2)}%`;
                        el.className = `td-perf-value ${pct >= 0 ? 'positive' : 'negative'}`;
                    } else {
                        el.textContent = '---';
                        el.className = 'td-perf-value neutral';
                    }
                } else {
                    el.textContent = '---';
                    el.className = 'td-perf-value neutral';
                }
            });
        },

        closeTickerDetail() {
            $('tickerDetail').style.display = 'none';
        },

        openAddTicker() { $('addTickerModal').classList.add('open'); $('tickerInput').value = ''; $('tickerError').style.display = 'none'; setTimeout(() => $('tickerInput').focus(), 100); },
        closeAddTicker() { $('addTickerModal').classList.remove('open'); },

        async addTicker() {
            const input = $('tickerInput').value.trim().toUpperCase();
            if (!input) return;
            if (this.watchlist.includes(input)) { $('tickerError').textContent = `${input} is already in watchlist`; $('tickerError').style.display = 'block'; return; }

            $('addTickerConfirm').textContent = 'Checking...'; $('addTickerConfirm').disabled = true;
            try {
                const data = await this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(input)}`);
                if (!data?.chart?.result?.[0]) throw new Error('Not found');
                const m = data.chart.result[0].meta;
                const ch = m.regularMarketPrice - m.previousClose;
                this.watchlistData[input] = {
                    price: m.regularMarketPrice, prevClose: m.previousClose,
                    change: ch, changePct: (ch / m.previousClose) * 100,
                    currency: m.currency || 'USD', name: m.shortName || m.symbol || input,
                    exchange: m.exchangeName || ''
                };
                this.watchlist.push(input);
                this.saveWatchlist();
                this.renderWatchlist();
                this.closeAddTicker();
                ToastManager.show(`${input} added to watchlist`, 'info');
            } catch (e) {
                $('tickerError').textContent = `"${input}" not found. Check the ticker symbol.`;
                $('tickerError').style.display = 'block';
            }
            $('addTickerConfirm').textContent = 'Add to Watchlist'; $('addTickerConfirm').disabled = false;
        },

        // ---- Drag & Drop reorder (non-Mag7 only) ----
        setupDragAndDrop(grid) {
            let dragTicker = null;
            grid.querySelectorAll('[draggable="true"]').forEach(el => {
                el.addEventListener('dragstart', (e) => {
                    dragTicker = el.dataset.ticker;
                    el.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', dragTicker);
                });
                el.addEventListener('dragend', () => {
                    el.classList.remove('dragging');
                    grid.querySelectorAll('.drag-over').forEach(x => x.classList.remove('drag-over'));
                    dragTicker = null;
                });
            });
            grid.querySelectorAll('[data-ticker]').forEach(el => {
                el.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const target = el.dataset.ticker;
                    if (!dragTicker || dragTicker === target || this.mag7.includes(target)) return;
                    e.dataTransfer.dropEffect = 'move';
                    el.classList.add('drag-over');
                });
                el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
                el.addEventListener('drop', (e) => {
                    e.preventDefault();
                    el.classList.remove('drag-over');
                    const target = el.dataset.ticker;
                    if (!dragTicker || dragTicker === target || this.mag7.includes(target)) return;
                    // Mag7ä»¥å¤–ã®éƒ¨åˆ†ã ã‘ä¸¦ã³æ›¿ãˆ
                    const nonMag7 = this.watchlist.filter(t => !this.mag7.includes(t));
                    const fromIdx = nonMag7.indexOf(dragTicker);
                    const toIdx = nonMag7.indexOf(target);
                    if (fromIdx === -1 || toIdx === -1) return;
                    nonMag7.splice(fromIdx, 1);
                    nonMag7.splice(toIdx, 0, dragTicker);
                    this.watchlist = [...this.mag7.filter(t => this.watchlist.includes(t)), ...nonMag7];
                    this.saveWatchlist();
                    this.renderWatchlist();
                });
            });
        },

        removeTicker(ticker) {
            if (this.mag7.includes(ticker)) {
                ToastManager.show(`${ticker} ã¯Magnificent 7ã®ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“`, 'warning');
                return;
            }
            if (!confirm(`${ticker} ã‚’ã‚¦ã‚©ãƒƒãƒãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            this.watchlist = this.watchlist.filter(t => t !== ticker);
            delete this.watchlistData[ticker];
            this.saveWatchlist();
            this.renderWatchlist();
            ToastManager.show(`${ticker} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'info');
        },

        // ---- Crypto ----
        async fetchCryptoData() {
            this.log('Fetching crypto data');
            const results = await Promise.allSettled(
                this.cryptoTickers.map(c => this.fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${c.symbol}`))
            );
            results.forEach((r, i) => {
                const c = this.cryptoTickers[i];
                if (r.status === 'fulfilled' && r.value?.chart?.result?.[0]) {
                    const m = r.value.chart.result[0].meta;
                    const ch = m.regularMarketPrice - m.previousClose;
                    this.cryptoData[c.symbol] = {
                        price: m.regularMarketPrice,
                        prevClose: m.previousClose,
                        change: ch,
                        changePct: (ch / m.previousClose) * 100,
                        label: c.label,
                        name: c.name
                    };
                }
            });
            this.renderCryptoHeatmap();
        },

        renderCryptoHeatmap() {
            const grid = $('cryptoGrid');
            grid.innerHTML = this.cryptoTickers.map(c => {
                const d = this.cryptoData[c.symbol];
                if (!d) return `<div class="heatmap-cell" style="background:rgba(255,255,255,0.05)"><div class="hm-ticker">${c.label}</div><div class="hm-price" style="opacity:0.5">Loading...</div></div>`;
                const sign = d.changePct >= 0 ? '+' : '';
                const bg = this.heatmapColor(d.changePct);
                const priceStr = d.price >= 1000 ? '$' + d.price.toLocaleString('en-US', { maximumFractionDigits: 0 }) : d.price >= 1 ? '$' + d.price.toFixed(2) : '$' + d.price.toFixed(4);
                return `<div class="heatmap-cell" style="background:${bg};cursor:pointer" onclick="app.showTickerDetail('${c.symbol}')">
                    <div class="hm-ticker">${c.label}</div>
                    <div class="hm-pct">${sign}${d.changePct.toFixed(2)}%</div>
                    <div class="hm-price">${priceStr}</div>
                </div>`;
            }).join('');
        },

        // ---- Generic JSON fetch (for non-chart endpoints like news) ----
        async fetchJSONWithProxy(url) {
            if (this.isHosted) {
                try {
                    const res = await fetch(`/api/proxy?url=${encodeURIComponent(url)}`);
                    if (res.ok) return await res.json();
                } catch (e) { this.log(`JSON proxy failed: ${e.message}`, 'warn'); }
            }
            try {
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (res.ok) return await res.json();
            } catch {}
            for (const proxy of this.corsProxies) {
                try {
                    const res = await fetch(proxy + encodeURIComponent(url));
                    if (res.ok) return await res.json();
                } catch {}
            }
            return null;
        },

        // ---- News ----
        async fetchNews() {
            this.log('Fetching market news');
            try {
                const tickers = ['QQQ', ...this.watchlist.slice(0, 6)];
                const uniqueTickers = [...new Set(tickers)];
                const results = await Promise.allSettled(
                    uniqueTickers.map(t =>
                        this.fetchJSONWithProxy(`https://query2.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(t)}&newsCount=5&quotesCount=0`)
                    )
                );
                const allNews = [];
                const seen = new Set();
                results.forEach((r, i) => {
                    if (r.status === 'fulfilled' && r.value?.news) {
                        r.value.news.forEach(item => {
                            if (!seen.has(item.uuid)) {
                                seen.add(item.uuid);
                                allNews.push({ ...item, relatedTicker: uniqueTickers[i] });
                            }
                        });
                    }
                });
                allNews.sort((a, b) => (b.providerPublishTime || 0) - (a.providerPublishTime || 0));
                this.newsData = allNews.slice(0, 25);
                this.renderNews();
                this.buildNewsTabs();
            } catch (e) {
                this.log(`News fetch error: ${e.message}`, 'error');
            }
        },

        buildNewsTabs() {
            const tabs = $('newsTabs');
            if (!tabs) return;
            const tickers = new Set(['all', 'QQQ']);
            this.newsData.forEach(n => { if (n.relatedTicker) tickers.add(n.relatedTicker); });
            tabs.innerHTML = [...tickers].map(t =>
                `<button class="news-tab ${t === this.newsFilter ? 'active' : ''}" data-ticker="${t}" onclick="app.filterNews('${t}')">${t === 'all' ? 'All' : t}</button>`
            ).join('');
        },

        filterNews(ticker) {
            this.newsFilter = ticker;
            document.querySelectorAll('.news-tab').forEach(b => b.classList.toggle('active', b.dataset.ticker === ticker));
            this.renderNews();
        },

        renderNews() {
            const container = $('newsContainer');
            if (!container) return;
            const filtered = this.newsFilter === 'all'
                ? this.newsData
                : this.newsData.filter(n => n.relatedTicker === this.newsFilter);
            if (!filtered.length) {
                container.innerHTML = '<div class="news-empty">No news available</div>';
                return;
            }
            container.innerHTML = filtered.slice(0, 10).map(item => {
                const timeAgo = this.formatTimeAgo(item.providerPublishTime);
                const publisher = item.publisher || '';
                const icon = this.getNewsIcon(item.title || '');
                const ticker = item.relatedTicker || '';
                const link = item.link || '#';
                return `<a class="news-item" href="${link}" target="_blank" rel="noopener">
                    <div class="news-icon">${icon}</div>
                    <div class="news-content">
                        <div class="news-title">${this.escapeHTML(item.title || 'No title')}</div>
                        <div class="news-meta">
                            ${ticker ? `<span class="news-ticker-badge">${ticker}</span>` : ''}
                            <span>${this.escapeHTML(publisher)}</span>
                            <span>${timeAgo}</span>
                        </div>
                    </div>
                </a>`;
            }).join('');
        },

        getNewsIcon(title) {
            const t = title.toLowerCase();
            if (t.includes('earning') || t.includes('revenue') || t.includes('profit') || t.includes('quarter')) return 'ðŸ“Š';
            if (t.includes('ai') || t.includes('artificial intelligence') || t.includes('chip') || t.includes('gpu')) return 'ðŸ¤–';
            if (t.includes('crash') || t.includes('plunge') || t.includes('sell-off') || t.includes('bear') || t.includes('drop') || t.includes('decline') || t.includes('slide') || t.includes('tumble')) return 'ðŸ“‰';
            if (t.includes('surge') || t.includes('rally') || t.includes('bull') || t.includes('jump') || t.includes('soar') || t.includes('record')) return 'ðŸ“ˆ';
            if (t.includes('fed') || t.includes('rate') || t.includes('inflation') || t.includes('central bank') || t.includes('powell')) return 'ðŸ¦';
            if (t.includes('tariff') || t.includes('trade') || t.includes('china') || t.includes('geopolit')) return 'ðŸŒ';
            if (t.includes('tesla') || t.includes('ev') || t.includes('electric vehicle')) return 'ðŸš—';
            return 'ðŸ“°';
        },

        formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const diff = Math.floor(Date.now() / 1000) - timestamp;
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
            return new Date(timestamp * 1000).toLocaleDateString();
        },

        escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        },

        // ---- Market Spike Alerts ----
        detectMarketAlerts() {
            const alerts = [];
            const d = this.data;

            // QQQ daily change
            if (d.currentPrice && d.previousClose) {
                const pct = ((d.currentPrice - d.previousClose) / d.previousClose) * 100;
                if (pct <= -3) alerts.push({ ticker: 'QQQ', type: 'bearish', msg: `QQQ ${pct.toFixed(1)}% æ€¥è½` });
                else if (pct <= -2) alerts.push({ ticker: 'QQQ', type: 'bearish', msg: `QQQ ${pct.toFixed(1)}% ä¸‹è½` });
                else if (pct >= 3) alerts.push({ ticker: 'QQQ', type: 'bullish', msg: `QQQ +${pct.toFixed(1)}% æ€¥é¨°` });
                else if (pct >= 2) alerts.push({ ticker: 'QQQ', type: 'bullish', msg: `QQQ +${pct.toFixed(1)}% ä¸Šæ˜‡` });
            }

            // VIX
            if (d.vix) {
                if (d.vix.value >= 30) alerts.push({ ticker: 'VIX', type: 'bearish', msg: `VIX ${d.vix.value.toFixed(1)} ææ€–æŒ‡æ•°è­¦æˆ’` });
                else if (d.vix.changePercent >= 15) alerts.push({ ticker: 'VIX', type: 'warning', msg: `VIX +${d.vix.changePercent.toFixed(1)}% æ€¥é¨°` });
                else if (d.vix.changePercent >= 10) alerts.push({ ticker: 'VIX', type: 'warning', msg: `VIX +${d.vix.changePercent.toFixed(1)}% ä¸Šæ˜‡ä¸­` });
            }

            // Watchlist stocks (Â±5% threshold)
            Object.entries(this.watchlistData).forEach(([ticker, data]) => {
                if (data.changePct <= -5) alerts.push({ ticker, type: 'bearish', msg: `${ticker} ${data.changePct.toFixed(1)}% æ€¥è½` });
                else if (data.changePct >= 5) alerts.push({ ticker, type: 'bullish', msg: `${ticker} +${data.changePct.toFixed(1)}% æ€¥é¨°` });
            });

            // NQ Futures
            if (d.nqFutures && Math.abs(d.nqFutures.changePercent) >= 1.5) {
                const pct = d.nqFutures.changePercent;
                alerts.push({ ticker: 'NQ', type: pct < 0 ? 'bearish' : 'bullish', msg: `å…ˆç‰© ${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%` });
            }

            this.spikeAlerts = alerts;
            this.renderMarketAlerts();
        },

        renderMarketAlerts() {
            const banner = $('marketAlertBanner');
            if (!banner) return;
            if (!this.spikeAlerts.length) { banner.style.display = 'none'; return; }

            const hasBearish = this.spikeAlerts.some(a => a.type === 'bearish');
            const hasBullish = this.spikeAlerts.some(a => a.type === 'bullish');
            const mixed = hasBearish && hasBullish;

            banner.className = `market-alert-banner ${mixed ? 'alert-mixed' : ''}`;
            banner.style.display = 'block';

            const headerIcon = hasBearish ? 'ðŸš¨' : 'ðŸ””';
            const headerText = hasBearish ? 'MARKET ALERT' : 'MARKET ACTIVITY';

            banner.innerHTML = `
                <div class="alert-header">${headerIcon} ${headerText}</div>
                <div class="alert-items">
                    ${this.spikeAlerts.map(a => `<span class="alert-chip ${a.type}">${a.msg}</span>`).join('')}
                </div>
            `;
        },

        // ---- Fear & Greed ----
        updateFearGreed() {
            const d = this.data;
            if (!d.currentPrice || !d.previousClose) return;

            // VIX score (0-100): low VIX = greed, high VIX = fear
            const vixScore = d.vix ? Math.max(0, Math.min(100, 100 - ((d.vix.value - 12) / 28) * 100)) : 50;

            // Momentum score: daily change mapped -3% to +3% â†’ 0-100
            const dailyPct = ((d.currentPrice - d.previousClose) / d.previousClose) * 100;
            const momentumScore = Math.max(0, Math.min(100, (dailyPct + 3) / 6 * 100));

            // 200MA trend: deviation mapped -10% to +10% â†’ 0-100
            let maScore = 50;
            if (d.ma200) {
                const maDev = ((d.currentPrice - d.ma200) / d.ma200) * 100;
                maScore = Math.max(0, Math.min(100, (maDev + 10) / 20 * 100));
            }

            // Market breadth: % of watchlist stocks positive
            const wlEntries = Object.values(this.watchlistData);
            const breadthScore = wlEntries.length > 0
                ? (wlEntries.filter(w => w.changePct > 0).length / wlEntries.length) * 100 : 50;

            const weights = { vix: 0.35, momentum: 0.25, ma: 0.25, breadth: 0.15 };
            const score = Math.round(
                vixScore * weights.vix + momentumScore * weights.momentum +
                maScore * weights.ma + breadthScore * weights.breadth
            );
            this.fearGreedScore = score;

            // Update gauge
            const needle = $('fgNeedle');
            if (needle) needle.setAttribute('transform', `rotate(${score * 1.8 - 90},100,100)`);

            const scoreEl = $('fgScore');
            const labelEl = $('fgLabel');
            if (scoreEl) scoreEl.textContent = score;

            let label, color;
            if (score <= 20) { label = 'EXTREME FEAR'; color = 'var(--red)'; }
            else if (score <= 40) { label = 'FEAR'; color = 'var(--orange)'; }
            else if (score <= 60) { label = 'NEUTRAL'; color = 'var(--yellow)'; }
            else if (score <= 80) { label = 'GREED'; color = 'var(--green)'; }
            else { label = 'EXTREME GREED'; color = '#00ffaa'; }

            if (scoreEl) scoreEl.style.color = color;
            if (labelEl) { labelEl.textContent = label; labelEl.style.color = color; }

            // Detail bars
            const details = $('fgDetails');
            if (details) {
                const items = [
                    { name: 'VIX', val: Math.round(vixScore), color: this.fgBarColor(vixScore) },
                    { name: 'Momentum', val: Math.round(momentumScore), color: this.fgBarColor(momentumScore) },
                    { name: '200MA Trend', val: Math.round(maScore), color: this.fgBarColor(maScore) },
                    { name: 'Breadth', val: Math.round(breadthScore), color: this.fgBarColor(breadthScore) }
                ];
                details.innerHTML = items.map(i => `
                    <div class="fg-detail">
                        <div class="fg-detail-top"><span class="fg-detail-name">${i.name}</span><span class="fg-detail-val" style="color:${i.color}">${i.val}</span></div>
                        <div class="fg-detail-bar"><div class="fg-detail-fill" style="width:${i.val}%;background:${i.color}"></div></div>
                    </div>
                `).join('');
            }
        },

        fgBarColor(val) {
            if (val <= 25) return 'var(--red)';
            if (val <= 45) return 'var(--orange)';
            if (val <= 55) return 'var(--yellow)';
            if (val <= 75) return 'var(--green)';
            return '#00ffaa';
        },

        // ---- DCA Simulator ----
        async fetchSimulatorData() {
            this.log('Fetching simulator data');
            const end = Math.floor(Date.now() / 1000);
            const start = end - 5 * 365 * 86400;
            const etfs = ['QQQ', 'QLD', 'TQQQ'];
            const results = await Promise.allSettled(
                etfs.map(t => this.fetchWithProxy(
                    `https://query1.finance.yahoo.com/v8/finance/chart/${t}?period1=${start}&period2=${end}&interval=1mo`
                ))
            );
            results.forEach((r, i) => {
                if (r.status === 'fulfilled' && r.value?.chart?.result?.[0]) {
                    const res = r.value.chart.result[0];
                    const timestamps = res.timestamp || [];
                    const closes = res.indicators.quote[0].close || [];
                    this.simData[etfs[i]] = timestamps.map((t, j) => ({
                        date: t, price: closes[j]
                    })).filter(p => p.price !== null);
                }
            });
            this.renderSimulator();
        },

        setSimPeriod(years) {
            this.simPeriod = years;
            document.querySelectorAll('.sim-period-tab').forEach(b =>
                b.classList.toggle('active', parseInt(b.dataset.period) === years)
            );
            this.renderSimulator();
        },

        renderSimulator() {
            const container = $('simResults');
            if (!container) return;
            const amount = parseInt($('simAmount')?.value) || 100000;
            const rate = this.data.usdjpy?.rate || 150;
            const months = this.simPeriod * 12;
            const etfs = [
                { sym: 'QQQ', name: 'NASDAQ 100', leverage: '1x' },
                { sym: 'QLD', name: 'Ultra QQQ', leverage: '2x' },
                { sym: 'TQQQ', name: 'UltraPro QQQ', leverage: '3x' }
            ];

            const rows = etfs.map(etf => {
                const data = this.simData[etf.sym];
                if (!data || data.length < 2) return null;

                const recent = data.slice(-months - 1);
                if (recent.length < 2) return null;

                // é¨°è½çŽ‡ (price return)
                const startPrice = recent[0].price;
                const endPrice = recent[recent.length - 1].price;
                const priceReturn = ((endPrice - startPrice) / startPrice) * 100;

                // DCA calculation
                const monthlyUsd = amount / rate;
                let totalShares = 0;
                let totalInvested = 0;
                for (let i = 0; i < recent.length - 1; i++) {
                    totalShares += monthlyUsd / recent[i].price;
                    totalInvested += amount;
                }
                const currentValue = totalShares * endPrice * rate;
                const dcaReturn = ((currentValue - totalInvested) / totalInvested) * 100;
                const profit = currentValue - totalInvested;

                return { ...etf, priceReturn, totalInvested, currentValue, dcaReturn, profit };
            }).filter(Boolean);

            if (!rows.length) {
                container.innerHTML = '<div class="news-empty">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>';
                return;
            }

            const fmtJPY = (v) => 'Â¥' + Math.round(v).toLocaleString();
            const fmtPct = (v) => `<span style="color:${v >= 0 ? 'var(--green)' : 'var(--red)'}">${v >= 0 ? '+' : ''}${v.toFixed(1)}%</span>`;

            container.innerHTML = `
                <table class="sim-table">
                    <thead><tr><th>ETF</th><th>é¨°è½çŽ‡</th><th>æŠ•è³‡é¡</th><th>è©•ä¾¡é¡</th><th>æç›Š</th><th>ãƒªã‚¿ãƒ¼ãƒ³</th></tr></thead>
                    <tbody>${rows.map(r => `
                        <tr>
                            <td><span class="sim-etf">${r.sym}</span><br><span class="sim-etf-sub">${r.name} (${r.leverage})</span></td>
                            <td>${fmtPct(r.priceReturn)}</td>
                            <td>${fmtJPY(r.totalInvested)}</td>
                            <td style="font-weight:600">${fmtJPY(r.currentValue)}</td>
                            <td style="color:${r.profit >= 0 ? 'var(--green)' : 'var(--red)'}; font-weight:600">${r.profit >= 0 ? '+' : ''}${fmtJPY(r.profit)}</td>
                            <td>${fmtPct(r.dcaReturn)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            `;
        },

        // ---- Earnings Calendar ----
        async fetchEarningsCalendar() {
            this.log('Fetching earnings calendar');
            const tickers = [...this.mag7, ...this.watchlist.filter(t => !this.mag7.includes(t))];
            const unique = [...new Set(tickers)].slice(0, 15);
            const results = await Promise.allSettled(
                unique.map(t =>
                    this.fetchJSONWithProxy(`https://query2.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(t)}?modules=calendarEvents`)
                )
            );
            this.earningsData = [];
            results.forEach((r, i) => {
                if (r.status === 'fulfilled' && r.value?.quoteSummary?.result?.[0]?.calendarEvents?.earnings) {
                    const e = r.value.quoteSummary.result[0].calendarEvents.earnings;
                    const dates = e.earningsDate;
                    if (dates && dates.length > 0) {
                        this.earningsData.push({
                            ticker: unique[i],
                            name: this.watchlistData[unique[i]]?.name || unique[i],
                            date: dates[0].raw * 1000,
                            estimate: e.earningsAverage?.fmt || null,
                            low: e.earningsLow?.fmt || null,
                            high: e.earningsHigh?.fmt || null
                        });
                    }
                }
            });
            this.earningsData.sort((a, b) => a.date - b.date);
            this.renderEarningsCalendar();
        },

        renderEarningsCalendar() {
            const container = $('earningsCalendar');
            if (!container) return;
            if (!this.earningsData.length) {
                container.innerHTML = '<div class="news-empty">æ±ºç®—æ—¥æƒ…å ±ãªã—</div>';
                return;
            }
            const now = Date.now();
            container.innerHTML = this.earningsData.map(e => {
                const d = new Date(e.date);
                const month = d.toLocaleString('en', { month: 'short' });
                const day = d.getDate();
                const diffDays = Math.ceil((e.date - now) / 86400000);
                let countdownClass = '', countdownText = '';
                if (diffDays < 0) { countdownText = `${Math.abs(diffDays)}æ—¥å‰`; countdownClass = ''; }
                else if (diffDays === 0) { countdownText = 'TODAY'; countdownClass = 'earnings-today'; }
                else if (diffDays <= 7) { countdownText = `${diffDays}æ—¥å¾Œ`; countdownClass = 'earnings-soon'; }
                else { countdownText = `${diffDays}æ—¥å¾Œ`; countdownClass = ''; }
                const estStr = e.estimate ? `EPSäºˆæƒ³: $${e.estimate}` : '';

                return `<div class="earnings-item">
                    <div class="earnings-badge">
                        <div class="earnings-badge-month">${month}</div>
                        <div class="earnings-badge-day">${day}</div>
                    </div>
                    <div class="earnings-info">
                        <div class="earnings-ticker">${e.ticker}</div>
                        <div class="earnings-name">${this.escapeHTML(e.name)}</div>
                        ${estStr ? `<div class="earnings-est">${estStr}</div>` : ''}
                    </div>
                    <div class="earnings-countdown ${countdownClass}">
                        <div class="earnings-days">${countdownText}</div>
                    </div>
                </div>`;
            }).join('');
        },

        // ---- Section toggle ----
        toggleSection(id) {
            const body = $(id);
            if (!body) return;
            body.classList.toggle('hidden');
            const header = body.previousElementSibling || body.parentElement.querySelector('.section-toggle');
            if (header) header.classList.toggle('collapsed', body.classList.contains('hidden'));
        },

        log(msg, type = 'info') {
            const m = `[${new Date().toLocaleTimeString('en-US')}] ${msg}`;
            console.log(m);
            if (this.settings.debugMode) {
                const e = document.createElement('div');
                e.style.color = type === 'error' ? 'var(--red)' : type === 'warn' ? 'var(--yellow)' : 'var(--green)';
                e.textContent = m; $('debugPanel').appendChild(e); $('debugPanel').scrollTop = 1e6;
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
    window.addEventListener('click', (e) => { if (e.target === $('settingsModal')) app.closeSettings(); });
    </script>
</body>
</html>
