<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QQQ Pro Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
            padding-bottom: 20px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: #111;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #00d4ff;
        }

        .settings-btn {
            background: none;
            border: 1px solid #444;
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: #222;
            border-color: #00d4ff;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒ¼ */
        .alert-bar {
            background: #ff4757;
            color: #fff;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            padding: 20px;
        }

        /* ä¾¡æ ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .price-section {
            background: #111;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #222;
        }

        .price-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .current-price {
            font-size: 48px;
            font-weight: 700;
            color: #fff;
        }

        .price-change {
            text-align: right;
        }

        .change-amount {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .change-percent {
            font-size: 20px;
            font-weight: 500;
        }

        .positive { color: #00ff88; }
        .negative { color: #ff4757; }

        .price-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .detail-item {
            background: #1a1a1a;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .detail-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        /* æŠ•è³‡æŒ‡æ¨™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .indicators-section {
            background: #111;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #222;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #00d4ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .indicator-grid {
            display: grid;
            gap: 15px;
        }

        .indicator-item {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicator-label {
            font-size: 14px;
            color: #aaa;
        }

        .indicator-value {
            font-size: 20px;
            font-weight: 600;
        }

        .ma-200 { border-left: 4px solid #ffc107; }
        .level-12 { border-left: 4px solid #ff9f1a; }
        .level-18 { border-left: 4px solid #ff4757; }

        /* é–¢é€£æŒ‡æ¨™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .related-section {
            background: #111;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #222;
        }

        .vix-container, .futures-container {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #333;
            margin-bottom: 15px;
        }

        .vix-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .vix-status {
            font-size: 14px;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 500;
        }

        .vix-low { background: #00ff88; color: #000; }
        .vix-medium { background: #ffc107; color: #000; }
        .vix-high { background: #ff4757; color: #fff; }

        /* ãƒãƒ£ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .chart-section {
            background: #111;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #222;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .chart-toggle {
            font-size: 24px;
            transition: transform 0.3s;
        }

        .chart-toggle.open {
            transform: rotate(180deg);
        }

        .chart-container {
            height: 300px;
            display: none;
        }

        .chart-container.show {
            display: block;
        }

        .time-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .time-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-btn:hover {
            background: #222;
            border-color: #00d4ff;
        }

        .time-btn.active {
            background: #00d4ff;
            color: #000;
            border-color: #00d4ff;
        }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal-content {
            background: #111;
            border-radius: 15px;
            padding: 30px;
            margin: 50px auto;
            max-width: 400px;
            width: 90%;
            border: 1px solid #333;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #00d4ff;
        }

        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
        }

        .setting-item {
            margin-bottom: 25px;
        }

        .setting-label {
            display: block;
            margin-bottom: 10px;
            color: #aaa;
            font-size: 14px;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .setting-control input[type="range"] {
            flex: 1;
        }

        .setting-control input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .setting-value {
            font-size: 16px;
            font-weight: 600;
            color: #00d4ff;
            min-width: 50px;
        }

        /* ãƒãƒ¼ã‚±ãƒƒãƒˆçŠ¶æ…‹ */
        .market-status {
            text-align: center;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .market-open { color: #00ff88; }
        .market-closed { color: #ff4757; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }

        /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
        .error {
            background: #ff4757;
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
        }

        /* ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ */
        .debug-panel {
            display: none;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #0f0;
            max-height: 300px;
            overflow-y: auto;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 375px) {
            .current-price { font-size: 40px; }
            .change-amount { font-size: 20px; }
            .change-percent { font-size: 18px; }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <h1>QQQ Pro Tracker</h1>
        <button class="settings-btn" onclick="app.openSettings()">è¨­å®š</button>
    </div>

    <!-- ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒ¼ -->
    <div class="alert-bar" id="alertBar"></div>

    <!-- ãƒãƒ¼ã‚±ãƒƒãƒˆçŠ¶æ…‹ -->
    <div class="market-status" id="marketStatus">ãƒãƒ¼ã‚±ãƒƒãƒˆçŠ¶æ…‹ã‚’ç¢ºèªä¸­...</div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <!-- ä¾¡æ ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="price-section">
            <div class="price-main">
                <div class="current-price" id="currentPrice">---</div>
                <div class="price-change">
                    <div class="change-amount" id="changeAmount">---</div>
                    <div class="change-percent" id="changePercent">---</div>
                </div>
            </div>
            
            <div class="price-details">
                <div class="detail-item">
                    <div class="detail-label">å‰æ—¥çµ‚å€¤</div>
                    <div class="detail-value" id="prevClose">---</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">å‡ºæ¥é«˜</div>
                    <div class="detail-value" id="volume">---</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">æ—¥ä¸­é«˜å€¤</div>
                    <div class="detail-value" id="dayHigh">---</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">æ—¥ä¸­å®‰å€¤</div>
                    <div class="detail-value" id="dayLow">---</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">52é€±é«˜å€¤</div>
                    <div class="detail-value" id="week52High">---</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">52é€±å®‰å€¤</div>
                    <div class="detail-value" id="week52Low">---</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">5å¹´æœ€é«˜å€¤</div>
                    <div class="detail-value" id="year5High">---</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">5å¹´é«˜å€¤å·®</div>
                    <div class="detail-value" id="year5Diff">---</div>
                </div>
            </div>
        </div>

        <!-- æŠ•è³‡æŒ‡æ¨™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="indicators-section">
            <h2 class="section-title">
                <span>ğŸ“Š</span>
                <span>æŠ•è³‡æŒ‡æ¨™</span>
            </h2>
            <div class="indicator-grid">
                <div class="indicator-item ma-200">
                    <span class="indicator-label">200æ—¥ç§»å‹•å¹³å‡</span>
                    <span class="indicator-value" id="ma200">---</span>
                </div>
                <div class="indicator-item level-12">
                    <span class="indicator-label">-12%æ°´æº–</span>
                    <span class="indicator-value" id="level12">---</span>
                </div>
                <div class="indicator-item level-18">
                    <span class="indicator-label">-18%æ°´æº–</span>
                    <span class="indicator-value" id="level18">---</span>
                </div>
                <div class="indicator-item">
                    <span class="indicator-label">é€±å§‹å€¤</span>
                    <span class="indicator-value" id="weekOpen">---</span>
                </div>
                <div class="indicator-item">
                    <span class="indicator-label">-5%ãƒ«ãƒ¼ãƒ«</span>
                    <span class="indicator-value" id="rule5">---</span>
                </div>
            </div>
        </div>

        <!-- é–¢é€£æŒ‡æ¨™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="related-section">
            <h2 class="section-title">
                <span>ğŸŒ¡ï¸</span>
                <span>é–¢é€£æŒ‡æ¨™</span>
            </h2>
            
            <div class="vix-container">
                <div class="detail-label">VIXï¼ˆææ€–æŒ‡æ•°ï¼‰</div>
                <div class="vix-value" id="vixValue">---</div>
                <span class="vix-status" id="vixStatus">---</span>
            </div>

            <div class="futures-container">
                <div class="detail-label">NQå…ˆç‰©</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <span style="font-size: 24px; font-weight: 600;" id="futuresPrice">---</span>
                    <span style="font-size: 18px;" id="futuresChange">---</span>
                </div>
            </div>
        </div>

        <!-- ãƒãƒ£ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="chart-section">
            <div class="chart-header" onclick="app.toggleChart()">
                <h2 class="section-title" style="margin-bottom: 0;">
                    <span>ğŸ“ˆ</span>
                    <span>ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆ</span>
                </h2>
                <span class="chart-toggle" id="chartToggle">â–¼</span>
            </div>
            
            <div class="chart-container" id="chartContainer">
                <div class="time-selector" id="timeSelector">
                    <button class="time-btn active" data-period="1d">1æ—¥</button>
                    <button class="time-btn" data-period="5d">5æ—¥</button>
                    <button class="time-btn" data-period="1mo">1ãƒ¶æœˆ</button>
                    <button class="time-btn" data-period="3mo">3ãƒ¶æœˆ</button>
                    <button class="time-btn" data-period="6mo">6ãƒ¶æœˆ</button>
                    <button class="time-btn" data-period="1y">1å¹´</button>
                </div>
                <canvas id="priceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div class="debug-panel" id="debugPanel"></div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è¨­å®š</h2>
                <button class="close-btn" onclick="app.closeSettings()">Ã—</button>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">æ›´æ–°é–“éš”</label>
                <div class="setting-control">
                    <input type="range" id="refreshInterval" min="5" max="60" value="15" step="5">
                    <span class="setting-value" id="refreshValue">15ç§’</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">éŸ³å£°ã‚¢ãƒ©ãƒ¼ãƒˆ</label>
                <div class="setting-control">
                    <input type="checkbox" id="soundEnabled" checked>
                    <span>æœ‰åŠ¹</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥</label>
                <div class="setting-control">
                    <input type="checkbox" id="notificationEnabled">
                    <span>æœ‰åŠ¹</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰</label>
                <div class="setting-control">
                    <input type="checkbox" id="debugMode">
                    <span>æœ‰åŠ¹</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</label>
                <div class="setting-control">
                    <input type="checkbox" id="demoMode">
                    <span>æœ‰åŠ¹ï¼ˆAPIã‚¨ãƒ©ãƒ¼æ™‚è‡ªå‹•åˆ‡æ›¿ï¼‰</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // QQQ Pro Tracker Application
        const app = {
            // è¨­å®šï¼ˆãƒ¡ãƒ¢ãƒªå†…ã§ç®¡ç†ï¼‰
            settings: {
                refreshInterval: 15,
                soundEnabled: true,
                notificationEnabled: false,
                debugMode: false,
                demoMode: false
            },

            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨
            data: {
                currentPrice: null,
                previousPrice: null,
                previousClose: null,
                dayHigh: null,
                dayLow: null,
                week52High: null,
                week52Low: null,
                volume: null,
                ma200: null,
                weekOpen: null,
                vix: null,
                nqFutures: null,
                chartData: null,
                year5High: null
            },

            // ã‚¢ãƒ©ãƒ¼ãƒˆç™ºå‹•æ¸ˆã¿ãƒ•ãƒ©ã‚°
            alertsTriggered: {
                level12: false,
                level18: false,
                ma200: false,
                rule5: false,
                vix30: false,
                vix35: false
            },

            // ãƒãƒ£ãƒ¼ãƒˆé–¢é€£
            chart: null,
            chartPeriod: '1d',

            // ã‚¿ã‚¤ãƒãƒ¼
            refreshTimer: null,

            // CORSãƒ—ãƒ­ã‚­ã‚·ãƒªã‚¹ãƒˆ
            corsProxies: [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://proxy.cors.sh/',
                'https://thingproxy.freeboard.io/fetch/'
            ],
            currentProxyIndex: 0,

            // åˆæœŸåŒ–
            init() {
                this.log('QQQ Pro Tracker åˆæœŸåŒ–é–‹å§‹');
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                this.setupEventListeners();
                
                // é€šçŸ¥æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                
                // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
                this.fetchData();
                
                // è‡ªå‹•æ›´æ–°é–‹å§‹
                this.startAutoRefresh();
                
                // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
                this.initChart();
                
                this.log('åˆæœŸåŒ–å®Œäº†');
            },

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners() {
                // æ›´æ–°é–“éš”ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
                document.getElementById('refreshInterval').addEventListener('input', (e) => {
                    this.settings.refreshInterval = parseInt(e.target.value);
                    document.getElementById('refreshValue').textContent = `${e.target.value}ç§’`;
                    this.startAutoRefresh(); // å†èµ·å‹•
                });

                // éŸ³å£°ã‚¢ãƒ©ãƒ¼ãƒˆ
                document.getElementById('soundEnabled').addEventListener('change', (e) => {
                    this.settings.soundEnabled = e.target.checked;
                });

                // é€šçŸ¥
                document.getElementById('notificationEnabled').addEventListener('change', (e) => {
                    this.settings.notificationEnabled = e.target.checked;
                    if (e.target.checked && Notification.permission === 'default') {
                        Notification.requestPermission();
                    }
                });

                // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
                document.getElementById('debugMode').addEventListener('change', (e) => {
                    this.settings.debugMode = e.target.checked;
                    document.getElementById('debugPanel').style.display = e.target.checked ? 'block' : 'none';
                });

                // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰
                document.getElementById('demoMode').addEventListener('change', (e) => {
                    this.settings.demoMode = e.target.checked;
                    if (e.target.checked) {
                        this.useDemoData();
                    } else {
                        this.fetchData();
                    }
                });

                // ãƒãƒ£ãƒ¼ãƒˆæœŸé–“é¸æŠ
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.chartPeriod = e.target.dataset.period;
                        this.fetchChartData();
                    });
                });
            },

            // ãƒ‡ãƒ¼ã‚¿å–å¾—
            async fetchData() {
                this.log('ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
                
                try {
                    // QQQãƒ‡ãƒ¼ã‚¿å–å¾—
                    const qqqData = await this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/QQQ');
                    
                    if (qqqData && qqqData.chart && qqqData.chart.result && qqqData.chart.result[0]) {
                        const result = qqqData.chart.result[0];
                        const quote = result.indicators.quote[0];
                        const meta = result.meta;
                        
                        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                        this.data.currentPrice = meta.regularMarketPrice;
                        this.data.previousClose = meta.previousClose;
                        this.data.dayHigh = meta.regularMarketDayHigh;
                        this.data.dayLow = meta.regularMarketDayLow;
                        this.data.volume = quote.volume[quote.volume.length - 1];
                        
                        // 52é€±é«˜å€¤ãƒ»å®‰å€¤
                        this.data.week52High = meta.fiftyTwoWeekHigh;
                        this.data.week52Low = meta.fiftyTwoWeekLow;
                        
                        // UIæ›´æ–°
                        this.updateUI();
                        
                        // 200MAè¨ˆç®—
                        await this.calculate200MA();
                        
                        // VIXãƒ‡ãƒ¼ã‚¿å–å¾—
                        await this.fetchVIX();
                        
                        // NQå…ˆç‰©ãƒ‡ãƒ¼ã‚¿å–å¾—
                        await this.fetchNQFutures();
                        
                        // é€±å§‹å€¤å–å¾—
                        await this.fetchWeekOpen();
                        
                        // 5å¹´æœ€é«˜å€¤å–å¾—
                        await this.fetch5YearHigh();
                        
                        // ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
                        this.checkAlerts();
                        
                        // ãƒãƒ¼ã‚±ãƒƒãƒˆçŠ¶æ…‹æ›´æ–°
                        this.updateMarketStatus();
                        
                    } else {
                        throw new Error('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™');
                    }
                    
                } catch (error) {
                    this.log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    
                    // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã«è‡ªå‹•åˆ‡æ›¿
                    if (!this.settings.demoMode) {
                        this.log('ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™');
                        this.settings.demoMode = true;
                        document.getElementById('demoMode').checked = true;
                        this.useDemoData();
                    }
                }
            },

            // CORSãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
            async fetchWithProxy(url) {
                const maxRetries = this.corsProxies.length;
                let retries = 0;
                
                while (retries < maxRetries) {
                    const proxy = this.corsProxies[this.currentProxyIndex];
                    const proxyUrl = proxy + encodeURIComponent(url);
                    
                    try {
                        this.log(`ãƒ—ãƒ­ã‚­ã‚·ä½¿ç”¨: ${proxy}`);
                        const response = await fetch(proxyUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        return data;
                        
                    } catch (error) {
                        this.log(`ãƒ—ãƒ­ã‚­ã‚· ${proxy} ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                        
                        // æ¬¡ã®ãƒ—ãƒ­ã‚­ã‚·ã«åˆ‡ã‚Šæ›¿ãˆ
                        this.currentProxyIndex = (this.currentProxyIndex + 1) % this.corsProxies.length;
                        retries++;
                    }
                }
                
                throw new Error('ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚­ã‚·ã§å¤±æ•—ã—ã¾ã—ãŸ');
            },

            // 200MAè¨ˆç®—
            async calculate200MA() {
                try {
                    this.log('200MAè¨ˆç®—é–‹å§‹');
                    
                    // éå»200å–¶æ¥­æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const endDate = Math.floor(Date.now() / 1000);
                    const startDate = endDate - (300 * 24 * 60 * 60); // 300æ—¥å‰ï¼ˆä½™è£•ã‚’æŒã£ã¦ï¼‰
                    
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/QQQ?period1=${startDate}&period2=${endDate}&interval=1d`;
                    const data = await this.fetchWithProxy(url);
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const closes = data.chart.result[0].indicators.quote[0].close;
                        
                        // nullå€¤ã‚’é™¤å¤–ã—ã€æœ€æ–°200å€‹ã‚’å–å¾—
                        const validCloses = closes.filter(c => c !== null);
                        const last200 = validCloses.slice(-200);
                        
                        if (last200.length >= 200) {
                            const sum = last200.reduce((a, b) => a + b, 0);
                            this.data.ma200 = sum / 200;
                            
                            document.getElementById('ma200').textContent = `$${this.data.ma200.toFixed(2)}`;
                            this.log(`200MAè¨ˆç®—å®Œäº†: $${this.data.ma200.toFixed(2)}`);
                        } else {
                            this.log(`ãƒ‡ãƒ¼ã‚¿ä¸è¶³: ${last200.length}æ—¥åˆ†ã®ã¿`, 'warn');
                        }
                    }
                    
                } catch (error) {
                    this.log(`200MAè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            },

            // VIXãƒ‡ãƒ¼ã‚¿å–å¾—
            async fetchVIX() {
                try {
                    this.log('VIXãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
                    
                    const data = await this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/^VIX');
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const meta = data.chart.result[0].meta;
                        this.data.vix = {
                            value: meta.regularMarketPrice,
                            change: meta.regularMarketPrice - meta.previousClose,
                            changePercent: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100
                        };
                        
                        // VIXè¡¨ç¤ºæ›´æ–°
                        this.updateVIX();
                        
                    }
                } catch (error) {
                    this.log(`VIXãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            },

            // NQå…ˆç‰©ãƒ‡ãƒ¼ã‚¿å–å¾—
            async fetchNQFutures() {
                try {
                    this.log('NQå…ˆç‰©ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
                    
                    const data = await this.fetchWithProxy('https://query1.finance.yahoo.com/v8/finance/chart/NQ=F');
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const meta = data.chart.result[0].meta;
                        this.data.nqFutures = {
                            price: meta.regularMarketPrice,
                            change: meta.regularMarketPrice - meta.previousClose,
                            changePercent: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100
                        };
                        
                        // NQå…ˆç‰©è¡¨ç¤ºæ›´æ–°
                        this.updateNQFutures();
                        
                    }
                } catch (error) {
                    this.log(`NQå…ˆç‰©ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            },

            // é€±å§‹å€¤å–å¾—
            async fetchWeekOpen() {
                try {
                    this.log('é€±å§‹å€¤å–å¾—é–‹å§‹');
                    
                    // ç¾åœ¨ã®æ—¥ä»˜ã‹ã‚‰ä»Šé€±ã®æœˆæ›œæ—¥ã‚’è¨ˆç®—
                    const now = new Date();
                    const dayOfWeek = now.getDay();
                    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // æ—¥æ›œæ—¥ã®å ´åˆã¯å‰é€±ã®æœˆæ›œæ—¥
                    const monday = new Date(now);
                    monday.setDate(monday.getDate() + diff);
                    monday.setHours(0, 0, 0, 0);
                    
                    const startTime = Math.floor(monday.getTime() / 1000);
                    const endTime = startTime + (5 * 24 * 60 * 60); // é‡‘æ›œæ—¥ã¾ã§
                    
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/QQQ?period1=${startTime}&period2=${endTime}&interval=1d`;
                    const data = await this.fetchWithProxy(url);
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const opens = data.chart.result[0].indicators.quote[0].open;
                        
                        // æœ€åˆã®æœ‰åŠ¹ãªå§‹å€¤ã‚’é€±å§‹å€¤ã¨ã™ã‚‹
                        for (let i = 0; i < opens.length; i++) {
                            if (opens[i] !== null) {
                                this.data.weekOpen = opens[i];
                                document.getElementById('weekOpen').textContent = `$${this.data.weekOpen.toFixed(2)}`;
                                
                                // -5%ãƒ«ãƒ¼ãƒ«è¨ˆç®—
                                if (this.data.currentPrice && this.data.weekOpen) {
                                    const weekChange = ((this.data.currentPrice - this.data.weekOpen) / this.data.weekOpen) * 100;
                                    const rule5Element = document.getElementById('rule5');
                                    rule5Element.textContent = `${weekChange >= 0 ? '+' : ''}${weekChange.toFixed(2)}%`;
                                    rule5Element.className = weekChange < 0 ? 'indicator-value negative' : 'indicator-value positive';
                                }
                                
                                break;
                            }
                        }
                    }
                    
                } catch (error) {
                    this.log(`é€±å§‹å€¤å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            },

            // 5å¹´æœ€é«˜å€¤å–å¾—
            async fetch5YearHigh() {
                try {
                    this.log('5å¹´æœ€é«˜å€¤å–å¾—é–‹å§‹');
                    
                    const endDate = Math.floor(Date.now() / 1000);
                    const startDate = endDate - (5 * 365 * 24 * 60 * 60); // 5å¹´å‰
                    
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/QQQ?period1=${startDate}&period2=${endDate}&interval=1wk`;
                    const data = await this.fetchWithProxy(url);
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const highs = data.chart.result[0].indicators.quote[0].high;
                        
                        // nullå€¤ã‚’é™¤å¤–ã—ã¦æœ€é«˜å€¤ã‚’å–å¾—
                        const validHighs = highs.filter(h => h !== null);
                        this.data.year5High = Math.max(...validHighs);
                        
                        document.getElementById('year5High').textContent = `$${this.data.year5High.toFixed(2)}`;
                        
                        // ç¾åœ¨ä¾¡æ ¼ã¨ã®å·®ã‚’è¨ˆç®—
                        if (this.data.currentPrice) {
                            const diff = ((this.data.currentPrice - this.data.year5High) / this.data.year5High) * 100;
                            const diffElement = document.getElementById('year5Diff');
                            diffElement.textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(2)}%`;
                            diffElement.className = diff < 0 ? 'detail-value negative' : 'detail-value positive';
                        }
                    }
                    
                } catch (error) {
                    this.log(`5å¹´æœ€é«˜å€¤å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            },

            // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—
            async fetchChartData() {
                try {
                    this.log(`ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹: ${this.chartPeriod}`);
                    
                    const periods = {
                        '1d': { interval: '5m', range: '1d' },
                        '5d': { interval: '30m', range: '5d' },
                        '1mo': { interval: '1h', range: '1mo' },
                        '3mo': { interval: '1d', range: '3mo' },
                        '6mo': { interval: '1d', range: '6mo' },
                        '1y': { interval: '1wk', range: '1y' }
                    };
                    
                    const config = periods[this.chartPeriod];
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/QQQ?range=${config.range}&interval=${config.interval}`;
                    
                    const data = await this.fetchWithProxy(url);
                    
                    if (data && data.chart && data.chart.result && data.chart.result[0]) {
                        const result = data.chart.result[0];
                        const timestamps = result.timestamp;
                        const closes = result.indicators.quote[0].close;
                        
                        // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢
                        this.chartData = {
                            labels: timestamps.map(t => this.formatTimestamp(t * 1000, this.chartPeriod)),
                            prices: closes
                        };
                        
                        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
                        this.updateChart();
                    }
                    
                } catch (error) {
                    this.log(`ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            },

            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            formatTimestamp(timestamp, period) {
                const date = new Date(timestamp);
                
                switch (period) {
                    case '1d':
                        return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    case '5d':
                        return date.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    default:
                        return date.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
                }
            },

            // UIæ›´æ–°
            updateUI() {
                if (!this.data.currentPrice) return;
                
                // ç¾åœ¨ä¾¡æ ¼
                document.getElementById('currentPrice').textContent = `$${this.data.currentPrice.toFixed(2)}`;
                
                // å¤‰å‹•é¡ãƒ»ç‡
                const change = this.data.currentPrice - this.data.previousClose;
                const changePercent = (change / this.data.previousClose) * 100;
                
                const changeAmountEl = document.getElementById('changeAmount');
                const changePercentEl = document.getElementById('changePercent');
                
                changeAmountEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}`;
                changePercentEl.textContent = `(${change >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
                
                changeAmountEl.className = change >= 0 ? 'change-amount positive' : 'change-amount negative';
                changePercentEl.className = change >= 0 ? 'change-percent positive' : 'change-percent negative';
                
                // ãã®ä»–ã®ä¾¡æ ¼æƒ…å ±
                document.getElementById('prevClose').textContent = `$${this.data.previousClose.toFixed(2)}`;
                document.getElementById('dayHigh').textContent = `$${this.data.dayHigh.toFixed(2)}`;
                document.getElementById('dayLow').textContent = `$${this.data.dayLow.toFixed(2)}`;
                document.getElementById('week52High').textContent = `$${this.data.week52High.toFixed(2)}`;
                document.getElementById('week52Low').textContent = `$${this.data.week52Low.toFixed(2)}`;
                
                // å‡ºæ¥é«˜
                document.getElementById('volume').textContent = this.formatVolume(this.data.volume);
                
                // -12%ã€-18%æ°´æº–
                const level12 = this.data.previousClose * 0.88;
                const level18 = this.data.previousClose * 0.82;
                
                document.getElementById('level12').textContent = `$${level12.toFixed(2)}`;
                document.getElementById('level18').textContent = `$${level18.toFixed(2)}`;
                
                // æ°´æº–ã®è‰²å¤‰æ›´
                if (this.data.currentPrice <= level18) {
                    document.getElementById('level18').style.color = '#ff4757';
                } else if (this.data.currentPrice <= level12) {
                    document.getElementById('level12').style.color = '#ff9f1a';
                }
            },

            // VIXè¡¨ç¤ºæ›´æ–°
            updateVIX() {
                if (!this.data.vix) return;
                
                const vixValueEl = document.getElementById('vixValue');
                const vixStatusEl = document.getElementById('vixStatus');
                
                vixValueEl.textContent = this.data.vix.value.toFixed(2);
                
                // å¤‰å‹•è¡¨ç¤º
                const changeText = `${this.data.vix.change >= 0 ? '+' : ''}${this.data.vix.change.toFixed(2)} (${this.data.vix.changePercent >= 0 ? '+' : ''}${this.data.vix.changePercent.toFixed(2)}%)`;
                vixValueEl.innerHTML = `${this.data.vix.value.toFixed(2)}<br><span style="font-size: 16px; color: ${this.data.vix.change >= 0 ? '#ff4757' : '#00ff88'}">${changeText}</span>`;
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
                let status, statusClass;
                if (this.data.vix.value < 20) {
                    status = 'ä½ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£';
                    statusClass = 'vix-low';
                } else if (this.data.vix.value < 30) {
                    status = 'ä¸­ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£';
                    statusClass = 'vix-medium';
                } else {
                    status = 'é«˜ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£';
                    statusClass = 'vix-high';
                }
                
                vixStatusEl.textContent = status;
                vixStatusEl.className = `vix-status ${statusClass}`;
            },

            // NQå…ˆç‰©è¡¨ç¤ºæ›´æ–°
            updateNQFutures() {
                if (!this.data.nqFutures) return;
                
                document.getElementById('futuresPrice').textContent = `$${this.data.nqFutures.price.toFixed(2)}`;
                
                const changeEl = document.getElementById('futuresChange');
                const changeText = `${this.data.nqFutures.change >= 0 ? '+' : ''}${this.data.nqFutures.change.toFixed(2)} (${this.data.nqFutures.changePercent >= 0 ? '+' : ''}${this.data.nqFutures.changePercent.toFixed(2)}%)`;
                
                changeEl.textContent = changeText;
                changeEl.className = this.data.nqFutures.change >= 0 ? 'positive' : 'negative';
            },

            // ãƒãƒ¼ã‚±ãƒƒãƒˆçŠ¶æ…‹æ›´æ–°
            updateMarketStatus() {
                const now = new Date();
                const nyTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
                const day = nyTime.getDay();
                const hour = nyTime.getHours();
                const minute = nyTime.getMinutes();
                
                let status, statusClass;
                
                // é€±æœ«ãƒã‚§ãƒƒã‚¯
                if (day === 0 || day === 6) {
                    status = 'é€±æœ«ï¼ˆãƒãƒ¼ã‚±ãƒƒãƒˆä¼‘å ´ï¼‰';
                    statusClass = 'market-closed';
                } else if (hour < 9 || hour >= 16 || (hour === 9 && minute < 30)) {
                    status = 'ãƒãƒ¼ã‚±ãƒƒãƒˆæ™‚é–“å¤–';
                    statusClass = 'market-closed';
                } else {
                    status = 'ãƒãƒ¼ã‚±ãƒƒãƒˆé–‹å ´ä¸­';
                    statusClass = 'market-open';
                }
                
                const statusEl = document.getElementById('marketStatus');
                statusEl.textContent = status + ` (NYæ™‚é–“: ${nyTime.toLocaleTimeString('ja-JP')})`;
                statusEl.className = `market-status ${statusClass}`;
            },

            // ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
            checkAlerts() {
                if (!this.data.currentPrice || !this.data.previousClose) return;
                
                const alerts = [];
                
                // -12%æ°´æº–ãƒã‚§ãƒƒã‚¯
                const level12 = this.data.previousClose * 0.88;
                if (this.data.currentPrice <= level12 && !this.alertsTriggered.level12) {
                    alerts.push('ğŸš¨ -12%æ°´æº–ã‚’ä¸‹å›ã‚Šã¾ã—ãŸï¼');
                    this.alertsTriggered.level12 = true;
                } else if (this.data.currentPrice > level12) {
                    this.alertsTriggered.level12 = false;
                }
                
                // -18%æ°´æº–ãƒã‚§ãƒƒã‚¯
                const level18 = this.data.previousClose * 0.82;
                if (this.data.currentPrice <= level18 && !this.alertsTriggered.level18) {
                    alerts.push('ğŸš¨ -18%æ°´æº–ã‚’ä¸‹å›ã‚Šã¾ã—ãŸï¼');
                    this.alertsTriggered.level18 = true;
                } else if (this.data.currentPrice > level18) {
                    this.alertsTriggered.level18 = false;
                }
                
                // 200MAãƒã‚§ãƒƒã‚¯
                if (this.data.ma200 && this.data.currentPrice <= this.data.ma200 && !this.alertsTriggered.ma200) {
                    alerts.push('ğŸ“Š 200æ—¥ç§»å‹•å¹³å‡ã‚’ä¸‹å›ã‚Šã¾ã—ãŸï¼');
                    this.alertsTriggered.ma200 = true;
                } else if (this.data.ma200 && this.data.currentPrice > this.data.ma200) {
                    this.alertsTriggered.ma200 = false;
                }
                
                // -5%ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
                if (this.data.weekOpen) {
                    const weekChange = ((this.data.currentPrice - this.data.weekOpen) / this.data.weekOpen) * 100;
                    if (weekChange <= -5 && !this.alertsTriggered.rule5) {
                        alerts.push('ğŸ“‰ -5%ãƒ«ãƒ¼ãƒ«ç™ºå‹•ï¼ï¼ˆé€±å§‹å€¤ã‹ã‚‰-5%ä»¥ä¸Šã®ä¸‹è½ï¼‰');
                        this.alertsTriggered.rule5 = true;
                    } else if (weekChange > -5) {
                        this.alertsTriggered.rule5 = false;
                    }
                }
                
                // VIXãƒã‚§ãƒƒã‚¯
                if (this.data.vix) {
                    if (this.data.vix.value >= 35 && !this.alertsTriggered.vix35) {
                        alerts.push('ğŸŒ¡ï¸ VIX 35è¶…ãˆï¼ï¼ˆæ¥µåº¦ã®ææ€–ï¼‰');
                        this.alertsTriggered.vix35 = true;
                    } else if (this.data.vix.value < 35) {
                        this.alertsTriggered.vix35 = false;
                    }
                    
                    if (this.data.vix.value >= 30 && this.data.vix.value < 35 && !this.alertsTriggered.vix30) {
                        alerts.push('ğŸŒ¡ï¸ VIX 30è¶…ãˆï¼ï¼ˆé«˜ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼‰');
                        this.alertsTriggered.vix30 = true;
                    } else if (this.data.vix.value < 30) {
                        this.alertsTriggered.vix30 = false;
                    }
                }
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
                if (alerts.length > 0) {
                    this.showAlert(alerts.join(' '));
                }
            },

            // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
            showAlert(message) {
                // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¢ãƒ©ãƒ¼ãƒˆ
                const alertBar = document.getElementById('alertBar');
                alertBar.textContent = message;
                alertBar.style.display = 'block';
                
                // éŸ³å£°ã‚¢ãƒ©ãƒ¼ãƒˆ
                if (this.settings.soundEnabled) {
                    this.playAlertSound();
                }
                
                // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥
                if (this.settings.notificationEnabled && Notification.permission === 'granted') {
                    new Notification('QQQ Pro Tracker ã‚¢ãƒ©ãƒ¼ãƒˆ', {
                        body: message,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTYiIGZpbGw9IiMwMEQ0RkYiLz4KPHBhdGggZD0iTTMyIDQ4QzQwLjgzNjYgNDggNDggNDAuODM2NiA0OCAzMkM0OCAyMy4xNjM0IDQwLjgzNjYgMTYgMzIgMTZDMjMuMTYzNCAxNiAxNiAyMy4xNjM0IDE2IDMyQzE2IDQwLjgzNjYgMjMuMTYzNCA0OCAzMiA0OFoiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPgo8L3N2Zz4='
                    });
                }
                
                // 10ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
                setTimeout(() => {
                    alertBar.style.display = 'none';
                }, 10000);
            },

            // ã‚¢ãƒ©ãƒ¼ãƒˆéŸ³å†ç”Ÿ
            playAlertSound() {
                // AudioContextã‚’ä½¿ç”¨ã—ã¦ãƒ“ãƒ¼ãƒ—éŸ³ã‚’ç”Ÿæˆ
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800; // å‘¨æ³¢æ•°
                gainNode.gain.value = 0.3; // éŸ³é‡
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2); // 0.2ç§’é–“å†ç”Ÿ
            },

            // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
            initChart() {
                const ctx = document.getElementById('priceChart').getContext('2d');
                
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'QQQä¾¡æ ¼',
                                data: [],
                                borderColor: '#00d4ff',
                                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.1,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            },
                            {
                                label: '200MA',
                                data: [],
                                borderColor: '#ffc107',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                tension: 0,
                                pointRadius: 0,
                                pointHoverRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#fff',
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#333',
                                borderWidth: 1,
                                padding: 10,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#888',
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#888',
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                });
            },

            // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
            updateChart() {
                if (!this.chart || !this.chartData) return;
                
                this.chart.data.labels = this.chartData.labels;
                this.chart.data.datasets[0].data = this.chartData.prices;
                
                // 200MAãƒ©ã‚¤ãƒ³
                if (this.data.ma200) {
                    this.chart.data.datasets[1].data = new Array(this.chartData.prices.length).fill(this.data.ma200);
                }
                
                this.chart.update();
            },

            // ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºåˆ‡æ›¿
            toggleChart() {
                const container = document.getElementById('chartContainer');
                const toggle = document.getElementById('chartToggle');
                
                if (container.classList.contains('show')) {
                    container.classList.remove('show');
                    toggle.classList.remove('open');
                } else {
                    container.classList.add('show');
                    toggle.classList.add('open');
                    
                    // åˆå›è¡¨ç¤ºæ™‚ã«ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—
                    if (!this.chartData) {
                        this.fetchChartData();
                    }
                }
            },

            // å‡ºæ¥é«˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            formatVolume(volume) {
                if (!volume) return '---';
                
                if (volume >= 1e9) {
                    return (volume / 1e9).toFixed(2) + 'B';
                } else if (volume >= 1e6) {
                    return (volume / 1e6).toFixed(2) + 'M';
                } else if (volume >= 1e3) {
                    return (volume / 1e3).toFixed(2) + 'K';
                }
                
                return volume.toString();
            },

            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨
            useDemoData() {
                this.log('ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
                
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¨­å®š
                this.data = {
                    currentPrice: 432.58,
                    previousPrice: 435.20,
                    previousClose: 435.20,
                    dayHigh: 437.85,
                    dayLow: 430.12,
                    week52High: 508.59,
                    week52Low: 362.45,
                    volume: 45832100,
                    ma200: 445.32,
                    weekOpen: 440.25,
                    vix: {
                        value: 18.45,
                        change: 1.23,
                        changePercent: 7.14
                    },
                    nqFutures: {
                        price: 18652.25,
                        change: -125.50,
                        changePercent: -0.67
                    },
                    year5High: 508.59
                };
                
                // UIæ›´æ–°
                this.updateUI();
                this.updateVIX();
                this.updateNQFutures();
                this.updateMarketStatus();
                
                // ãƒ‡ãƒ¢ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
                const labels = [];
                const prices = [];
                for (let i = 0; i < 50; i++) {
                    labels.push(`${i}:00`);
                    prices.push(430 + Math.random() * 10);
                }
                
                this.chartData = { labels, prices };
                this.updateChart();
            },

            // è‡ªå‹•æ›´æ–°é–‹å§‹
            startAutoRefresh() {
                // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
                if (this.refreshTimer) {
                    clearInterval(this.refreshTimer);
                }
                
                // æ–°ã—ã„ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
                this.refreshTimer = setInterval(() => {
                    this.fetchData();
                }, this.settings.refreshInterval * 1000);
                
                this.log(`è‡ªå‹•æ›´æ–°é–‹å§‹: ${this.settings.refreshInterval}ç§’é–“éš”`);
            },

            // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
            openSettings() {
                document.getElementById('settingsModal').style.display = 'block';
                
                // ç¾åœ¨ã®è¨­å®šã‚’åæ˜ 
                document.getElementById('refreshInterval').value = this.settings.refreshInterval;
                document.getElementById('refreshValue').textContent = `${this.settings.refreshInterval}ç§’`;
                document.getElementById('soundEnabled').checked = this.settings.soundEnabled;
                document.getElementById('notificationEnabled').checked = this.settings.notificationEnabled;
                document.getElementById('debugMode').checked = this.settings.debugMode;
                document.getElementById('demoMode').checked = this.settings.demoMode;
            },

            // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
            closeSettings() {
                document.getElementById('settingsModal').style.display = 'none';
            },

            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ja-JP');
                const logMessage = `[${timestamp}] ${message}`;
                
                console.log(logMessage);
                
                if (this.settings.debugMode) {
                    const debugPanel = document.getElementById('debugPanel');
                    const logEntry = document.createElement('div');
                    logEntry.style.color = type === 'error' ? '#ff4757' : (type === 'warn' ? '#ffc107' : '#0f0');
                    logEntry.textContent = logMessage;
                    debugPanel.appendChild(logEntry);
                    debugPanel.scrollTop = debugPanel.scrollHeight;
                }
            }
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = (event) => {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                app.closeSettings();
            }
        };
    </script>
</body>
</html>
